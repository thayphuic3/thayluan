<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆∞·ªùng ƒë·∫øn ng√¥i vua - Game Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #FFB6C1 50%, #FFDAB9 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 182, 193, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 235, 59, 0.12) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .sidebar {
            width: 100px;
            background: linear-gradient(180deg, #FFD700 0%, #FFC107 50%, #FF9800 100%);
            border-radius: 25px;
            padding: 25px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            box-shadow: 
                0 15px 50px rgba(255, 215, 0, 0.6),
                inset 0 2px 10px rgba(255, 255, 255, 0.5);
            margin-right: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FFD700, #FFEB3B, #FFC107, #FFD700);
            border-radius: 27px;
            z-index: -1;
            opacity: 0.6;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            animation: logoGlow 3s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            0% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 215, 0, 0.4); }
            100% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 0 30px rgba(255, 215, 0, 0.7); }
        }

        .nav-icon {
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 26px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 18px;
            position: relative;
            overflow: hidden;
        }

        .nav-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .nav-icon:hover::before {
            left: 100%;
        }

        .nav-icon:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
        }

        .nav-icon.active {
            background: white !important;
            color: #FF6F00 !important;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 10px 30px rgba(255, 215, 0, 0.6),
                inset 0 2px 5px rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .nav-icon.active:hover {
            background: white !important;
            color: #FF6F00 !important;
            transform: translateY(-2px) scale(1.05);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
        }

        .main-content::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 30px;
            z-index: -1;
            backdrop-filter: blur(5px);
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            padding: 35px;
            border-radius: 30px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 157, 0.1), transparent);
            animation: headerShine 4s ease-in-out infinite;
        }

        @keyframes headerShine {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .greeting h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #FFD700 0%, #FF9800 50%, #FF6B9D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }

        .greeting p {
            color: #FF6F00;
            font-size: 1.1rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }


        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: none;
            background: #f7fafc;
            border-radius: 15px;
            font-size: 0.95rem;
            outline: none;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: #e2e8f0;
        }

        .icon-btn .badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 18px;
            height: 18px;
            background: #FF6B9D;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .panel-collapsible { position: relative; }
        .panel-content {
            position: absolute; right:0; top:52px; width:360px; max-width:88vw;
            background:#fff; border-radius:16px; padding:16px; box-shadow:0 14px 34px rgba(0,0,0,0.2);
            display:none;
        }
        .panel-content.open { display:block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 25px;
            max-width: calc(100% - 50px);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            border-radius: 30px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(255, 182, 193, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-info h3 {
            background: linear-gradient(135deg, #FF9800 0%, #FF6B9D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA726 50%, #FF6B9D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: numberPulse 2s ease-in-out infinite alternate;
        }

        @keyframes numberPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .stat-unit {
            font-size: 1.2rem;
            color: #a0aec0;
            font-weight: 600;
            margin-left: 5px;
        }

        .stat-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
        }

        .stat-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: iconRotate 3s linear infinite;
        }

        @keyframes iconRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .temp-icon { 
            background: linear-gradient(135deg, #FFD700, #FFA726);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }
        .humidity-icon { 
            background: linear-gradient(135deg, #FF6B9D, #FFB6C1);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5);
        }
        .light-icon { 
            background: linear-gradient(135deg, #FFEB3B, #FFC107);
            box-shadow: 0 8px 25px rgba(255, 235, 59, 0.5);
        }

        .devices-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            padding: 35px;
            border-radius: 30px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .devices-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 182, 193, 0.03) 0%, transparent 50%);
            pointer-events: none;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .device-card {
            background: #f7fafc;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .device-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border-radius: 15px;
            background: white;
        }

        .device-name {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #cbd5e0;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            margin: 0 auto;
        }

        .toggle-switch.active {
            background: #FFA726;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        .right-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .members-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            padding: 30px;
            border-radius: 30px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            width: 500px;
            max-width: 100%;
        }

        .members-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 182, 193, 0.03) 0%, transparent 50%);
            pointer-events: none;
        }

        .members-card h3 {
            background: linear-gradient(135deg, #FFD700 0%, #FF9800 50%, #FF6B9D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            font-size: 1.3rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .members-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .member {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.6) 100%);
            border-radius: 18px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .member::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .member:hover::before {
            left: 100%;
        }

        .member:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 182, 193, 0.15) 100%);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .member-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA726 50%, #FF6B9D 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            font-weight: 800;
            flex-shrink: 0;
            position: relative;
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.5),
                inset 0 2px 8px rgba(255, 255, 255, 0.4);
            animation: avatarPulse 2s ease-in-out infinite alternate;
        }

        @keyframes avatarPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .member-avatar::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #FFD700, #FFEB3B, #FF9800, #FFD700);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.4;
            animation: avatarGlow 3s ease-in-out infinite alternate;
        }

        @keyframes avatarGlow {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.1); }
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 1.1rem;
            background: linear-gradient(135deg, #42A5F5 0%, #FF7043 50%, #FFA726 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            margin-bottom: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-level {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-rank-icon {
            font-size: 1.5rem;
        }

        .my-devices-card {
            background: white;
            padding: 25px;
            border-radius: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            flex: 1;
            width: 100%;
        }

        .my-devices-card h3 {
            background: linear-gradient(135deg, #FFD700 0%, #FF9800 50%, #FF6B9D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .my-devices-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .my-device-card {
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .my-device-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .my-device-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .my-device-icon {
            font-size: 1.5rem;
            color: #FFA726;
        }

        .my-device-name {
            color: #4a5568;
            font-weight: 600;
            font-size: 1rem;
        }

        .my-device-stats {
            font-size: 0.85rem;
            color: #666;
        }

        .slider-container {
            margin-top: 20px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFA726;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #42A5F5, #FF7043);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #42A5F5, #FF7043);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .student-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            border-radius: 20px;
            padding: 12px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: visible;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.05), rgba(102, 126, 234, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .student-card:hover::before {
            opacity: 1;
        }

        /* Hi·ªáu ·ª©ng khi hover ·ªü ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu */
        .student-card[style*="cursor: pointer"]:hover,
        .student-card-compact[style*="cursor: pointer"]:hover {
            border: 2px solid #42A5F5;
            box-shadow: 
                0 25px 60px rgba(66, 165, 245, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .group-card-fixed[style*="cursor: pointer"]:hover {
            border: 2px solid #42A5F5;
            box-shadow: 0 8px 25px rgba(66, 165, 245, 0.3);
            transform: translateY(-3px);
        }

        .student-name {
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #42A5F5 0%, #FF7043 50%, #FFA726 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .character-level {
            text-align: center;
            margin-bottom: 6px;
        }

        .character-image {
            width: 95px;
            height: 95px;
            background: linear-gradient(135deg, #FFCA28 0%, #FFE082 50%, #FFA726 100%);
            border-radius: 50%;
            margin: 0 auto 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            font-weight: bold;
            position: relative;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.5);
            animation: characterFloat 3s ease-in-out infinite alternate;
            border: 4px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
            padding-top: 8px;
        }
        
        .character-image img {
            width: 82px !important;
            height: 82px !important;
            filter: drop-shadow(0 8px 15px rgba(0, 0, 0, 0.3)) contrast(1.15) brightness(1.05);
            position: relative;
            z-index: 3;
            object-fit: cover;
            object-position: center 35%;
        }

        @keyframes characterFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-8px); }
        }

        .character-image::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, #FFCA28, #FFE082, #FFA726, #FFE082);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.15;
            animation: characterGlow 2s ease-in-out infinite alternate;
        }

        @keyframes characterGlow {
            0% { opacity: 0.1; transform: scale(1); }
            100% { opacity: 0.2; transform: scale(1.05); }
        }

        .level-name {
            font-size: 1rem;
            font-weight: 800;
            background: linear-gradient(135deg, #FFA726 0%, #42A5F5 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .progress-bar {
            width: 100%;
            height: 16px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #FFA726 0%, #FFB74D 50%, #FFD54F 100%);
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: progressShine 2s ease-in-out infinite;
        }

        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 800;
            font-size: 0.75rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 800;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-add {
            background: linear-gradient(135deg, #6bcf7f 0%, #4ecdc4 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(107, 207, 127, 0.3);
        }

        .btn-subtract {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .auto-controls {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .auto-controls h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .auto-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-auto {
            background: linear-gradient(45deg, #ffd93d, #FFCA28);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-auto:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .group-management {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: linear-gradient(45deg, #FFCA28, #FFE082);
            color: white;
            border-radius: 10px;
        }

        .day-cell {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .btn-day {
            padding: 5px 10px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .btn-day.add {
            background: #6bcf7f;
            color: white;
        }

        .btn-day.subtract {
            background: #ff6b6b;
            color: white;
        }

        .score-table { background:#fff; border-radius:16px; padding:16px; margin:16px 0; box-shadow:0 10px 24px rgba(0,0,0,0.08); }
        .score-table table { width:100%; border-collapse: collapse; }
        .score-table th, .score-table td { padding:10px 8px; text-align:left; }
        .score-table tr:nth-child(even){ background:#fafafa; }

        /* Grid h·ªçc sinh compact */
        .student-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 180px));
            gap: 15px;
            justify-content: center;
        }

        .student-card-compact {
            background: white;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            width: 180px;
            max-width: 180px;
            min-width: 180px;
            box-sizing: border-box;
        }

        .student-card-compact:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .student-card-compact.selected {
            border-color: #FFA726;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.08), rgba(255, 255, 255, 0.95));
        }

        .student-header-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .student-avatar-compact {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFA726, #FFD54F);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .student-info-compact {
            flex: 1;
            min-width: 0;
            text-align: center;
            width: 100%;
        }

        .student-name-compact {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
            line-height: 1.3;
        }

        .student-level-compact {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .student-points-compact {
            font-size: 1rem;
            font-weight: bold;
            text-align: center !important;
            margin: 3px 0;
            display: block;
            width: 100%;
        }

        .student-points-display {
            font-size: 1.2rem !important;
            font-weight: bold !important;
            margin: 8px 0 !important;
            text-align: center !important;
        }

        /* CSS ƒë·ªÉ ƒë·∫£m b·∫£o m√†u ƒëi·ªÉm ƒë∆∞·ª£c √°p d·ª•ng ƒë√∫ng */
        div[id^="points-"] {
            font-size: 1.2rem !important;
            font-weight: bold !important;
            margin: 8px 0 !important;
            text-align: center !important;
        }

        /* CSS cho m√†u ƒëi·ªÉm: ƒë·ªè n·∫øu √¢m, xanh l√° n·∫øu d∆∞∆°ng - PH·∫¢I c√≥ !important ƒë·ªÉ override m·ªçi CSS kh√°c */
        div[id^="points-"].points-negative,
        .student-points-display.points-negative,
        div[id^="points-"][class*="points-negative"] {
            color: #f44336 !important;
        }

        div[id^="points-"].points-positive,
        .student-points-display.points-positive,
        div[id^="points-"][class*="points-positive"] {
            color: #4caf50 !important;
        }

        .student-progress-compact {
            width: 100%;
            height: 5px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .student-progress-fill-compact {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .student-controls-compact {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
        }

        .btn-compact {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .btn-compact.add {
            background: linear-gradient(45deg, #6bcf7f, #4ecdc4);
            color: white;
        }

        .btn-compact.subtract {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
        }

        .btn-compact:hover {
            transform: scale(1.1);
        }

        .input-compact {
            width: 50px;
            padding: 7px 6px;
            border: 1px solid #eee;
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            background: white;
        }

        .input-compact:focus {
            outline: 2px solid #FFA726;
            border-color: #FFA726;
        }

        /* Responsive cho giao di·ªán compact */
        @media (max-width: 1200px) {
            .student-grid-compact {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .student-grid-compact {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 10px;
            }
        }

        .student-card-compact {
            background: white;
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            text-align: center;
        }

        .student-card-compact:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .student-name-compact {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .student-level-compact {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }

        .student-controls-compact {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }

        .student-controls-compact input {
            pointer-events: auto !important;
            z-index: 10 !important;
            position: relative !important;
            cursor: text !important;
            user-select: text !important;
        }

        .student-controls-compact input:focus {
            outline: 2px solid #FFA726 !important;
            border-color: #FFA726 !important;
        }

        /* CSS cho input trong tab h·ªçc sinh */
        .controls input {
            pointer-events: auto !important;
            z-index: 10 !important;
            position: relative !important;
            cursor: text !important;
            user-select: text !important;
            background: white !important;
            border: 1px solid #eee !important;
        }

        .controls input:focus {
            outline: 2px solid #FFA726 !important;
            border-color: #FFA726 !important;
            background: white !important;
            box-shadow: 0 0 5px rgba(255, 107, 157, 0.3) !important;
        }

        .controls input:hover {
            border-color: #FFA726 !important;
        }

        /* ƒê·∫£m b·∫£o input kh√¥ng b·ªã ch·∫∑n b·ªüi CSS kh√°c */
        input[type="number"] {
            pointer-events: auto !important;
            cursor: text !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }

        /* CSS cho tab Nh√≥m - Layout c·ªë ƒë·ªãnh */
        .group-card-fixed {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            height: 320px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .group-card-fixed:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* Thanh cu·ªôn cho danh s√°ch th√†nh vi√™n */
        .group-card-fixed .members-scroll {
            flex: 1;
            overflow-y: auto;
            max-height: 180px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px;
        }

        .group-card-fixed .members-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .group-card-fixed .members-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .group-card-fixed .members-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .group-card-fixed .members-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .btn-compact {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 800;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }

        .btn-compact:hover::before {
            left: 100%;
        }

        .btn-compact.add {
            background: linear-gradient(135deg, #6bcf7f 0%, #4ecdc4 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(107, 207, 127, 0.4);
        }

        .btn-compact.subtract {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-compact:hover {
            transform: scale(1.2) translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* Grid nh√≥m */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
            width: 100%;
            margin-right: 0;
        }

        .group-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .group-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .group-level {
            font-size: 0.85rem;
            color: #666;
        }

        .group-members {
            margin-top: 12px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .member-avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFA726, #FFD54F);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* T√≠nh nƒÉng */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.05), rgba(102, 126, 234, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            animation: featureIconFloat 3s ease-in-out infinite alternate;
            position: relative;
            z-index: 1;
        }

        @keyframes featureIconFloat {
            0% { transform: translateY(0px) rotate(0deg); }
            100% { transform: translateY(-5px) rotate(2deg); }
        }

        .feature-name {
            font-size: 1.6rem;
            font-weight: 800;
            background: linear-gradient(135deg, #42A5F5 0%, #FF7043 50%, #FFA726 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .feature-timer, .feature-result, .feature-meter {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #FFA726 0%, #42A5F5 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        /* Game-like particles effect */
        .game-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg, #FFD700, #FF6B9D);
            border-radius: 50%;
            animation: particleFloat 6s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { 
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10%, 90% {
                opacity: 0.2;
            }
            50% {
                transform: translateY(-10vh) rotate(180deg);
                opacity: 0.3;
            }
        }

        /* Special effects for buttons */
        .btn-game {
            position: relative;
            overflow: hidden;
        }

        .btn-game::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-game:active::after {
            width: 300px;
            height: 300px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .devices-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                padding: 15px;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                margin-right: 0;
                margin-bottom: 20px;
                padding: 15px 25px;
                justify-content: space-around;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .student-grid {
                grid-template-columns: 1fr;
            }

            .student-grid-compact {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .student-grid-compact {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-right {
                justify-content: center;
            }
        }

        /* Animation cho ·∫£nh bia.png */
        @keyframes imageGlow {
            0% { 
                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.4));
            }
            100% { 
                filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.5)) drop-shadow(0 0 45px rgba(255, 215, 0, 0.6));
            }
        }

        @keyframes imageFloat {
            0%, 100% { 
                transform: translateY(0px) scale(1);
            }
            50% { 
                transform: translateY(-5px) scale(1.02);
            }
        }

        /* Animation highlight ƒëi·ªÉm khi c·∫≠p nh·∫≠t - ƒê∆°n gi·∫£n v√† m∆∞·ª£t m√† */
        @keyframes pointHighlight {
            0% {
                transform: scale(1);
            }
            40% {
                transform: scale(1.1);
            }
            70% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes pointHighlightBg {
            0% {
                opacity: 0;
            }
            40% {
                opacity: 0.4;
            }
            70% {
                opacity: 0.2;
            }
            100% {
                opacity: 0;
            }
        }

        .point-highlight {
            animation: pointHighlight 0.6s ease-in-out;
            position: relative;
            text-align: center !important;
            display: inline-block !important;
        }
        
        .point-highlight::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
            width: calc(100% + 12px);
            height: calc(100% + 8px);
            background: rgba(66, 165, 245, 0.2);
            border-radius: 8px;
            z-index: -1;
            animation: pointHighlightBg 0.6s ease-in-out;
            pointer-events: none;
        }
        
        /* ƒê·∫£m b·∫£o ph·∫ßn t·ª≠ c√≥ text-align center t·ª´ parent v·∫´n ƒë∆∞·ª£c gi·ªØ - Th·∫ª l·ªõn */
        .student-card .point-highlight {
            display: inline-block !important;
            margin: 8px auto !important;
            text-align: center !important;
        }
        
        /* ƒê·∫∑c bi·ªát cho th·∫ª compact - ƒë·∫£m b·∫£o cƒÉn gi·ªØa ho√†n h·∫£o */
        .student-card-compact .point-highlight {
            display: inline-block !important;
            margin: 8px auto !important;
            text-align: center !important;
        }
        
        /* ƒê·∫£m b·∫£o container c·ªßa ƒëi·ªÉm c√≥ text-align center */
        .student-card > div[id^="points-"],
        .student-card-compact > div[id^="points-"] {
            text-align: center !important;
            display: block !important;
        }

        /* Animation cho badge ƒëi·ªÉm trong modal nh√≥m */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
            }
        }

        /* Hover effect cho th·∫ª h·ªçc sinh trong modal nh√≥m */
        #groupStudentsContent > div:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        }

        #groupStudentsContent > div:hover > div > div:first-child {
            transform: scale(1.05);
        }
        
    </style>
</head>
<body>
    <!-- Game particles effect -->
    <div class="game-particles" id="particles"></div>
    
    <div class="sidebar">
        <div class="nav-icon active" onclick="showTab('home')" title="Trang ch·ªß">
            <span>üè†</span>
        </div>
        <div class="nav-icon" onclick="showTab('students')" title="H·ªçc sinh">
            <span>üë•</span>
        </div>
        <div class="nav-icon" onclick="showTab('groups')" title="Nh√≥m">
            <span>üìä</span>
        </div>
        <div class="nav-icon" onclick="showTab('features')" title="T√≠nh nƒÉng">
            <span>‚ö°</span>
        </div>
        <div class="nav-icon" onclick="showTab('rewards')" title="ƒê·ªïi qu√†">
            <span>üéÅ</span>
        </div>
        <div class="nav-icon" onclick="showTab('reports')" title="B√°o c√°o">
            <span>üìà</span>
        </div>
        <div class="nav-icon" onclick="showTab('settings')" title="C√†i ƒë·∫∑t">
            <span>‚öôÔ∏è</span>
        </div>
    </div>

    <div class="main-content">
        <div class="left-section">
            <div class="header">
                <div class="greeting" style="display: flex; align-items: center; gap: 20px;">
                    <img src="data/bia.png" alt="ƒê∆∞·ªùng ƒë·∫øn ng√¥i vua" style="max-width: 100%; height: auto; max-height: 120px;">
                    <img src="data/text.png" alt="Cu·ªôc ƒëua v∆∞∆°ng gi·∫£" style="max-width: 100%; height: auto; max-height: 60px;">
                </div>
                <div class="header-right">
                    <button onclick="showPointBoard()" class="btn-game" style="background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; margin-right: 15px; font-weight: 700; box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                        ‚ú® B·∫£ng ƒëi·ªÉm c·ªông tr·ª´
                    </button>
                    <button onclick="resetAllPoints()" class="btn-game" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; margin-right: 15px; font-weight: 700; box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3); transition: all 0.3s ease;">üîÑ ƒê·∫∑t l·∫°i ƒëi·ªÉm</button>
                    <div class="icon-btn btn-game" onclick="showHistoryModal()" title="L·ªãch s·ª≠" style="background: linear-gradient(135deg, #42A5F5 0%, #FF7043 100%); color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                            <!-- V√≤ng tr√≤n ƒë·ªìng h·ªì (m·ªü b√™n tr√°i) -->
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2.5" fill="none" stroke-dasharray="20 4" stroke-dashoffset="2"/>
                            <!-- Kim gi·ªù (10 gi·ªù) - ng·∫Øn h∆°n -->
                            <line x1="12" y1="12" x2="9.5" y2="9.5" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                            <!-- Kim ph√∫t (45 ph√∫t) - d√†i h∆°n -->
                            <line x1="12" y1="12" x2="14.5" y2="16.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                            <!-- M≈©i t√™n cong quay ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì (t·ª´ tr√™n ph·∫£i xu·ªëng tr√°i) -->
                            <path d="M19 5 Q22 7 22 10 Q22 13 19 15" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19 15 L17 13 L19 11 Z" fill="currentColor"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Trang ch·ªß -->
            <div id="home-tab" class="tab-content active">
                <div class="devices-section">
                    <!-- Trang b√¨a v√† Top 5/Top 3 -->
                    <div style="display: grid; grid-template-columns: calc(100% - 525px) 500px; gap: 10px; margin-bottom: 25px;">
                        <div>
                            <div style="text-align: center; position: relative; margin-bottom: 0;">
                                <div style="background: radial-gradient(circle, #5D2F0A 0%, #2D1B0A 100%); padding: 15px 30px; border-radius: 30px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; max-width: calc(100% - 20px);">
                                    <img src="data/bia.png" alt="ƒê∆∞·ªùng ƒë·∫øn ng√¥i vua" style="max-width: 100%; height: auto; max-height: 180px; filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.4)); animation: imageGlow 3s ease-in-out infinite alternate, imageFloat 4s ease-in-out infinite; transition: all 0.3s ease;">
                                </div>
                            </div>
                            
                            <!-- Stats grid - Thu nh·ªè v√† ƒë·∫∑t d∆∞·ªõi trang b√¨a -->
                            <div class="stats-grid" style="margin-top: 15px; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div class="stat-card" style="padding: 15px 20px; min-height: 100px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 1.1rem; margin: 0 0 6px 0; background: linear-gradient(135deg, #FF6B9D, #FF9800); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">T·ªïng h·ªçc sinh</h3>
                                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                                <span class="stat-value" id="totalStudents" style="font-size: 2rem; background: linear-gradient(135deg, #FF9800, #FFCA28); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</span>
                                                <span class="stat-unit" style="font-size: 1.2rem; color: #666;">HS</span>
                                            </div>
                                        </div>
                                        <div class="stat-icon temp-icon" style="width: 55px; height: 55px; flex-shrink: 0;">
                                            <img src="data/nhom2.png" alt="Nh√≥m 2" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); transform: scale(1.4);">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="padding: 15px 20px; min-height: 100px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 1.1rem; margin: 0 0 6px 0; background: linear-gradient(135deg, #FF6B9D, #FF9800); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">D√¢n</h3>
                                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                                <span class="stat-value" id="commonStudents" style="font-size: 2rem; background: linear-gradient(135deg, #FF9800, #FFCA28); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</span>
                                                <span class="stat-unit" style="font-size: 1.2rem; color: #666;">HS</span>
                                            </div>
                                        </div>
                                        <div class="stat-icon temp-icon" style="width: 55px; height: 55px; flex-shrink: 0;">
                                            <img src="data/dan.png" alt="D√¢n" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); transform: scale(1.4);">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="padding: 15px 20px; min-height: 100px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 1.1rem; margin: 0 0 6px 0; background: linear-gradient(135deg, #FF6B9D, #FF9800); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">L√≠nh</h3>
                                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                                <span class="stat-value" id="soldierStudents" style="font-size: 2rem; background: linear-gradient(135deg, #FF9800, #FFCA28); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</span>
                                                <span class="stat-unit" style="font-size: 1.2rem; color: #666;">HS</span>
                                            </div>
                                        </div>
                                        <div class="stat-icon temp-icon" style="width: 55px; height: 55px; flex-shrink: 0;">
                                            <img src="data/linh.png" alt="L√≠nh" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); transform: scale(1.4);">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="padding: 15px 20px; min-height: 100px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 1.1rem; margin: 0 0 6px 0; background: linear-gradient(135deg, #FF6B9D, #FF9800); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Quan</h3>
                                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                                <span class="stat-value" id="officialStudents" style="font-size: 2rem; background: linear-gradient(135deg, #FF9800, #FFCA28); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</span>
                                                <span class="stat-unit" style="font-size: 1.2rem; color: #666;">HS</span>
                                            </div>
                                        </div>
                                        <div class="stat-icon temp-icon" style="width: 55px; height: 55px; flex-shrink: 0;">
                                            <img src="data/quan.png" alt="Quan" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); transform: scale(1.4);">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="padding: 15px 20px; min-height: 100px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 1.1rem; margin: 0 0 6px 0; background: linear-gradient(135deg, #FF6B9D, #FF9800); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">T·ªÉ t∆∞·ªõng</h3>
                                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                                <span class="stat-value" id="primeStudents" style="font-size: 2rem; background: linear-gradient(135deg, #FF9800, #FFCA28); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</span>
                                                <span class="stat-unit" style="font-size: 1.2rem; color: #666;">HS</span>
                                            </div>
                                        </div>
                                        <div class="stat-icon temp-icon" style="width: 55px; height: 55px; flex-shrink: 0;">
                                            <img src="data/tetuong.png" alt="T·ªÉ t∆∞·ªõng" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); transform: scale(1.4);">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="padding: 15px 20px; min-height: 100px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 1.1rem; margin: 0 0 6px 0; background: linear-gradient(135deg, #FF6B9D, #FF9800); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Vua</h3>
                                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                                <span class="stat-value" id="kingStudents" style="font-size: 2rem; background: linear-gradient(135deg, #FF9800, #FFCA28); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</span>
                                                <span class="stat-unit" style="font-size: 1.2rem; color: #666;">HS</span>
                                            </div>
                                        </div>
                                        <div class="stat-icon temp-icon" style="width: 55px; height: 55px; flex-shrink: 0;">
                                            <img src="data/vua.png" alt="Vua" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); transform: scale(1.4);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <div class="members-card">
                                <h3>Top 5 h·ªçc sinh</h3>
                                <div class="members-list" id="topStudentsList">
                                    <!-- Top h·ªçc sinh s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top 3 nh√≥m - Hi·ªÉn th·ªã to√†n chi·ªÅu ngang -->
                    <div class="my-devices-card" style="margin-top: 20px;">
                        <h3>Top 3 nh√≥m</h3>
                        <div class="my-devices-grid" id="topGroupsList">
                            <!-- Top nh√≥m s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                        </div>
                    </div>

                </div>
            </div>

            <!-- H·ªçc sinh -->
            <div id="students-tab" class="tab-content">
                <div class="devices-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #4a5568; font-size: 1.1rem; margin: 0;">Danh s√°ch h·ªçc sinh</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <!-- Toggle View Switch -->
                            <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 4px; border-radius: 12px;">
                                <span style="font-size: 0.9rem; color: #666; font-weight: 500;">Giao di·ªán:</span>
                                <button id="viewToggleBtn" onclick="toggleStudentView()" style="background: linear-gradient(45deg, #42A5F5, #FF7043); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;">Th·∫ª l·ªõn</button>
                            </div>
                            <button id="selectMultipleBtn" onclick="toggleSelectMultiple()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">Ch·ªçn nhi·ªÅu</button>
                            <button id="selectAllBtn" onclick="selectAllStudents()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; display: none;">Ch·ªçn t·∫•t c·∫£</button>
                            <div id="bulkControls" style="display: none; gap: 10px; align-items: center;">
                                <input type="number" id="bulkPoints" value="1" min="1" style="width: 80px; padding: 13px 8px; border-radius: 8px; border: 1px solid #eee; text-align: center; font-size: 1.125rem;">
                                <button onclick="addPointsToSelected()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">+</button>
                                <button onclick="subtractPointsFromSelected()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">-</button>
                            </div>
                        </div>
                    </div>
                    <div class="student-grid-compact" id="studentGrid">
                        <!-- H·ªçc sinh s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                    </div>
                </div>
            </div>

            <!-- Nh√≥m -->
            <div id="groups-tab" class="tab-content">
                <div class="devices-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #4a5568; font-size: 1.1rem; margin: 0;">Qu·∫£n l√Ω nh√≥m</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn-auto" onclick="showAddGroupModal()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">Th√™m nh√≥m</button>
                            <button id="selectGroupsBtn" onclick="toggleSelectGroups()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">Ch·ªçn nhi·ªÅu</button>
                            <button id="selectAllGroupsBtn" onclick="selectAllGroups()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; display: none;">‚úì Ch·ªçn t·∫•t c·∫£</button>
                            <button onclick="resetAllGroups()" style="background: linear-gradient(45deg, #ff4757, #ff6b6b); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">X√≥a t·∫•t c·∫£ nh√≥m</button>
                            <div id="groupBulkControls" style="display: none; gap: 10px; align-items: center;">
                                <input type="number" id="groupBulkPoints" value="1" min="1" style="width: 80px; padding: 8px; border-radius: 8px; border: 1px solid #eee; text-align: center;">
                                <button onclick="addPointsToSelectedGroups()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">+</button>
                                <button onclick="subtractPointsFromSelectedGroups()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">-</button>
                                <button onclick="deleteSelectedGroups()" style="background: linear-gradient(45deg, #ff4757, #ff6b6b); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">X√≥a</button>
                            </div>
                        </div>
                    </div>
                    <div class="groups-grid" id="groupsGrid">
                        <!-- Nh√≥m s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                    </div>
                </div>
            </div>

            <!-- T√≠nh nƒÉng -->
            <div id="features-tab" class="tab-content">
                <div class="devices-section">
                    <h3 style="color: #4a5568; margin-bottom: 20px; font-size: 1.1rem;">T√≠nh nƒÉng b·ªï tr·ª£</h3>
                    <div class="features-grid">
                        <div class="feature-card" onclick="showTimerModal()">
                            <div class="feature-icon">‚è±Ô∏è</div>
                            <div class="feature-name">B·∫•m gi·ªù</div>
                            <div class="feature-timer" id="timerDisplay">00:00:00</div>
                        </div>
                        <div class="feature-card" onclick="showRandomCallModal()">
                            <div class="feature-icon">üé≤</div>
                            <div class="feature-name">G·ªçi t√™n ng·∫´u nhi√™n</div>
                            <div class="feature-result" id="randomResult">B·∫•m ƒë·ªÉ g·ªçi</div>
                        </div>
                        <div class="feature-card" onclick="showSoundModal()">
                            <div class="feature-icon">üîä</div>
                            <div class="feature-name">ƒêo √¢m thanh</div>
                            <div class="feature-meter" id="soundMeter">Ch·ªçn ch·∫ø ƒë·ªô</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- C√†i ƒë·∫∑t -->
            <div id="settings-tab" class="tab-content">
                <div class="devices-section">
                    <h3 style="color: #4a5568; margin-bottom: 20px; font-size: 1.1rem;">C√†i ƒë·∫∑t v√† qu·∫£n l√Ω</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">Th√™m h·ªçc sinh</h4>
                            <textarea id="bulkStudentNamesSettings" rows="6" style="width:100%; padding:10px; border-radius:12px; border:1px solid #eee;" placeholder="M·ªói d√≤ng m·ªôt t√™n h·ªçc sinh"></textarea>
                            <button class="btn-auto" onclick="handleAddMultipleStudents('bulkStudentNamesSettings')" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; margin-top: 10px;">Th√™m h·ªçc sinh</button>
                            
                            <h4 style="margin: 20px 0 15px;">üìä Thi·∫øt l·∫≠p b·∫£ng ƒëi·ªÉm</h4>
                            
                            <!-- ƒêi·ªÉm C·ªông -->
                            <div style="margin-bottom: 25px;">
                                <div style="font-weight: 700; margin-bottom: 10px; color: #28a745; font-size: 1.1rem;">‚úÖ ƒêi·ªÉm C·ªông:</div>
                                <div id="addCriteriaContainer" style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 10px; min-height: 100px;">
                                    <!-- Ti√™u ch√≠ s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                                        </div>
                                <button onclick="addNewCriteria('add')" style="background: linear-gradient(45deg, #4caf50, #66bb6a); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%;">+ Th√™m ti√™u ch√≠</button>
                                    </div>
                                    
                            <!-- ƒêi·ªÉm Tr·ª´ -->
                            <div style="margin-bottom: 25px;">
                                <div style="font-weight: 700; margin-bottom: 10px; color: #dc3545; font-size: 1.1rem;">‚ùå ƒêi·ªÉm Tr·ª´:</div>
                                <div id="subtractCriteriaContainer" style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 10px; min-height: 100px;">
                                    <!-- Ti√™u ch√≠ s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                                        </div>
                                <button onclick="addNewCriteria('subtract')" style="background: linear-gradient(45deg, #f44336, #ef5350); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%;">+ Th√™m ti√™u ch√≠</button>
                                </div>
                                
                            <button onclick="saveAllCriteria()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem;">üíæ L∆∞u t·∫•t c·∫£</button>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">ƒêi·ªÉm y√™u c·∫ßu m·ªói m·ªëc</h4>
                            <div id="thresholdEditor"></div>
                            <button class="btn-auto" onclick="saveThresholds()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; margin-top: 10px;">L∆∞u m·ªëc</button>
                            
                            <h4 style="margin: 20px 0 15px;">Thi·∫øt l·∫≠p hi·ªán t·∫°i</h4>
                            <div id="thresholdTable" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #e9ecef;">
                                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">C·∫•p b·∫≠c</th>
                                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">ƒêi·ªÉm y√™u c·∫ßu</th>
                                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">H·ªá s·ªë</th>
                                        </tr>
                                    </thead>
                                    <tbody id="thresholdTableBody">
                                        <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªông -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <h4 style="margin: 20px 0 15px;">X√≥a h·ªçc sinh</h4>
                            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 700; margin-bottom: 10px; color: #856404;">‚ö†Ô∏è X√≥a h·ªçc sinh</div>
                                <select id="deleteStudentSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;">
                                    <option value="">-- Ch·ªçn h·ªçc sinh c·∫ßn x√≥a --</option>
                                </select>
                                <button onclick="deleteStudent()" style="background: linear-gradient(45deg, #ff4757, #ff6b6b); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 600;">üóëÔ∏è X√≥a h·ªçc sinh</button>
                            </div>

                            <h4 style="margin: 20px 0 15px;">X√≥a d·ªØ li·ªáu</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button onclick="clearAllStudents()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">X√≥a t·∫•t c·∫£ h·ªçc sinh</button>
                                <button onclick="resetAllGroups()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">X√≥a t·∫•t c·∫£ nh√≥m</button>
                                <button onclick="resetAllData()" style="background: linear-gradient(45deg, #ff4757, #ff6b6b); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
                            </div>

                            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="color: #FF6F00; font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;">
                                    ·ª®ng d·ª•ng qu·∫£n l√≠ l·ªõp h·ªçc ƒê∆∞·ªùng ƒë·∫øn ng√¥i vua
                                </div>
                                <div style="color: #495057; font-size: 1rem; font-weight: 600; margin-bottom: 10px;">
                                    T√°c gi·∫£: Ng√¥ Th·ªã M·ªπ Ng·ªçc
                                </div>
                                <div style="color: #495057; font-size: 0.95rem; margin-bottom: 10px;">
                                    Email: ngongoc231294@gmail.com
                                </div>
                                <div style="color: #6c757d; font-size: 0.95rem; font-style: italic;">
                                    ·ª®ng d·ª•ng h·ªó tr·ª£ qu·∫£n l√≠ l·ªõp h·ªçc hi·ªáu qu·∫£
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ƒê·ªïi qu√† -->
            <div id="rewards-tab" class="tab-content">
                <div class="devices-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #4a5568; font-size: 1.1rem; margin: 0;">üéÅ ƒê·ªïi qu√† - V·∫≠t ph·∫©m theo c·∫•p b·∫≠c</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="toggleExchangePointsSection()" id="toggleExchangeBtn" style="background: linear-gradient(45deg, #FFA726, #FFD54F); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                üí∞ ƒê·ªïi ƒëi·ªÉm
                            </button>
                            <button onclick="toggleRewardEditor()" id="toggleEditorBtn" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                ‚úèÔ∏è Ch·ªânh s·ª≠a v·∫≠t ph·∫©m
                            </button>
                        </div>
                    </div>
                    
                    <!-- Editor ·∫©n/hi·ªán -->
                    <div id="rewardEditorContainer" style="display: none; background: #f8f9fa; border-radius: 16px; padding: 20px; margin-bottom: 30px; border: 2px solid #6bcf7f;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="margin: 0; color: #333; font-size: 1.1rem;">üìù Ch·ªânh s·ª≠a th√¥ng tin v·∫≠t ph·∫©m</h4>
                            <button onclick="saveRewardItems()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600;">
                                üíæ L∆∞u thay ƒë·ªïi
                            </button>
                        </div>
                        <div id="rewardItemsEditor">
                            <!-- Form nh·∫≠p li·ªáu s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
                        </div>
                    </div>
                    
                    <!-- Section ƒê·ªïi ƒëi·ªÉm (·∫©n m·∫∑c ƒë·ªãnh) -->
                    <div id="exchangePointsSection" style="display: none; background: #f8f9fa; border-radius: 16px; padding: 20px; margin-bottom: 30px; border: 2px solid #FFA726;">
                        <h4 style="margin: 0 0 20px 0; color: #333; font-size: 1.2rem; font-weight: 700;">üí∞ Danh s√°ch ƒë·ªïi ƒëi·ªÉm</h4>
                        <div style="background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse; min-width: 1200px;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #FFA726 0%, #FFD54F 100%); color: white;">
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 50px;">STT</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 120px;">T√™n</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 100px;">C·∫•p b·∫≠c</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 80px;">ƒêi·ªÉm</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 500px;">Qu√† ƒë∆∞·ª£c ƒë·ªïi</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 100px;">T·ªïng ƒëi·ªÉm ƒë·ªïi</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 100px;">ƒê·ªïi ƒëi·ªÉm</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); width: 100px;">ƒêi·ªÉm c√≤n l·∫°i</th>
                                    </tr>
                                </thead>
                                <tbody id="exchangePointsTableBody">
                                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Grid hi·ªÉn th·ªã v·∫≠t ph·∫©m -->
                    <div id="rewardsGrid" class="student-grid">
                        <!-- Th·∫ª v·∫≠t ph·∫©m s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                    </div>
                </div>
            </div>

            <!-- B√°o c√°o -->
            <div id="reports-tab" class="tab-content">
                <div class="devices-section">
                    <h3 style="color: #4a5568; margin-bottom: 20px; font-size: 1.1rem;">B√°o c√°o v√† th·ªëng k√™</h3>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600;">T·ª´ ng√†y:</label>
                            <input type="date" id="startDate" style="padding: 8px; border-radius: 8px; border: 1px solid #eee;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600;">ƒê·∫øn ng√†y:</label>
                            <input type="date" id="endDate" style="padding: 8px; border-radius: 8px; border: 1px solid #eee;">
                        </div>
                        <button class="btn-auto" onclick="generateReport()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">T·∫°o b√°o c√°o</button>
                        <button class="btn-auto" onclick="exportToExcel()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">Xu·∫•t Excel</button>
                        <button class="btn-auto" onclick="showImportExcelModal()" style="background: linear-gradient(45deg, #42A5F5, #FF7043); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">Nh·∫≠p d·ªØ li·ªáu</button>
                    </div>
                    <div id="reportContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel-collapsible" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
        <div class="panel-content" id="quickPanel">
            <div style="font-weight:700; margin-bottom:8px;">Th√™m nhi·ªÅu h·ªçc sinh</div>
            <textarea id="bulkStudentNamesTop" rows="4" style="width:100%; padding:10px; border-radius:12px; border:1px solid #eee;"></textarea>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="chip-btn" onclick="handleAddMultipleStudents('bulkStudentNamesTop')" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">Th√™m h·ªçc sinh</button>
            </div>
            <hr style="margin:12px 0; border:none; height:1px; background:#f0f0f0;" />
            <div style="font-weight:700; margin-bottom:8px;">Th√™m nhi·ªÅu nh√≥m</div>
            <textarea id="bulkGroupNamesTop" rows="3" style="width:100%; padding:10px; border-radius:12px; border:1px solid #eee;"></textarea>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="chip-btn" onclick="handleAddMultipleGroups('bulkGroupNamesTop')" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">Th√™m nh√≥m</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:720px; max-width:95vw; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:800; font-size:1.1rem;">C√†i ƒë·∫∑t</div>
                <button class="chip-btn" onclick="closeSettings()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">ƒê√≥ng</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                <div>
                    <div style="font-weight:700; margin-bottom:6px;">Th√™m h·ªçc sinh (m·ªói d√≤ng m·ªôt t√™n)</div>
                    <textarea id="bulkStudentNamesSettings" rows="6" style="width:100%; padding:10px; border-radius:12px; border:1px solid #eee;"></textarea>
                    <div style="margin-top:8px;"><button class="chip-btn" onclick="handleAddMultipleStudents('bulkStudentNamesSettings')" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">Th√™m</button></div>
                    <div style="font-weight:700; margin:14px 0 6px;">Th√™m nh√≥m (m·ªói d√≤ng m·ªôt t√™n)</div>
                    <textarea id="bulkGroupNamesSettings" rows="5" style="width:100%; padding:10px; border-radius:12px; border:1px solid #eee;"></textarea>
                    <div style="margin-top:8px;"><button class="chip-btn" onclick="handleAddMultipleGroups('bulkGroupNamesSettings')" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">Th√™m</button></div>
                </div>
                <div>
                    <div style="font-weight:700; margin-bottom:6px;">ƒêi·ªÉm y√™u c·∫ßu m·ªói m·ªëc</div>
                    <div id="thresholdEditor"></div>
                    <div style="margin-top:10px;"><button class="chip-btn" onclick="saveThresholds()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">L∆∞u m·ªëc</button></div>
                    
                    <hr style="margin:20px 0; border:none; height:1px; background:#f0f0f0;" />
                    
                    <div style="font-weight:700; margin-bottom:15px; color: #333;">üìä Thi·∫øt l·∫≠p b·∫£ng ƒëi·ªÉm</div>
                    
                    <!-- ƒêi·ªÉm C·ªông -->
                    <div style="margin-bottom: 25px;">
                        <div style="font-weight: 700; margin-bottom: 10px; color: #28a745; font-size: 1.1rem;">‚úÖ ƒêi·ªÉm C·ªông:</div>
                        <div id="addCriteriaContainer" style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 10px;">
                            <!-- Ti√™u ch√≠ s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
                        <button onclick="addNewCriteria('add')" style="background: linear-gradient(45deg, #4caf50, #66bb6a); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%;">+ Th√™m ti√™u ch√≠</button>
            </div>
                    
                    <!-- ƒêi·ªÉm Tr·ª´ -->
                    <div style="margin-bottom: 25px;">
                        <div style="font-weight: 700; margin-bottom: 10px; color: #dc3545; font-size: 1.1rem;">‚ùå ƒêi·ªÉm Tr·ª´:</div>
                        <div id="subtractCriteriaContainer" style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 10px;">
                            <!-- Ti√™u ch√≠ s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                        </div>
                        <button onclick="addNewCriteria('subtract')" style="background: linear-gradient(45deg, #f44336, #ef5350); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%;">+ Th√™m ti√™u ch√≠</button>
                    </div>
                    
                    <button onclick="saveAllCriteria()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem;">üíæ L∆∞u t·∫•t c·∫£</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addGroupModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:600px; max-width:95vw; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div style="font-weight:800; font-size:1.2rem;">Th√™m nh√≥m m·ªõi</div>
                <button onclick="closeAddGroupModal()" style="background: #ff6b6b; color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">ƒê√≥ng</button>
            </div>
            <div style="margin-bottom:20px;">
                <label style="font-weight:700; margin-bottom:8px; display:block;">T√™n nh√≥m:</label>
                <textarea id="newGroupName" rows="6" placeholder="M·ªói d√≤ng 1 t√™n nh√≥m" style="width:100%; padding:12px; border-radius:12px; border:1px solid #eee; font-size:1rem; resize:vertical;"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeAddGroupModal()" style="background: #ccc; color:#333; border:none; padding:10px 20px; border-radius:12px; cursor:pointer;">H·ªßy</button>
                <button onclick="createNewGroup()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color:#fff; border:none; padding:10px 20px; border-radius:12px; cursor:pointer;">T·∫°o nh√≥m</button>
            </div>
        </div>
    </div>

    <div id="deleteGroupModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:500px; max-width:95vw; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div style="font-weight:800; font-size:1.2rem;">X√≥a nh√≥m</div>
                <button onclick="closeDeleteGroupModal()" style="background: #ff6b6b; color:#fff; border:none; padding:8px 12px; border-radius:12px; cursor:pointer;">ƒê√≥ng</button>
            </div>
            <div style="margin-bottom:20px;">
                <label style="font-weight:700; margin-bottom:8px; display:block;">Ch·ªçn nh√≥m ƒë·ªÉ x√≥a:</label>
                <select id="deleteGroupSelect" style="width:100%; padding:12px; border-radius:12px; border:1px solid #eee; font-size:1rem;">
                    <option value="">Ch·ªçn nh√≥m...</option>
                </select>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeDeleteGroupModal()" style="background: #ccc; color:#333; border:none; padding:10px 20px; border-radius:12px; cursor:pointer;">H·ªßy</button>
                <button onclick="deleteSelectedGroup()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color:#fff; border:none; padding:10px 20px; border-radius:12px; cursor:pointer;">X√≥a nh√≥m</button>
            </div>
        </div>
    </div>

    <!-- Modal Timer -->
    <div id="timerModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:700px; max-width:95vw; border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="font-weight:800; font-size:1.8rem;">B·∫•m gi·ªù</div>
                <button onclick="closeTimerModal()" style="background: #ff6b6b; color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600;">ƒê√≥ng</button>
            </div>
            <div style="text-align:center; margin-bottom:30px;">
                <div style="font-size:4.5rem; font-weight:bold; color:#FFA726; margin-bottom:30px;" id="timerDisplayModal">00:00:00</div>
                <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                    <button onclick="startCountdown()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color:#fff; border:none; padding:15px 30px; border-radius:12px; cursor:pointer; font-size:1.1rem; font-weight:600;">ƒê·∫øm ng∆∞·ª£c</button>
                    <button onclick="startStopwatch()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#fff; border:none; padding:15px 30px; border-radius:12px; cursor:pointer; font-size:1.1rem; font-weight:600;">ƒê·∫øm th·ªùi gian</button>
                    <button onclick="stopTimer()" style="background: #ff6b6b; color:#fff; border:none; padding:15px 30px; border-radius:12px; cursor:pointer; font-size:1.1rem; font-weight:600;">D·ª´ng</button>
                </div>
                <div style="margin-top:30px;">
                    <label style="font-weight:700; margin-bottom:12px; display:block; font-size:1.1rem;">Th·ªùi gian ƒë·∫øm ng∆∞·ª£c:</label>
                    <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
                        <div>
                            <label style="font-size: 1rem; color: #666; margin-bottom:8px; display:block;">Ph√∫t:</label>
                            <input type="number" id="countdownMinutes" value="5" min="0" max="59" style="width:100px; padding:12px; border-radius:8px; border:1px solid #eee; text-align:center; font-size:1.1rem;">
                        </div>
                        <div>
                            <label style="font-size: 1rem; color: #666; margin-bottom:8px; display:block;">Gi√¢y:</label>
                            <input type="number" id="countdownSeconds" value="0" min="0" max="59" style="width:100px; padding:12px; border-radius:8px; border:1px solid #eee; text-align:center; font-size:1.1rem;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Random Call -->
    <div id="randomCallModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:800px; max-width:95vw; border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="font-weight:800; font-size:1.8rem;">G·ªçi t√™n ng·∫´u nhi√™n</div>
                <button onclick="closeRandomCallModal()" style="background: #ff6b6b; color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600;">ƒê√≥ng</button>
            </div>
            <div style="text-align:center;">
                <div style="margin-bottom:30px;">
                    <label style="font-weight:700; margin-bottom:12px; display:block; font-size:1.1rem;">Ch·ªçn s·ªë l∆∞·ª£ng (1-5):</label>
                    <select id="randomCount" style="padding:12px 20px; border-radius:12px; border:1px solid #eee; font-size:1.1rem; width:200px;">
                        <option value="1">1 ng∆∞·ªùi</option>
                        <option value="2">2 ng∆∞·ªùi</option>
                        <option value="3">3 ng∆∞·ªùi</option>
                        <option value="4">4 ng∆∞·ªùi</option>
                        <option value="5">5 ng∆∞·ªùi</option>
                    </select>
                </div>
                <div style="font-size:3rem; font-weight:bold; color:#FFA726; margin-bottom:30px; min-height:100px; display:flex; align-items:center; justify-content:center; padding:20px;" id="randomNameDisplay">B·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
                <div style="display:flex; gap:15px; justify-content:center; align-items:center; flex-wrap:wrap;">
                    <button id="randomCallButton" onclick="toggleRandomCall()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color:#fff; border:none; padding:18px 40px; border-radius:12px; cursor:pointer; font-size:1.3rem; font-weight:600;">B·∫Øt ƒë·∫ßu</button>
                    <button onclick="resetCalledStudents()" style="background: linear-gradient(45deg, #FFCA28, #FFE082); color:#333; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600;">üîÑ Reset danh s√°ch</button>
                </div>
                <div style="margin-top:20px; font-size:0.95rem; color:#666;" id="calledStudentsInfo">ƒê√£ g·ªçi: 0/${students.length || 0} h·ªçc sinh</div>
            </div>
        </div>
    </div>

    <!-- Modal Sound Meter -->
    <div id="soundModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:700px; max-width:95vw; border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="font-weight:800; font-size:1.8rem;">ƒêo √¢m thanh</div>
                <button onclick="closeSoundModal()" style="background: #ff6b6b; color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600;">ƒê√≥ng</button>
            </div>
            <div style="text-align:center;">
                <div style="display:flex; gap:15px; justify-content:center; margin-bottom:30px; flex-wrap:wrap;">
                    <button onclick="startNoiseMeter()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color:#fff; border:none; padding:15px 30px; border-radius:12px; cursor:pointer; font-size:1.1rem; font-weight:600;">ƒêo ti·∫øng ·ªìn</button>
                    <button onclick="startReadingMeter()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color:#fff; border:none; padding:15px 30px; border-radius:12px; cursor:pointer; font-size:1.1rem; font-weight:600;">Luy·ªán ƒë·ªçc to</button>
                </div>
                <div style="margin-bottom:30px; padding:20px; background:#f8f9fa; border-radius:12px;">
                    <div style="display:flex; align-items:center; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
                        <label style="font-weight:600; color:#333; min-width:120px; text-align:left; font-size:1.1rem;">ƒê·ªô nh·∫°y:</label>
                        <input type="range" id="sensitivitySlider" min="0.1" max="3.0" step="0.1" value="1.0" style="flex:1; min-width:200px; height:8px; border-radius:3px; background:#ddd; outline:none; -webkit-appearance:none;">
                        <span id="sensitivityValue" style="font-weight:bold; color:#4a5568; min-width:150px; text-align:right; font-size:1.1rem;">1.0x (‚âà100dB)</span>
                    </div>
                    <div style="font-size:0.9rem; color:#666; margin-top:10px; text-align:center;">
                        üí° ƒê·ªô nh·∫°y c√†ng cao, m·ª©c dB y√™u c·∫ßu c√†ng th·∫•p. Chu·∫©n: 100dB (ƒë·ªô nh·∫°y 1.0x)
                </div>
                </div>
                <div style="margin-bottom:30px;">
                    <div style="font-size:2.5rem; font-weight:bold; color:#333; margin-bottom:15px;" id="soundLevelDisplay">0 dB</div>
                    <div style="width:100%; height:30px; background:#f0f0f0; border-radius:15px; overflow:hidden; margin-bottom:15px;">
                        <div id="soundBar" style="height:100%; background:linear-gradient(90deg, #6bcf7f, #ffd93d, #ff6b6b); width:0%; transition:width 0.3s ease;"></div>
                    </div>
                    <div style="font-size:1.5rem; font-weight:bold;" id="soundStatus">Ch·ªçn ch·∫ø ƒë·ªô ƒëo</div>
                </div>
                <button onclick="stopSoundMeter()" style="background: #ccc; color:#333; border:none; padding:15px 30px; border-radius:12px; cursor:pointer; font-size:1.1rem; font-weight:600;">D·ª´ng</button>
            </div>
        </div>
    </div>

    <!-- Modal Nh·∫≠p d·ªØ li·ªáu Excel -->
    <div id="importExcelModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:700px; max-width:95vw; border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="font-weight:800; font-size:1.8rem;">üì• Nh·∫≠p d·ªØ li·ªáu t·ª´ Excel</div>
                <button onclick="closeImportExcelModal()" style="background: #ff6b6b; color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600;">ƒê√≥ng</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:20px;">
                <!-- N√∫t T·∫£i m·∫´u file -->
                <button onclick="downloadExcelTemplate()" style="background: linear-gradient(45deg, #6bcf7f, #4ecdc4); color:white; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600; width:100%;">üì• T·∫£i m·∫´u file</button>
                
                <!-- Nh·∫≠p d·ªØ li·ªáu -->
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:10px; color:#4a5568; font-size:1rem;">Nh·∫≠p d·ªØ li·ªáu:</label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px; font-size:0.95rem;">
                    <button onclick="importExcelData()" style="background: linear-gradient(45deg, #42A5F5, #FF7043); color:white; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600; width:100%;">üìä Nh·∫≠p d·ªØ li·ªáu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal L·ªãch s·ª≠ -->
    <div id="historyModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:1000px; max-width:95vw; max-height:90vh; border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2); display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="font-weight:800; font-size:1.8rem; display:flex; align-items:center; gap:10px;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2.5" fill="none" stroke-dasharray="20 4" stroke-dashoffset="2"/>
                        <line x1="12" y1="12" x2="9.5" y2="9.5" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                        <line x1="12" y1="12" x2="14.5" y2="16.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        <path d="M19 5 Q22 7 22 10 Q22 13 19 15" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 15 L17 13 L19 11 Z" fill="currentColor"/>
                    </svg>
                    L·ªãch s·ª≠ c·ªông ƒëi·ªÉm
                </div>
                <button onclick="closeHistoryModal()" style="background: #ff6b6b; color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600;">ƒê√≥ng</button>
            </div>
            <div style="flex:1; overflow-y:auto; margin-bottom:20px;">
                <div id="historyList" style="display:flex; flex-direction:column; gap:10px;">
                    <!-- N·ªôi dung l·ªãch s·ª≠ s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center; padding-top:20px; border-top:2px solid #eee;">
                <button onclick="deleteSelectedHistoryItems()" id="deleteSelectedBtn" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color:#fff; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600; display:none;">X√≥a ƒë√£ ch·ªçn</button>
            </div>
        </div>
    </div>

    <!-- Modal Hi·ªÉn th·ªã h·ªçc sinh trong nh√≥m -->
    <div id="groupStudentsModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2000;">
        <div style="background:#fff; width:740px; max-width:95vw; max-height:calc(70vh + 50px); border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2); display:flex; flex-direction:column;">
            <!-- Header v·ªõi icon settings v√† dropdown -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; position:relative;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div style="position:relative;">
                        <button id="groupSettingsBtn" onclick="toggleGroupSettingsDropdown()" style="background:none; border:none; cursor:pointer; padding:8px; font-size:1.5rem;">‚öôÔ∏è</button>
                        <div id="groupSettingsDropdown" style="position:absolute; top:100%; left:0; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); padding:8px 0; margin-top:5px; min-width:180px; display:none; z-index:10;">
                            <button onclick="showEditGroupModal()" style="width:100%; text-align:left; padding:10px 15px; border:none; background:none; cursor:pointer; color:#333; font-size:0.95rem;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">Ch·ªânh s·ª≠a nh√≥m</button>
                            <button onclick="deleteCurrentGroup()" style="width:100%; text-align:left; padding:10px 15px; border:none; background:none; cursor:pointer; color:#f44336; font-size:0.95rem;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">Xo√° nh√≥m</button>
                        </div>
                    </div>
                    <div style="font-weight:800; font-size:1.8rem;" id="groupStudentsModalTitle">2</div>
                </div>
                <button onclick="closeGroupStudentsModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#333; padding:8px;">‚úï</button>
            </div>
            <!-- Main content v·ªõi th·∫ª h·ªçc sinh -->
            <div style="flex:1; overflow-y:auto; margin-bottom:20px; display: flex; align-items: center; justify-content: center;">
                <div id="groupStudentsContent" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; align-items:center; width:100%;">
                    <!-- N·ªôi dung h·ªçc sinh s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ch·ªânh s·ª≠a nh√≥m -->
    <div id="editGroupModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.25); z-index: 2001;">
        <div style="background:#fff; width:800px; max-width:95vw; max-height:90vh; border-radius:20px; padding:40px; box-shadow:0 10px 30px rgba(0,0,0,0.2); display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="font-weight:800; font-size:1.8rem;" id="editGroupModalTitle">Ch·ªânh s·ª≠a nh√≥m</div>
                <button onclick="closeEditGroupModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#333; padding:8px;">‚úï</button>
            </div>
            <div style="flex:1; overflow-y:auto; margin-bottom:20px;">
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:1rem;">T√™n nh√≥m:</label>
                    <input type="text" id="editGroupName" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1rem;" />
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:1rem;">Th√†nh vi√™n trong nh√≥m:</label>
                    <div id="editGroupMembers" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:15px;">
                        <!-- Danh s√°ch h·ªçc sinh s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                    </div>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:1rem;">Th√™m h·ªçc sinh:</label>
                    <div id="addStudentToGroupList" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:15px; background:#f8f9fa;">
                        <!-- Danh s√°ch h·ªçc sinh s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeEditGroupModal()" style="background:#ccc; color:#333; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">H·ªßy</button>
                <button onclick="addStudentToGroupFromEdit()" style="background:linear-gradient(45deg, #42A5F5, #FF7043); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">Th√™m h·ªçc sinh ƒë√£ ch·ªçn</button>
                <button onclick="saveEditGroup()" style="background:linear-gradient(45deg, #6bcf7f, #4ecdc4); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Modal B·∫£ng ƒëi·ªÉm c·ªông tr·ª´ -->
    <div id="pointBoardModal" onclick="closePointBoardModal()" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(5px);">
        <div onclick="event.stopPropagation()" style="background: white; width:1200px; max-width:95vw; border-radius:20px; padding:0; box-shadow:0 20px 60px rgba(0,0,0,0.4); overflow:hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px; color:white; text-align:center; position:relative;">
                <h2 style="margin:0; font-size:1.8rem; font-weight:800; text-shadow:0 2px 4px rgba(0,0,0,0.3);">üìä B·∫£ng ƒêi·ªÉm C·ªông Tr·ª´</h2>
            </div>
            
            <!-- Tabs -->
            <div style="display:flex; background:#f8f9fa; border-bottom:2px solid #e9ecef;">
                <button id="pointBoardAddTab" onclick="switchPointBoardTab('add')" style="flex:1; padding:15px; border:none; background:#28a745; color:white; font-weight:bold; cursor:pointer; transition:all 0.3s; font-size:1rem;">‚úÖ ƒêi·ªÉm C·ªông</button>
                <button id="pointBoardSubtractTab" onclick="switchPointBoardTab('subtract')" style="flex:1; padding:15px; border:none; background:#6c757d; color:white; font-weight:bold; cursor:pointer; transition:all 0.3s; font-size:1rem;">‚ùå ƒêi·ªÉm Tr·ª´</button>
            </div>
            
            <!-- N·ªôi dung Tab -->
            <div style="padding:30px;">
                <div id="pointBoardAddContent" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:15px;">
                    <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                </div>
                <div id="pointBoardSubtractContent" style="display:none; grid-template-columns: repeat(6, 1fr); gap:15px;">
                    <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                </div>
            </div>
            
            <!-- Footer -->
            <div style="text-align:center; padding:20px; background:#f8f9fa; border-top:2px solid #e9ecef;">
                <button onclick="closePointBoardModal()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color:white; border:none; padding:12px 40px; border-radius:12px; cursor:pointer; font-weight:bold; font-size:1rem;">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        // D·ªØ li·ªáu h·ªçc sinh
        let students = JSON.parse(localStorage.getItem('students')) || [];
        
        // C·∫•p ƒë·ªô v√† ƒëi·ªÉm c·∫ßn thi·∫øt (c√≥ h·ªá s·ªë th∆∞·ªüng) + l∆∞u ch·ªânh s·ª≠a
        let levels = JSON.parse(localStorage.getItem('levels')) || [
            { name: 'D√¢n th∆∞·ªùng', points: 0, icon: 'üë§', color: '#FFCA28', multiplier: 1 },
            { name: 'L√≠nh', points: 10, icon: '‚öîÔ∏è', color: '#FFE082', multiplier: 1.25 },
            { name: 'Quan', points: 25, icon: 'üìú', color: '#ffd93d', multiplier: 2 },
            { name: 'T·ªÉ t∆∞·ªõng', points: 40, icon: 'üé©', color: '#6bcf7f', multiplier: 3 },
            { name: 'Vua', points: 60, icon: 'üëë', color: '#4ecdc4', multiplier: 4 }
        ];
        function saveLevels(){ localStorage.setItem('levels', JSON.stringify(levels)); }

        // V·∫≠t ph·∫©m ƒë·ªïi qu√†
        let rewardItems = JSON.parse(localStorage.getItem('rewardItems')) || [
            { level: 'D√¢n th∆∞·ªùng', itemName: 'T√∫i g·∫°o', itemImage: 'https://cdn-icons-png.flaticon.com/512/2771/2771432.png', description: 'T√∫i g·∫°o 5kg' },
            { level: 'L√≠nh', itemName: 'B·ªô ƒë·ªì d√πng h·ªçc t·∫≠p', itemImage: 'https://cdn-icons-png.flaticon.com/512/2232/2232688.png', description: 'B·ªô b√∫t vi·∫øt + v·ªü' },
            { level: 'Quan', itemName: 'S√°ch hay', itemImage: 'https://cdn-icons-png.flaticon.com/512/2702/2702134.png', description: 'S√°ch ki·∫øn th·ª©c b·ªï √≠ch' },
            { level: 'T·ªÉ t∆∞·ªõng', itemName: 'Phi·∫øu qu√† t·∫∑ng', itemImage: 'https://cdn-icons-png.flaticon.com/512/3081/3081559.png', description: 'Voucher 200.000ƒë' },
            { level: 'Vua', itemName: 'H·ªçc b·ªïng', itemImage: 'https://cdn-icons-png.flaticon.com/512/2331/2331941.png', description: 'H·ªçc b·ªïng to√†n ph·∫ßn' }
        ];
        function saveRewardItems(){ localStorage.setItem('rewardItems', JSON.stringify(rewardItems)); }

        // L∆∞u theo tu·∫ßn
        function getISOWeek(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { week: weekNo, year: d.getUTCFullYear() };
        }
        function getWeekKey(date = new Date()) {
            const { week, year } = getISOWeek(date);
            return `students_${year}_W${week}`;
        }
        function loadStudentsForWeek(date = new Date()) {
            const key = getWeekKey(date);
            const data = JSON.parse(localStorage.getItem(key));
            if (Array.isArray(data)) return data;
            let fallback = JSON.parse(localStorage.getItem('students_base'));
            if (!Array.isArray(fallback)) {
                fallback = [
                    { id: 1, name: 'Nguy·ªÖn VƒÉn A', points: 0 },
                    { id: 2, name: 'Tr·∫ßn Th·ªã B', points: 0 },
                    { id: 3, name: 'L√™ VƒÉn C', points: 0 },
                    { id: 4, name: 'Ph·∫°m Th·ªã D', points: 0 },
                    { id: 5, name: 'Ho√†ng VƒÉn E', points: 0 }
                ];
            }
            localStorage.setItem(key, JSON.stringify(fallback));
            return JSON.parse(localStorage.getItem(key));
        }
        function saveStudentsForWeek(date = new Date()) {
            const key = getWeekKey(date);
            localStorage.setItem(key, JSON.stringify(students));
            localStorage.setItem('students_base', JSON.stringify(students));
        }

        // Nh√≥m
        let groups = JSON.parse(localStorage.getItem('groups')) || [];
        // ƒê·∫£m b·∫£o t·∫•t c·∫£ nh√≥m c√≥ tr∆∞·ªùng points (t∆∞∆°ng th√≠ch v·ªõi d·ªØ li·ªáu c≈©)
        groups.forEach(group => {
            if (typeof group.points === 'undefined') {
                group.points = 0;
            }
        });
        function saveGroups() { localStorage.setItem('groups', JSON.stringify(groups)); }
        
        // L·ªãch s·ª≠ c·ªông ƒëi·ªÉm
        let pointHistory = JSON.parse(localStorage.getItem('pointHistory')) || [];
        function savePointHistory() { 
            localStorage.setItem('pointHistory', JSON.stringify(pointHistory));
        }
        
        function addToHistory(studentId, studentName, points, totalPoints, type = 'individual') {
            const historyItem = {
                id: Date.now() + Math.random(), // ID duy nh·∫•t
                studentId: studentId,
                studentName: studentName,
                points: points,
                totalPoints: totalPoints,
                type: type, // 'individual', 'group', 'bulk'
                date: new Date().toISOString()
            };
            pointHistory.push(historyItem);
            // Ch·ªâ gi·ªØ l·ªãch s·ª≠ 30 ng√†y g·∫ßn nh·∫•t
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            pointHistory = pointHistory.filter(item => new Date(item.date) >= thirtyDaysAgo);
            savePointHistory();
        }
        
        // B·∫£ng ƒëi·ªÉm c·ªông tr·ª´
        let criteriaData = JSON.parse(localStorage.getItem('criteriaData')) || {
            add: [
                { icon: '‚≠ê', content: 'Tr·∫£ l·ªùi ƒë√∫ng', points: 1 },
                { icon: 'üèÜ', content: 'L√†m b√†i t·ªët', points: 2 },
                { icon: 'üéØ', content: 'Ho√†n th√†nh b√†i t·∫≠p', points: 1 }
            ],
            subtract: [
                { icon: '‚ùå', content: 'Kh√¥ng l√†m b√†i', points: 1 },
                { icon: '‚ö†Ô∏è', content: 'N√≥i chuy·ªán', points: 1 },
                { icon: 'üö´', content: 'Kh√¥ng ch√∫ √Ω', points: 2 }
            ]
        };
        function saveCriteriaData() { localStorage.setItem('criteriaData', JSON.stringify(criteriaData)); }
        
        // H√†m reset nh√≥m
        function resetAllGroups() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ nh√≥m?')) {
                groups = [];
                saveGroups();
                renderGroupsGrid();
                alert('ƒê√£ x√≥a t·∫•t c·∫£ nh√≥m!');
            }
        }

        function resetAllData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                students = [];
                groups = [];
                localStorage.clear();
                saveStudents();
                saveGroups();
                renderStudents();
                renderGroupsGrid();
                renderTopStudents();
                renderTopGroups();
                alert('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!');
            }
        }


        function createGroup() {
            const nameInput = document.getElementById('newGroupName');
            const name = (nameInput.value || '').trim();
            if (!name) return alert('Nh·∫≠p t√™n nh√≥m.');
            const id = Date.now();
            groups.push({ id, name, studentIds: [], points: 0 });
            saveGroups();
            nameInput.value = '';
            renderGroupSelects();
        }
        function renderGroupSelects() {
            const groupSelect = document.getElementById('groupSelect');
            const calendarGroupSelect = document.getElementById('calendarGroupSelect');
            if (groupSelect) groupSelect.innerHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            if (calendarGroupSelect) calendarGroupSelect.innerHTML = `<option value="all">T·∫•t c·∫£</option>` + groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        }
        function assignSelectedStudentsToGroup() {
            const select = document.getElementById('groupSelect');
            const groupId = parseInt(select.value, 10);
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            const selectedIds = Array.from(document.querySelectorAll('.student-select:checked')).map(cb => parseInt(cb.value, 10));
            selectedIds.forEach(id => { if (!group.studentIds.includes(id)) group.studentIds.push(id); });
            saveGroups();
        }

        // Kh·ªüi t·∫°o theo tu·∫ßn
        if (students.length === 0) { students = loadStudentsForWeek(); }

        function saveStudents() { saveStudentsForWeek(); }

        function getCurrentLevel(points) {
            for (let i = levels.length - 1; i >= 0; i--) {
                if (points >= levels[i].points) {
                    return levels[i];
                }
            }
            return levels[0];
        }

        // H√†m l·∫•y m√†u cho ƒëi·ªÉm s·ªë: ƒë·ªè n·∫øu √¢m, xanh l√° n·∫øu d∆∞∆°ng ho·∫∑c b·∫±ng 0
        function getPointColor(points) {
            if (points < 0) {
                return '#f44336'; // M√†u ƒë·ªè cho ƒëi·ªÉm √¢m
            } else {
                return '#4caf50'; // M√†u xanh l√° cho ƒëi·ªÉm d∆∞∆°ng ho·∫∑c b·∫±ng 0
            }
        }

        function getNextLevel(points) {
            for (let i = 0; i < levels.length; i++) {
                if (points < levels[i].points) {
                    return levels[i];
                }
            }
            return levels[levels.length - 1];
        }

        function getProgressPercentage(points) {
            // N·∫øu ƒëi·ªÉm √¢m, tr·∫£ v·ªÅ 0%
            if (points < 0) {
                return 0;
            }
            
            const currentLevel = getCurrentLevel(points);
            const nextLevel = getNextLevel(points);
            
            if (nextLevel.points === currentLevel.points) {
                return 100;
            }
            
            const progress = ((points - currentLevel.points) / (nextLevel.points - currentLevel.points)) * 100;
            return Math.min(100, Math.max(0, progress));
        }

        // Base64 Images - ƒê·ªÉ nh√∫ng ·∫£nh tr·ª±c ti·∫øp v√†o HTML
        const base64Images = {
            'D√¢n th∆∞·ªùng': '', // Thay b·∫±ng: data:image/png;base64,iVBORw0KGgo...
            'L√≠nh': '',
            'Quan': '',
            'T·ªÉ t∆∞·ªõng': '',
            'Vua': ''
        };
        
        function getLevelImage(levelName) {
            // N·∫øu c√≥ base64, d√πng base64. N·∫øu kh√¥ng, d√πng file path
            if (base64Images[levelName]) {
                return base64Images[levelName];
            }
            
            // Fallback v·ªÅ file path
            const imageMap = {
                'D√¢n th∆∞·ªùng': 'data/dan.png',
                'L√≠nh': 'data/linh.png',
                'Quan': 'data/quan.png',
                'T·ªÉ t∆∞·ªõng': 'data/tetuong.png',
                'Vua': 'data/vua.png'
            };
            return imageMap[levelName] || 'data/dan.png';
        }

        function getLevelGradient(levelName) {
            const gradients = {
                'D√¢n th∆∞·ªùng': 'linear-gradient(90deg, #95a5a6, #bdc3c7, #ecf0f1)', // X√°m nh·∫°t
                'L√≠nh': 'linear-gradient(90deg, #3498db, #5dade2, #85c1e9)', // Xanh d∆∞∆°ng
                'Quan': 'linear-gradient(90deg, #9b59b6, #bb8fce, #d7bde2)', // T√≠m
                'T·ªÉ t∆∞·ªõng': 'linear-gradient(90deg, #e67e22, #f39c12, #f7dc6f)', // Cam v√†ng
                'Vua': 'linear-gradient(90deg, #e74c3c, #f1948a, #fadbd8)' // ƒê·ªè h·ªìng
            };
            return gradients[levelName] || gradients['D√¢n th∆∞·ªùng'];
        }

        // Undo stack
        const undoStack = [];
        function pushUndo(){ undoStack.push(JSON.stringify({ students })); if (undoStack.length>20) undoStack.shift(); }
        function undo(){ if (undoStack.length===0) return alert('Kh√¥ng c√≥ g√¨ ƒë·ªÉ ho√†n t√°c.'); const last = undoStack.pop(); const state = JSON.parse(last); students = state.students; saveStudents(); renderStudents(); renderGroupGrid(); }

        // H√†m highlight ƒëi·ªÉm khi c·∫≠p nh·∫≠t
        function highlightPoints(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('point-highlight');
                setTimeout(() => {
                    element.classList.remove('point-highlight');
                }, 600);
            }
        }

        function updateStudentPoints(studentId, change) {
            console.log('updateStudentPoints called:', studentId, change);
            const student = students.find(s => s.id === studentId);
            if (student) {
                pushUndo();
                const currentLevel = getCurrentLevel(student.points);
                const adjusted = Math.round(change * (currentLevel.multiplier || 1));
                const oldPoints = student.points;
                student.points = student.points + adjusted;
                
                // L∆∞u l·ªãch s·ª≠ ƒëi·ªÉm
                if (!student.history) student.history = [];
                student.history.push({
                    date: new Date().toISOString(),
                    points: adjusted,
                    total: student.points
                });
                
                // L∆∞u v√†o l·ªãch s·ª≠ t·∫≠p trung
                addToHistory(studentId, student.name, adjusted, student.points, 'individual');
                
                console.log('Student points updated:', student.name, student.points);
                saveStudents();
                renderStudents();
                renderGroupGrid();
                renderTopStudents();
                renderTopGroups();
                updateHomeStats();
                // Highlight ƒëi·ªÉm sau khi render
                setTimeout(() => {
                    highlightPoints(`points-${studentId}`);
                }, 50);
            }
        }

        function addPointsToAll(points) {
            pushUndo();
            const now = new Date().toISOString();
            students.forEach(student => {
                const currentLevel = getCurrentLevel(student.points);
                const adjusted = Math.round(points * (currentLevel.multiplier || 1));
                student.points = student.points + adjusted;
                
                // L∆∞u l·ªãch s·ª≠ ƒëi·ªÉm
                if (!student.history) student.history = [];
                student.history.push({
                    date: now,
                    points: adjusted,
                    total: student.points
                });
            });
            saveStudents();
            renderStudents();
            renderGroupGrid();
            renderTopStudents();
            renderTopGroups();
            renderAllStudentsList();
            updateHomeStats();
        }

        function addPointsToGroup(points, groupId) {
            pushUndo();
            const now = new Date().toISOString();
            const grp = groupId === 'all' ? null : groups.find(g => String(g.id) === String(groupId));
            const targetIds = grp ? grp.studentIds : students.map(s => s.id);
            
            // C·ªông ƒëi·ªÉm v√†o nh√≥m (n·∫øu l√† nh√≥m c·ª• th·ªÉ)
            if (grp) {
                // ƒê·∫£m b·∫£o nh√≥m c√≥ tr∆∞·ªùng points
                if (typeof grp.points === 'undefined') {
                    grp.points = 0;
                }
                grp.points = (grp.points || 0) + points;
                saveGroups();
            }
            
            // ∆Øu ƒë√£i nh√≥m: l·∫•y h·ªá s·ªë cao nh·∫•t trong nh√≥m (Quan/T·ªÉ t∆∞·ªõng/Vua), ch·ªâ t√≠nh 1 l·∫ßn
            let groupMultiplier = 1;
            if (grp) {
                const topMult = targetIds
                    .map(id => getCurrentLevel((students.find(s=>s.id===id)||{}).points || 0).multiplier || 1)
                    .reduce((m,v)=>Math.max(m,v),1);
                groupMultiplier = Math.max(1, topMult);
            }
            const levelUpStudents = []; // L∆∞u danh s√°ch h·ªçc sinh l√™n c·∫•p
            students.forEach(student => {
                if (targetIds.includes(student.id)) {
                    // L∆∞u level tr∆∞·ªõc khi c·ªông ƒëi·ªÉm
                    const oldLevel = getCurrentLevel(student.points);
                    const selfMult = getCurrentLevel(student.points).multiplier || 1;
                    // Ch·ªâ √°p d·ª•ng h·ªá s·ªë khi c√°c th√†nh vi√™n c√≥ ch·ª©c v·ª• cao
                    const adjusted = Math.round(points * Math.max(selfMult, groupMultiplier));
                    
                    // C·ªông ƒëi·ªÉm
                    student.points = student.points + adjusted;
                    
                    // Ki·ªÉm tra level sau khi c·ªông ƒëi·ªÉm
                    const newLevel = getCurrentLevel(student.points);
                    
                    // Ki·ªÉm tra xem c√≥ l√™n c·∫•p kh√¥ng
                    if (oldLevel.name !== newLevel.name) {
                        levelUpStudents.push({ id: student.id, name: student.name, newLevel: newLevel.name });
                    }
                    
                    // L∆∞u l·ªãch s·ª≠ ƒëi·ªÉm
                    if (!student.history) student.history = [];
                    student.history.push({
                        date: now,
                        points: adjusted,
                        total: student.points
                    });
                    
                    // L∆∞u v√†o l·ªãch s·ª≠ t·∫≠p trung
                    addToHistory(student.id, student.name, adjusted, student.points, grp ? 'group' : 'bulk');
                }
            });
            saveStudents();
            renderStudents();
            renderGroupGrid();
            renderGroupsGrid();
            renderTopStudents();
            renderTopGroups();
            updateHomeStats();
            
            // Ph√°t √¢m thanh khi c·ªông ho·∫∑c tr·ª´ ƒëi·ªÉm cho nh√≥m
            if (points > 0) {
                playGameSound('success');
            } else if (points < 0) {
                playGameSound('click');
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o ch√∫c m·ª´ng cho h·ªçc sinh l√™n c·∫•p
            if (levelUpStudents.length > 0 && points > 0) {
                playGameSound('levelup');
                showMultipleLevelUpNotifications(levelUpStudents);
            }
            
            // C·∫≠p nh·∫≠t modal n·∫øu ƒëang m·ªü
            const groupModal = document.getElementById('groupStudentsModal');
            if (groupModal && groupModal.style.display === 'flex' && grp) {
                renderGroupStudents(grp.id);
            }
            
            // Highlight ƒëi·ªÉm tr√™n th·∫ª nh√≥m sau khi render
            requestAnimationFrame(() => {
                setTimeout(() => {
                    if (grp) {
                        // Highlight ƒëi·ªÉm tr√™n th·∫ª nh√≥m
                        const groupPointsElement = document.getElementById(`group-points-${grp.id}`);
                        if (groupPointsElement) {
                            highlightPoints(`group-points-${grp.id}`);
                        }
                    } else {
                        // N·∫øu c·ªông cho t·∫•t c·∫£, highlight t·∫•t c·∫£ th·∫ª nh√≥m
                        groups.forEach(g => {
                            const groupPointsElement = document.getElementById(`group-points-${g.id}`);
                            if (groupPointsElement) {
                                highlightPoints(`group-points-${g.id}`);
                            }
                        });
                    }
                }, 100);
            });
        }

        function resetAllPoints() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset t·∫•t c·∫£ ƒëi·ªÉm s·ªë?')) {
                students.forEach(student => {
                    student.points = 0;
                });
                // Reset ƒëi·ªÉm nh√≥m v·ªÅ 0
                groups.forEach(group => {
                    group.points = 0;
                });
                saveStudents();
                saveGroups();
                renderStudents();
                renderGroupGrid();
                renderGroupsGrid();
                renderTopStudents();
                renderTopGroups();
                updateHomeStats();
            }
        }

        function handleAddMultipleStudents(textareaId='bulkStudentNames') {
            const textarea = document.getElementById(textareaId);
            const lines = (textarea.value || '').split(/\n+/).map(s => s.trim()).filter(Boolean);
            if (lines.length === 0) return alert('Nh·∫≠p √≠t nh·∫•t m·ªôt t√™n h·ªçc sinh.');
            const maxId = students.reduce((m, s) => Math.max(m, s.id), 0);
            let nextId = maxId + 1;
            lines.forEach(name => { students.push({ id: nextId++, name, points: 0 }); });
            textarea.value = '';
            saveStudents();
            renderStudents();
            renderGroupSelects();
            renderGroupGrid();
        }

        function clearAllStudents() {
            if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô h·ªçc sinh?')) return;
            students = [];
            saveStudents();
            renderStudents();
            renderGroupSelects();
            renderGroupGrid();
        }

        // H√†m s·∫Øp x·∫øp h·ªçc sinh theo T√äN (t·ª´ cu·ªëi c√πng)
        // V√≠ d·ª•: "L√Ω L√¢m Vy Th·∫£o" -> s·∫Øp x·∫øp theo "Th·∫£o" (t√™n), kh√¥ng ph·∫£i "L√Ω" (h·ªç)
        function sortStudentsByLastName(a, b) {
            // L·∫•y T√äN (t·ª´ cu·ªëi c√πng) c·ªßa h·ªçc sinh
            const getLastName = (name) => {
                if (!name || typeof name !== 'string') return '';
                // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng ƒë·∫ßu cu·ªëi, normalize chu·ªói
                const trimmed = name.trim();
                if (!trimmed) return '';
                // T√°ch theo kho·∫£ng tr·∫Øng (m·ªôt ho·∫∑c nhi·ªÅu kho·∫£ng tr·∫Øng)
                const words = trimmed.split(/\s+/).filter(word => word && word.length > 0);
                // L·∫•y t·ª´ cu·ªëi c√πng (T√äN) trong m·∫£ng
                // V√≠ d·ª•: "L√Ω L√¢m Vy Th·∫£o" -> ["L√Ω", "L√¢m", "Vy", "Th·∫£o"] -> l·∫•y "Th·∫£o"
                if (words.length === 0) return trimmed;
                const lastWord = words[words.length - 1];
                return lastWord ? lastWord.trim() : trimmed;
            };
            
            const lastNameA = getLastName(a.name);
            const lastNameB = getLastName(b.name);
            
            // So s√°nh theo T√äN (t·ª´ cu·ªëi), n·∫øu gi·ªëng nhau th√¨ so s√°nh to√†n b·ªô t√™n
            const compare = lastNameA.localeCompare(lastNameB, 'vi', { sensitivity: 'base' });
            const result = compare !== 0 ? compare : a.name.localeCompare(b.name, 'vi');
            
            // Debug log ƒë·ªÉ ki·ªÉm tra (c√≥ th·ªÉ x√≥a sau)
            if (Math.random() < 0.01) { // Ch·ªâ log 1% ƒë·ªÉ kh√¥ng spam console
                console.log(`Sort: "${a.name}" -> last word: "${lastNameA}" | "${b.name}" -> last word: "${lastNameB}" | result: ${result}`);
            }
            
            return result;
        }

        function renderStudents() {
            console.log('renderStudents called');
            const grid = document.getElementById('studentGrid');
            if (!grid) {
                console.error('studentGrid not found');
                return;
            }
            
            // ƒê·∫£m b·∫£o c√≥ style tag cho m√†u ƒëi·ªÉm v·ªõi specificity c·ª±c cao
            if (!document.getElementById('student-points-color-style')) {
                const styleTag = document.createElement('style');
                styleTag.id = 'student-points-color-style';
                styleTag.textContent = `
                    /* CSS v·ªõi specificity c·ª±c cao ƒë·ªÉ override m·ªçi CSS kh√°c */
                    .student-card div[id^="points-"].points-negative,
                    .student-card .student-points-display.points-negative,
                    div.student-card div[id^="points-"][class*="points-negative"],
                    body .student-card div[id^="points-"].points-negative {
                        color: #f44336 !important;
                    }
                    .student-card div[id^="points-"].points-positive,
                    .student-card .student-points-display.points-positive,
                    div.student-card div[id^="points-"][class*="points-positive"],
                    body .student-card div[id^="points-"].points-positive {
                        color: #4caf50 !important;
                    }
                `;
                document.head.appendChild(styleTag);
            }
            
            // Thay ƒë·ªïi layout th√†nh grid 6 c·ªôt
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(6, 1fr)';
            grid.style.gap = '20px';
            grid.innerHTML = '';

            // S·∫Øp x·∫øp theo t·ª´ cu·ªëi c·ªßa t√™n
            const sortedStudents = [...students].sort(sortStudentsByLastName);
            console.log('Students to render:', sortedStudents.length);

            sortedStudents.forEach(student => {
                const currentLevel = getCurrentLevel(student.points);
                const nextLevel = getNextLevel(student.points);
                const progress = getProgressPercentage(student.points);
                // T√≠nh to√°n m√†u: ƒë·ªè n·∫øu ƒëi·ªÉm √¢m, xanh l√° n·∫øu ƒëi·ªÉm d∆∞∆°ng
                const pointColor = student.points < 0 ? '#f44336' : '#4caf50';
                console.log('Rendering student:', student.name, 'points:', student.points, 'color:', pointColor);

                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <div class="student-name" style="margin-bottom:8px;">${student.name}</div>
                    <div class="character-level">
                        <div class="character-image" style="background: ${currentLevel.color}">
                            <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width: 82px; height: 82px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <span style="display: none;">${currentLevel.icon}</span>
                        </div>
                        <div class="level-name">${currentLevel.name}</div>
                    </div>
                    <div id="points-${student.id}" style="font-size: 1rem; font-weight: bold; margin: 4px 0; text-align: center; color: ${pointColor};">${student.points} ƒëi·ªÉm</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${getLevelGradient(currentLevel.name)}">
                            <div class="progress-text">${Math.round(progress)}%</div>
                        </div>
                    </div>
                    <div class="controls" style="gap:5px; display:flex; justify-content:center; align-items:center;">
                        <button class="btn btn-add" onclick="applyAmount(${student.id}, true)" style="padding:5px 10px; font-size:0.85rem; order:1;">+</button>
                        <input type="number" id="amount-${student.id}" value="1" min="1" step="1" style="width:75px; padding:5px 6px; border-radius:6px; border:1px solid #eee; text-align:center; font-size:0.85rem; order:2; cursor: text; background: white;" onfocus="console.log('Input focused:', ${student.id})" onchange="console.log('Input changed:', ${student.id}, this.value)" onclick="console.log('Input clicked:', ${student.id})" onkeydown="console.log('Input keydown:', ${student.id}, event.key)" onkeyup="console.log('Input keyup:', ${student.id}, event.key)" />
                        <button class="btn btn-subtract" onclick="applyAmount(${student.id}, false)" style="padding:5px 10px; font-size:0.85rem; order:3;">-</button>
                    </div>
                `;
                
                grid.appendChild(studentCard);
                
                // Set m√†u ƒëi·ªÉm ngay sau khi append v√†o DOM - d√πng nhi·ªÅu c√°ch ƒë·ªÉ ƒë·∫£m b·∫£o
                const pointsElement = document.getElementById('points-' + student.id);
                if (pointsElement) {
                    // Set m√†u: ƒë·ªè n·∫øu ƒëi·ªÉm √¢m, xanh l√° n·∫øu ƒëi·ªÉm d∆∞∆°ng
                    const colorValue = student.points < 0 ? '#f44336' : '#4caf50';
                    
                    // Function ƒë·ªÉ force set m√†u
                    const forceSetColor = () => {
                        pointsElement.style.removeProperty('color');
                        pointsElement.style.setProperty('color', colorValue, 'important');
                        // Ki·ªÉm tra computed style v√† set l·∫°i n·∫øu c·∫ßn
                        const computedColor = window.getComputedStyle(pointsElement).color;
                        if (computedColor !== 'rgb(244, 67, 54)' && computedColor !== 'rgb(76, 175, 80)') {
                            pointsElement.style.setProperty('color', colorValue, 'important');
                        }
                    };
                    
                    // Set ngay l·∫≠p t·ª©c
                    forceSetColor();
                    
                    // Set l·∫°i sau khi render
                    requestAnimationFrame(() => {
                        forceSetColor();
                    });
                    
                    // Set l·∫°i sau m·ªôt ch√∫t ƒë·ªÉ override m·ªçi CSS kh√°c
                    setTimeout(() => {
                        forceSetColor();
                        // Force reflow
                        pointsElement.offsetHeight;
                        forceSetColor();
                    }, 10);
                    
                    // D√πng MutationObserver ƒë·ªÉ theo d√µi v√† force set m√†u m·ªói khi c√≥ thay ƒë·ªïi
                    const observer = new MutationObserver(() => {
                        forceSetColor();
                    });
                    observer.observe(pointsElement, {
                        attributes: true,
                        attributeFilter: ['style', 'class'],
                        childList: false,
                        subtree: false
                    });
                }
                
                // Th√™m event listener ƒë·ªÉ ƒë·∫£m b·∫£o input ho·∫°t ƒë·ªông
                const input = document.getElementById(`amount-${student.id}`);
                if (input) {
                    input.addEventListener('focus', function() {
                        console.log('Input focused via addEventListener:', student.id);
                        this.select();
                    });
                    input.addEventListener('input', function() {
                        console.log('Input changed via addEventListener:', student.id, this.value);
                    });
                    input.addEventListener('click', function() {
                        console.log('Input clicked via addEventListener:', student.id);
                        this.select();
                    });
                }
            });
            
            updateHomeStats();
            renderMembersList();
            renderTopStudents();
            renderTopGroups();
            renderAllStudentsList();
            console.log('renderStudents completed');
        }

        function applyAmount(studentId, isAdd) {
            console.log('applyAmount called:', studentId, isAdd);
            const input = document.getElementById(`amount-${studentId}`);
            if (!input) {
                console.error('Input not found for student:', studentId);
                return;
            }
            let value = parseInt(input.value, 10);
            if (isNaN(value) || value <= 0) value = 1;
            console.log('Applying amount:', value, 'to student:', studentId, 'isAdd:', isAdd);
            updateStudentPoints(studentId, isAdd ? value : -value);
        }

        function applyCompactAmount(studentId, isAdd) {
            console.log('applyCompactAmount called:', studentId, isAdd);
            const input = document.getElementById(`compact-amount-${studentId}`);
            if (!input) {
                console.error('Input not found for student:', studentId);
                return;
            }
            let value = parseInt(input.value, 10);
            if (isNaN(value) || value <= 0) value = 1;
            console.log('Applying amount:', value, 'to student:', studentId, 'isAdd:', isAdd);
            updateStudentPoints(studentId, isAdd ? value : -value);
        }

        function getAutoAmount(){
            const v = parseInt(document.getElementById('autoAmount').value, 10);
            return isNaN(v) || v <= 0 ? 1 : v;
        }

        function deleteStudent() {
            const select = document.getElementById('deleteStudentSelect');
            const studentId = parseInt(select.value);
            if (!studentId) {
                alert('Vui l√≤ng ch·ªçn h·ªçc sinh c·∫ßn x√≥a!');
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert('Kh√¥ng t√¨m th·∫•y h·ªçc sinh!');
                return;
            }
            
            if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc sinh "${student.name}"?\n\nL∆∞u √Ω: Vi·ªác n√†y c≈©ng s·∫Ω x√≥a h·ªçc sinh kh·ªèi t·∫•t c·∫£ c√°c nh√≥m m√† h·ªçc sinh tham gia.`)) {
                return;
            }
            
            // X√≥a h·ªçc sinh kh·ªèi danh s√°ch
            students = students.filter(s => s.id !== studentId);
            
            // X√≥a h·ªçc sinh kh·ªèi t·∫•t c·∫£ nh√≥m
            groups.forEach(group => {
                group.studentIds = group.studentIds.filter(id => id !== studentId);
            });
            
            // L∆∞u d·ªØ li·ªáu
            saveStudents();
            saveGroups();
            
            // C·∫≠p nh·∫≠t giao di·ªán
            renderStudents();
            renderGroupSelects();
            renderGroupGrid();
            renderTopStudents();
            renderTopGroups();
            updateDeleteStudentSelect();
            updateHomeStats();
            
            alert(`ƒê√£ x√≥a h·ªçc sinh "${student.name}" th√†nh c√¥ng!`);
            select.value = '';
        }

        function updateDeleteStudentSelect() {
            const select = document.getElementById('deleteStudentSelect');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc sinh c·∫ßn x√≥a --</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} - ${getCurrentLevel(student.points).name} - ${student.points} ƒëi·ªÉm`;
                select.appendChild(option);
            });
            
            // Gi·ªØ l·∫°i gi√° tr·ªã ƒë√£ ch·ªçn n·∫øu v·∫´n t·ªìn t·∫°i
            if (currentValue && students.find(s => s.id === parseInt(currentValue))) {
                select.value = currentValue;
            }
        }

        function showTab(tabName) {
            // Reset danh s√°ch lo·∫°i tr·ª´ khi chuy·ªÉn tab (tr·ª´ khi chuy·ªÉn sang tab features)
            if (tabName !== 'features') {
                calledStudentIds.clear();
            }
            
            // ·∫®n t·∫•t c·∫£ tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-icon').forEach(btn => {
                btn.classList.remove('active');
            });

            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // T√¨m v√† active icon t∆∞∆°ng ·ª©ng
            const iconMap = {
                'home': 'üè†',
                'students': 'üë•', 
                'groups': 'üìä',
                'features': '‚ö°',
                'rewards': 'üéÅ',
                'reports': 'üìà',
                'settings': '‚öôÔ∏è'
            };
            
            if (iconMap[tabName]) {
                const targetIcon = Array.from(document.querySelectorAll('.nav-icon')).find(icon => {
                    const span = icon.querySelector('span');
                    return span && span.textContent.includes(iconMap[tabName]);
                });
                if (targetIcon) {
                    targetIcon.classList.add('active');
                }
            }

            // Render n·ªôi dung t∆∞∆°ng ·ª©ng
            if (tabName === 'home') {
                renderTopStudents();
                renderTopGroups();
            }

            // C·∫≠p nh·∫≠t header
            const titles = {
                'home': { title: 'Trang ch·ªß', subtitle: 'T·ªïng quan l·ªõp h·ªçc' },
                'students': { title: 'H·ªçc sinh', subtitle: 'Qu·∫£n l√Ω h·ªçc sinh' },
                'groups': { title: 'Nh√≥m', subtitle: 'Qu·∫£n l√Ω nh√≥m h·ªçc t·∫≠p' },
                'features': { title: 'T√≠nh nƒÉng', subtitle: 'C√¥ng c·ª• b·ªï tr·ª£' },
                'rewards': { title: 'ƒê·ªïi qu√†', subtitle: 'V·∫≠t ph·∫©m theo c·∫•p b·∫≠c' },
                'settings': { title: 'C√†i ƒë·∫∑t', subtitle: 'Qu·∫£n l√Ω h·ªá th·ªëng' },
                'reports': { title: 'B√°o c√°o', subtitle: 'Th·ªëng k√™ v√† xu·∫•t d·ªØ li·ªáu' }
            };
            
            document.getElementById('headerTitle').textContent = titles[tabName].title;
            document.getElementById('headerSubtitle').textContent = titles[tabName].subtitle;
            
            // Hi·ªÉn th·ªã/·∫©n search box
            document.getElementById('searchBox').style.display = (tabName === 'students') ? 'block' : 'none';

            // Render n·ªôi dung t∆∞∆°ng ·ª©ng
            if (tabName === 'home') {
                updateHomeStats();
                renderTopStudents();
                renderTopGroups();
            } else if (tabName === 'students') {
                console.log('Switching to students tab');
                renderStudents();
                updateHomeStats();
                console.log('Students tab rendered with renderStudents()');
            } else if (tabName === 'groups') {
                renderGroupsGrid();
            } else if (tabName === 'features') {
                // Kh√¥ng c·∫ßn render g√¨
            } else if (tabName === 'rewards') {
                renderRewardsGrid();
            } else if (tabName === 'settings') {
                buildThresholdEditor();
                buildThresholdTable();
            } else if (tabName === 'reports') {
                // Kh√¥ng c·∫ßn render g√¨
            }
        }

        // Giao di·ªán nh√≥m gi·ªëng b·∫£ng ch√≠nh
        function renderGroupGrid(){
            const groupGrid = document.getElementById('groupGrid');
            const groupSelect = document.getElementById('groupActionSelect');
            if (!groupGrid || !groupSelect) return;
            groupSelect.innerHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            const selectedId = parseInt(groupSelect.value || (groups[0]?.id || 0), 10);
            const grp = groups.find(g => g.id === selectedId);
            groupGrid.innerHTML = '';
            const memberIds = grp ? grp.studentIds : [];
            const members = students.filter(s => memberIds.includes(s.id)).sort(sortStudentsByLastName);
            members.forEach(student => {
                const currentLevel = getCurrentLevel(student.points);
                const progress = getProgressPercentage(student.points);
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content: space-between; align-items:center; gap:8px;">
                        <div class="student-name" style="margin-bottom:0;">${student.name}</div>
                    </div>
                    <div class="character-level">
                        <div class="character-image" style="background: ${currentLevel.color}">
                            <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width: 120px; height: 120px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <span style="display: none;">${currentLevel.icon}</span>
                        </div>
                        <div class="level-name">${currentLevel.name}</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${getLevelGradient(currentLevel.name)}"><div class="progress-text">${Math.round(progress)}%</div></div>
                    </div>
                    <div class="controls" style="gap:6px;">
                        <input type="number" id="gamount-${student.id}" value="1" min="1" style="width:80px; padding:8px 10px; border-radius:12px; border:1px solid #eee; text-align:center;" />
                        <button class="btn btn-add" onclick="applyAmount(${student.id}, true)">C·ªông</button>
                        <button class="btn btn-subtract" onclick="applyAmount(${student.id}, false)">Tr·ª´</button>
                    </div>`;
                groupGrid.appendChild(card);
            });
        }

        function applyGroupAction(isAdd){
            const amt = parseInt(document.getElementById('groupAutoAmount').value, 10) || 1;
            const gid = document.getElementById('groupActionSelect').value;
            addPointsToGroup(isAdd ? amt : -amt, gid);
        }

        function togglePanel(btn){ document.getElementById('quickPanel').classList.toggle('open'); }

        // Settings modal
        function openSettings(){ 
            console.log('Opening settings modal...');
            document.getElementById('settingsModal').style.display='flex'; 
            buildThresholdEditor(); 
            buildThresholdTable(); 
            loadCriteriaDisplay();
            console.log('Settings modal opened successfully');
        }
        function closeSettings(){ document.getElementById('settingsModal').style.display='none'; }
        function buildThresholdEditor(){
            const host = document.getElementById('thresholdEditor');
            host.innerHTML = levels.map((lv, idx) => `
                <div style=\"display:flex; align-items:center; gap:8px; margin-bottom:8px;\">
                    <div style=\"width:110px; font-weight:700;\">${lv.name}</div>
                    <input type=\"number\" min=\"0\" value=\"${lv.points}\" id=\"th-${idx}\" style=\"flex:1; padding:8px; border-radius:10px; border:1px solid #eee;\" />
                    <span style=\"color:#777;\">H·ªá s·ªë:</span>
                    <input type=\"number\" step=\"0.25\" min=\"1\" value=\"${lv.multiplier||1}\" id=\"mul-${idx}\" style=\"width:90px; padding:8px; border-radius:10px; border:1px solid #eee;\" />
                </div>`).join('');
        }
        
        // Hi·ªÉn th·ªã danh s√°ch ti√™u ch√≠
        function loadCriteriaDisplay() {
            console.log('loadCriteriaDisplay called');
            console.log('criteriaData:', criteriaData);
            
            // Hi·ªÉn th·ªã ƒëi·ªÉm c·ªông
            const addContainer = document.getElementById('addCriteriaContainer');
            console.log('addContainer:', addContainer);
            if (addContainer && criteriaData.add) {
                if (criteriaData.add.length === 0) {
                    addContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Ch∆∞a c√≥ ti√™u ch√≠ n√†o</div>';
            } else {
                    addContainer.innerHTML = criteriaData.add.map((item, idx) => `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <select onchange="updateCriteriaIcon('add', ${idx}, this.value)" style="width: 70px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 1.3rem; background: white;">
                                <option value="‚≠ê" ${item.icon === '‚≠ê' ? 'selected' : ''}>‚≠ê</option>
                                <option value="üèÜ" ${item.icon === 'üèÜ' ? 'selected' : ''}>üèÜ</option>
                                <option value="üéØ" ${item.icon === 'üéØ' ? 'selected' : ''}>üéØ</option>
                                <option value="üí°" ${item.icon === 'üí°' ? 'selected' : ''}>üí°</option>
                                <option value="üî•" ${item.icon === 'üî•' ? 'selected' : ''}>üî•</option>
                                <option value="‚ö°" ${item.icon === '‚ö°' ? 'selected' : ''}>‚ö°</option>
                            </select>
                            <input type="text" onchange="updateCriteriaContent('add', ${idx}, this.value)" value="${item.content}" placeholder="Nh·∫≠p ti√™u ch√≠..." style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.95rem;" />
                            <input type="number" onchange="updateCriteriaPoints('add', ${idx}, this.value)" value="${item.points}" min="1" style="width: 70px; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-size: 0.95rem;" />
                            <button onclick="deleteCriteriaItem('add', ${idx})" style="background: #ff6b6b; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2rem;">√ó</button>
                        </div>
                    `).join('');
                }
            }
            
            // Hi·ªÉn th·ªã ƒëi·ªÉm tr·ª´
            const subtractContainer = document.getElementById('subtractCriteriaContainer');
            if (subtractContainer && criteriaData.subtract) {
                if (criteriaData.subtract.length === 0) {
                    subtractContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Ch∆∞a c√≥ ti√™u ch√≠ n√†o</div>';
                } else {
                    subtractContainer.innerHTML = criteriaData.subtract.map((item, idx) => `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <select onchange="updateCriteriaIcon('subtract', ${idx}, this.value)" style="width: 70px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 1.3rem; background: white;">
                                <option value="‚ùå" ${item.icon === '‚ùå' ? 'selected' : ''}>‚ùå</option>
                                <option value="‚ö†Ô∏è" ${item.icon === '‚ö†Ô∏è' ? 'selected' : ''}>‚ö†Ô∏è</option>
                                <option value="üö´" ${item.icon === 'üö´' ? 'selected' : ''}>üö´</option>
                                <option value="üí•" ${item.icon === 'üí•' ? 'selected' : ''}>üí•</option>
                                <option value="üî•" ${item.icon === 'üî•' ? 'selected' : ''}>üî•</option>
                                <option value="‚ö°" ${item.icon === '‚ö°' ? 'selected' : ''}>‚ö°</option>
                            </select>
                            <input type="text" onchange="updateCriteriaContent('subtract', ${idx}, this.value)" value="${item.content}" placeholder="Nh·∫≠p ti√™u ch√≠..." style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.95rem;" />
                            <input type="number" onchange="updateCriteriaPoints('subtract', ${idx}, this.value)" value="${item.points}" min="1" style="width: 70px; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-size: 0.95rem;" />
                            <button onclick="deleteCriteriaItem('subtract', ${idx})" style="background: #ff6b6b; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2rem;">√ó</button>
                        </div>
                    `).join('');
                }
            }
        }
        
        // Th√™m ti√™u ch√≠ m·ªõi
        function addNewCriteria(type) {
            if (type === 'add') {
                criteriaData.add.push({ icon: '‚≠ê', content: '', points: 1 });
            } else {
                criteriaData.subtract.push({ icon: '‚ùå', content: '', points: 1 });
            }
            saveCriteriaData();
            loadCriteriaDisplay();
        }
        
        // X√≥a ti√™u ch√≠
        function deleteCriteriaItem(type, idx) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ti√™u ch√≠ n√†y?')) {
                criteriaData[type].splice(idx, 1);
                saveCriteriaData();
                loadCriteriaDisplay();
            }
        }
        
        // C·∫≠p nh·∫≠t icon
        function updateCriteriaIcon(type, idx, value) {
            criteriaData[type][idx].icon = value;
            saveCriteriaData();
        }
        
        // C·∫≠p nh·∫≠t n·ªôi dung
        function updateCriteriaContent(type, idx, value) {
            criteriaData[type][idx].content = value;
            saveCriteriaData();
        }
        
        // C·∫≠p nh·∫≠t ƒëi·ªÉm
        function updateCriteriaPoints(type, idx, value) {
            criteriaData[type][idx].points = parseInt(value) || 1;
            saveCriteriaData();
        }
        
        // L∆∞u t·∫•t c·∫£
        function saveAllCriteria() {
            saveCriteriaData();
            alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
            loadCriteriaDisplay();
        }
        
        function showPointBoard() {
            document.getElementById('pointBoardModal').style.display = 'flex';
            loadPointBoardDisplay();
        }
        
        function closePointBoardModal() {
            document.getElementById('pointBoardModal').style.display = 'none';
        }
        
        function switchPointBoardTab(tab) {
            const addTab = document.getElementById('pointBoardAddTab');
            const subtractTab = document.getElementById('pointBoardSubtractTab');
            const addContent = document.getElementById('pointBoardAddContent');
            const subtractContent = document.getElementById('pointBoardSubtractContent');
            
            if (tab === 'add') {
                addTab.style.background = '#28a745';
                subtractTab.style.background = '#6c757d';
                addContent.style.display = 'grid';
                subtractContent.style.display = 'none';
            } else {
                addTab.style.background = '#6c757d';
                subtractTab.style.background = '#dc3545';
                addContent.style.display = 'none';
                subtractContent.style.display = 'grid';
            }
        }
        
        function loadPointBoardDisplay() {
            // Hi·ªÉn th·ªã ƒëi·ªÉm c·ªông
            const addContent = document.getElementById('pointBoardAddContent');
            if (addContent && criteriaData.add) {
                addContent.innerHTML = criteriaData.add.map((item, index) => `
                    <div style="
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        transition: all 0.3s ease;
                        cursor: pointer;
                        min-height: 120px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                    " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.25)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onclick="applyCriteriaPoint('add', ${index})">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">${item.icon}</div>
                        <h4 style="margin: 0 0 10px; color: #333; font-size: 0.9rem; font-weight: 600; line-height: 1.3; min-height: 35px;">${item.content}</h4>
                        <div style="background: #28a745; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; display: inline-block;">+${item.points}</div>
                    </div>
                `).join('');
            }
            
            // Hi·ªÉn th·ªã ƒëi·ªÉm tr·ª´
            const subtractContent = document.getElementById('pointBoardSubtractContent');
            if (subtractContent && criteriaData.subtract) {
                subtractContent.innerHTML = criteriaData.subtract.map((item, index) => `
                    <div style="
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        transition: all 0.3s ease;
                        cursor: pointer;
                        min-height: 120px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                    " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.25)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onclick="applyCriteriaPoint('subtract', ${index})">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">${item.icon}</div>
                        <h4 style="margin: 0 0 10px; color: #333; font-size: 0.9rem; font-weight: 600; line-height: 1.3; min-height: 35px;">${item.content}</h4>
                        <div style="background: #dc3545; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; display: inline-block;">-${item.points}</div>
                                    </div>
                `).join('');
            }
        }
        
        function applyCriteriaPoint(type, index) {
            const item = type === 'add' ? criteriaData.add[index] : criteriaData.subtract[index];
            if (!item) return;
            
            if (confirm(`√Åp d·ª•ng "${item.content}" (${type === 'add' ? '+' : '-'}${item.points} ƒëi·ªÉm) cho t·∫•t c·∫£ h·ªçc sinh?`)) {
                pushUndo();
                const now = new Date().toISOString();
                students.forEach(student => {
                    const currentLevel = getCurrentLevel(student.points);
                    const adjusted = Math.round((type === 'add' ? item.points : -item.points) * (currentLevel.multiplier || 1));
                    student.points = student.points + adjusted;
                    
                    if (!student.history) student.history = [];
                    student.history.push({
                        date: now,
                        points: adjusted,
                        total: student.points,
                        reason: item.content
                    });
                });
                saveStudents();
                renderStudents();
                renderGroupGrid();
                renderTopStudents();
                renderTopGroups();
                updateHomeStats();
                closePointBoardModal();
                alert(`ƒê√£ √°p d·ª•ng "${item.content}" cho t·∫•t c·∫£ h·ªçc sinh!`);
            }
        }
        function buildThresholdTable(){
            const host = document.getElementById('thresholdTableBody');
            if (!host) return;
            host.innerHTML = levels.map(lv => `
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold; color: ${lv.color};">${lv.name}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${lv.points} ƒëi·ªÉm</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">x${lv.multiplier||1}</td>
                </tr>
            `).join('');
        }
        function saveThresholds(){
            levels = levels.map((lv, idx) => ({
                ...lv,
                points: Math.max(0, parseInt(document.getElementById(`th-${idx}`).value,10)||0),
                multiplier: Math.max(1, parseFloat(document.getElementById(`mul-${idx}`).value)||1)
            }));
            saveLevels();
            buildThresholdTable();
            renderStudents();
            renderGroupGrid();
        }

        // H√†m render v·∫≠t ph·∫©m ƒë·ªïi qu√†
        function renderRewardsGrid() {
            const grid = document.getElementById('rewardsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))';
            grid.style.gap = '20px';

            levels.forEach(level => {
                const reward = rewardItems.find(r => r.level === level.name) || { itemName: 'Ch∆∞a c√†i ƒë·∫∑t', itemImage: '', description: '' };
                
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-name" style="margin-bottom:15px; text-align: center;">
                        <img src="${getLevelImage(level.name)}" alt="${level.name}" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 5px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span style="display: none;">${level.icon}</span>
                        ${level.name}
                    </div>
                    <div class="character-level">
                        <div class="character-image" style="background: ${level.color}">
                            ${reward.itemImage ? `<img src="${reward.itemImage}" alt="${reward.itemName}" style="width: 60px; height: 60px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                            <span style="${reward.itemImage ? 'display: none;' : ''} font-size: 2.5rem;">üéÅ</span>
                        </div>
                        <div class="level-name" style="margin-top: 15px; font-size: 1.1rem;">${reward.itemName}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 8px; text-align: center;">${reward.description}</div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 182, 193, 0.1)); border-radius: 12px;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">ƒêi·ªÉm y√™u c·∫ßu:</div>
                        <div style="font-size: 1.3rem; font-weight: bold; background: linear-gradient(135deg, #FFD700 0%, #FF6B9D 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            ${level.points} ƒëi·ªÉm
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // H√†m build editor cho v·∫≠t ph·∫©m ƒë·ªïi qu√†
        function buildRewardItemsEditor() {
            console.log('üîß buildRewardItemsEditor called');
            const editor = document.getElementById('rewardItemsEditor');
            if (!editor) {
                console.error('‚ùå rewardItemsEditor element not found!');
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y editor! Vui l√≤ng refresh trang.');
                return;
            }
            
            editor.innerHTML = '';
            console.log('üìã Building editor for', levels.length, 'levels');
            
            levels.forEach((level, idx) => {
                const reward = rewardItems.find(r => r.level === level.name) || { itemName: '', itemImage: '', description: '' };
                
                const container = document.createElement('div');
                container.style.cssText = `
                    background: white; 
                    padding: 20px; 
                    border-radius: 12px; 
                    margin-bottom: 20px; 
                    border: 3px solid ${level.color};
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                `;
                
                const header = document.createElement('div');
                header.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;';
                header.innerHTML = `
                    <img src="${getLevelImage(level.name)}" alt="${level.name}" style="width: 40px; height: 40px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display: none; font-size: 1.8rem;">${level.icon}</span>
                    <div style="font-weight: 800; color: #333; font-size: 1.2rem;">${level.name}</div>
                `;
                
                // T√™n v·∫≠t ph·∫©m
                const nameField = document.createElement('div');
                nameField.style.marginBottom = '15px';
                nameField.innerHTML = '<label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 1rem; color: #444;">üì¶ T√™n v·∫≠t ph·∫©m:</label>';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.id = `reward-name-${idx}`;
                nameInput.value = reward.itemName;
                nameInput.placeholder = 'VD: T√∫i g·∫°o 5kg, B·ªô b√∫t vi·∫øt cao c·∫•p...';
                nameInput.style.cssText = 'width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem; transition: border 0.3s;';
                nameInput.onfocus = function() { this.style.border = '2px solid #FFCA28'; };
                nameInput.onblur = function() { this.style.border = '2px solid #ddd'; };
                nameField.appendChild(nameInput);
                
                // URL h√¨nh ·∫£nh
                const imageField = document.createElement('div');
                imageField.style.marginBottom = '15px';
                imageField.innerHTML = '<label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 1rem; color: #444;">üñºÔ∏è H√¨nh ·∫£nh v·∫≠t ph·∫©m:</label>';
                
                // Container cho input v√† n√∫t
                const imageInputContainer = document.createElement('div');
                imageInputContainer.style.cssText = 'display: flex; gap: 10px; align-items: stretch;';
                
                const imageInput = document.createElement('input');
                imageInput.type = 'text';
                imageInput.id = `reward-image-${idx}`;
                imageInput.value = reward.itemImage;
                imageInput.placeholder = 'Nh·∫≠p URL ho·∫∑c ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh...';
                imageInput.style.cssText = 'flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 0.95rem; transition: border 0.3s;';
                imageInput.onfocus = function() { this.style.border = '2px solid #FFCA28'; };
                imageInput.onblur = function() { this.style.border = '2px solid #ddd'; };
                
                // Hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = `reward-file-${idx}`;
                fileInput.accept = 'image/png,image/jpeg,image/jpg,image/webp,image/gif';
                fileInput.style.display = 'none';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 500000) { // 500KB
                            alert('‚ö†Ô∏è ·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 500KB');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            imageInput.value = event.target.result;
                            // Update preview n·∫øu c√≥
                            const preview = document.getElementById(`preview-${idx}`);
                            if (preview) {
                                preview.src = event.target.result;
                                preview.style.display = 'block';
                            }
                            alert('‚úÖ ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng!');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                // Browse button
                const browseBtn = document.createElement('button');
                browseBtn.type = 'button';
                browseBtn.innerHTML = 'üìÅ Ch·ªçn ·∫£nh';
                browseBtn.style.cssText = 'background: linear-gradient(45deg, #42A5F5, #5dade2); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap; transition: all 0.3s;';
                browseBtn.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
                browseBtn.onmouseout = function() { this.style.transform = 'scale(1)'; };
                browseBtn.onclick = function() { fileInput.click(); };
                
                imageInputContainer.appendChild(imageInput);
                imageInputContainer.appendChild(browseBtn);
                imageInputContainer.appendChild(fileInput);
                imageField.appendChild(imageInputContainer);
                
                // Preview image
                const previewContainer = document.createElement('div');
                previewContainer.style.cssText = 'margin-top: 10px; text-align: center;';
                const previewImg = document.createElement('img');
                previewImg.id = `preview-${idx}`;
                previewImg.style.cssText = 'max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid #ddd; display: ' + (reward.itemImage ? 'block' : 'none') + '; margin: 0 auto;';
                if (reward.itemImage) {
                    previewImg.src = reward.itemImage;
                }
                previewContainer.appendChild(previewImg);
                imageField.appendChild(previewContainer);
                
                // M√¥ t·∫£
                const descField = document.createElement('div');
                descField.innerHTML = '<label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 1rem; color: #444;">üìù M√¥ t·∫£:</label>';
                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.id = `reward-desc-${idx}`;
                descInput.value = reward.description;
                descInput.placeholder = 'VD: T√∫i g·∫°o ST25 th∆°m ngon, ch·∫•t l∆∞·ª£ng cao';
                descInput.style.cssText = 'width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem; transition: border 0.3s;';
                descInput.onfocus = function() { this.style.border = '2px solid #FFCA28'; };
                descInput.onblur = function() { this.style.border = '2px solid #ddd'; };
                descField.appendChild(descInput);
                
                container.appendChild(header);
                container.appendChild(nameField);
                container.appendChild(imageField);
                container.appendChild(descField);
                editor.appendChild(container);
            });
            
            console.log('‚úÖ buildRewardItemsEditor completed -', levels.length, 'forms created');
        }

        // H√†m toggle hi·ªÉn th·ªã editor
        function toggleRewardEditor() {
            const container = document.getElementById('rewardEditorContainer');
            const btn = document.getElementById('toggleEditorBtn');
            
            if (container.style.display === 'none') {
                // Hi·ªÉn th·ªã editor
                container.style.display = 'block';
                btn.innerHTML = '‚ùå ƒê√≥ng ch·ªânh s·ª≠a';
                btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff8e8e)';
                buildRewardItemsEditor();
                
                // Scroll ƒë·∫øn editor
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                // ·∫®n editor
                container.style.display = 'none';
                btn.innerHTML = '‚úèÔ∏è Ch·ªânh s·ª≠a v·∫≠t ph·∫©m';
                btn.style.background = 'linear-gradient(45deg, #6bcf7f, #4ecdc4)';
            }
        }

        // H√†m l∆∞u v·∫≠t ph·∫©m ƒë·ªïi qu√†
        function saveRewardItems() {
            console.log('üíæ Saving reward items...');
            
            rewardItems = levels.map((level, idx) => {
                const name = document.getElementById(`reward-name-${idx}`)?.value || '';
                const image = document.getElementById(`reward-image-${idx}`)?.value || '';
                const desc = document.getElementById(`reward-desc-${idx}`)?.value || '';
                
                console.log(`üì¶ ${level.name}: ${name}`);
                
                return {
                    level: level.name,
                    itemName: name,
                    itemImage: image,
                    description: desc
                };
            });
            
            localStorage.setItem('rewardItems', JSON.stringify(rewardItems));
            console.log('‚úÖ Saved to localStorage');
            
            // Refresh grid
            renderRewardsGrid();
            
            // Th√¥ng b√°o th√†nh c√¥ng
            alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!\n\n' + 
                  'V·∫≠t ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.\n' +
                  'B·∫°n c√≥ th·ªÉ xem k·∫øt qu·∫£ ngay b√™n d∆∞·ªõi.');
            
            // ƒê√≥ng editor
            toggleRewardEditor();
        }

        // Toggle hi·ªÉn th·ªã section ƒê·ªïi ƒëi·ªÉm
        function toggleExchangePointsSection() {
            const section = document.getElementById('exchangePointsSection');
            const btn = document.getElementById('toggleExchangeBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.innerHTML = '‚ùå ƒê√≥ng ƒë·ªïi ƒëi·ªÉm';
                btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff8e8e)';
                renderExchangePointsTable();
                
                // Scroll ƒë·∫øn section
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                section.style.display = 'none';
                btn.innerHTML = 'üí∞ ƒê·ªïi ƒëi·ªÉm';
                btn.style.background = 'linear-gradient(45deg, #FFA726, #FFD54F)';
            }
        }

        // Render b·∫£ng danh s√°ch ƒë·ªïi ƒëi·ªÉm
        function renderExchangePointsTable() {
            const tbody = document.getElementById('exchangePointsTableBody');
            if (!tbody) return;
            
            // S·∫Øp x·∫øp h·ªçc sinh theo ƒëi·ªÉm t·ª´ cao ƒë·∫øn th·∫•p
            const sortedStudents = [...students].sort((a, b) => b.points - a.points);
            
            tbody.innerHTML = sortedStudents.map((student, index) => {
                const currentLevel = getCurrentLevel(student.points);
                
                // L·∫•y danh s√°ch qu√† m√† h·ªçc sinh c√≥ th·ªÉ ƒë·ªïi (ƒë·ªß ƒëi·ªÉm v√† kh√¥ng ph·∫£i 0 ƒëi·ªÉm)
                const availableRewards = levels
                    .filter(level => student.points >= level.points && level.points > 0) // Lo·∫°i b·ªè qu√† c√≥ 0 ƒëi·ªÉm
                    .map(level => {
                        const reward = rewardItems.find(r => r.level === level.name);
                        return { level: level.name, points: level.points, reward };
                    })
                    .sort((a, b) => b.points - a.points); // S·∫Øp x·∫øp t·ª´ ƒëi·ªÉm cao xu·ªëng th·∫•p
                
                return `
                    <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" 
                        onmouseover="this.style.background='#f8f9fa'" 
                        onmouseout="this.style.background='white'"
                        id="exchange-row-${student.id}">
                        <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #FFA726; border: 1px solid #eee; width: 50px;">
                            ${index + 1}
                        </td>
                        <td style="padding: 12px 8px; font-weight: 600; border: 1px solid #eee; width: 120px;">
                            ${student.name}
                        </td>
                        <td style="padding: 12px 8px; text-align: center; border: 1px solid #eee; width: 100px;">
                            <span style="background: ${currentLevel.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                ${currentLevel.name}
                            </span>
                        </td>
                        <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: ${getPointColor(student.points)}; border: 1px solid #eee; width: 80px;">
                            ${student.points}
                        </td>
                        <td style="padding: 12px 8px; border: 1px solid #eee; width: 500px;">
                            <div id="rewards-container-${student.id}" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 8px; max-height: 150px; overflow-y: auto;">
                                ${availableRewards.length > 0 ? availableRewards.map(({ level, points, reward }) => `
                                    <label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; cursor: pointer; border-radius: 6px; background: white; border: 1px solid #ddd; transition: all 0.2s; white-space: nowrap;" 
                                           onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#FFA726'" 
                                           onmouseout="this.style.background='white'; this.style.borderColor='#ddd'">
                                        <input type="checkbox" 
                                               id="reward-checkbox-${student.id}-${level}" 
                                               value="${level}" 
                                               data-points="${points}"
                                               onchange="updateExchangeInfo(${student.id})"
                                               style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                                        <span style="font-size: 0.85rem;">
                                            ${reward ? reward.itemName : level}
                                            <span style="color: #FFA726; font-weight: 600;">(${points})</span>
                                        </span>
                                    </label>
                                `).join('') : '<div style="text-align: center; color: #999; font-size: 0.85rem; padding: 8px; width: 100%;">Kh√¥ng c√≥ qu√† ƒë·ªÉ ƒë·ªïi</div>'}
                            </div>
                        </td>
                        <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #FFA726; border: 1px solid #eee; width: 100px;"
                            id="total-points-${student.id}">
                            0
                        </td>
                        <td style="padding: 12px 8px; text-align: center; border: 1px solid #eee; width: 100px;">
                            <button onclick="executeExchangePoints(${student.id})" 
                                    id="exchange-btn-${student.id}"
                                    style="background: linear-gradient(45deg, #FFA726, #FFD54F); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;"
                                    disabled>
                                ƒê·ªïi
                            </button>
                        </td>
                        <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #333; border: 1px solid #eee; width: 100px;"
                            id="remaining-points-${student.id}">
                            ${student.points}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // C·∫≠p nh·∫≠t th√¥ng tin ƒë·ªïi qu√† khi ch·ªçn qu√†
        function updateExchangeInfo(studentId) {
            const button = document.getElementById(`exchange-btn-${studentId}`);
            const remainingPointsCell = document.getElementById(`remaining-points-${studentId}`);
            const totalPointsCell = document.getElementById(`total-points-${studentId}`);
            
            if (!button || !remainingPointsCell || !totalPointsCell) return;
            
            // L·∫•y t·∫•t c·∫£ checkbox ƒë∆∞·ª£c ch·ªçn
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][id^="reward-checkbox-${studentId}-"]:checked`);
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            if (checkboxes.length > 0) {
                // T√≠nh t·ªïng ƒëi·ªÉm c·ªßa c√°c qu√† ƒë√£ ch·ªçn
                let totalPoints = 0;
                checkboxes.forEach(checkbox => {
                    const points = parseInt(checkbox.dataset.points) || 0;
                    totalPoints += points;
                });
                
                const remainingPoints = student.points - totalPoints;
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
                totalPointsCell.textContent = totalPoints;
                remainingPointsCell.textContent = remainingPoints;
                remainingPointsCell.style.color = remainingPoints >= 0 ? '#333' : '#f44336';
                button.disabled = remainingPoints < 0; // Disable n·∫øu kh√¥ng ƒë·ªß ƒëi·ªÉm
            } else {
                // Kh√¥ng c√≥ qu√† n√†o ƒë∆∞·ª£c ch·ªçn
                totalPointsCell.textContent = '0';
                remainingPointsCell.textContent = student.points;
                remainingPointsCell.style.color = '#333';
                button.disabled = true;
            }
        }

        // Th·ª±c hi·ªán ƒë·ªïi ƒëi·ªÉm
        function executeExchangePoints(studentId) {
            // L·∫•y t·∫•t c·∫£ checkbox ƒë∆∞·ª£c ch·ªçn
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][id^="reward-checkbox-${studentId}-"]:checked`);
            
            if (checkboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt qu√† ƒë·ªÉ ƒë·ªïi!');
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert('Kh√¥ng t√¨m th·∫•y h·ªçc sinh!');
                return;
            }
            
            // T√≠nh t·ªïng ƒëi·ªÉm v√† l·∫•y danh s√°ch qu√† ƒë√£ ch·ªçn
            let totalPointsRequired = 0;
            const selectedRewards = [];
            
            checkboxes.forEach(checkbox => {
                const level = checkbox.value;
                const points = parseInt(checkbox.dataset.points) || 0;
                totalPointsRequired += points;
                
                const reward = rewardItems.find(r => r.level === level);
                const rewardName = reward ? reward.itemName : level;
                selectedRewards.push({ name: rewardName, points, level });
            });
            
            if (student.points < totalPointsRequired) {
                alert(`H·ªçc sinh kh√¥ng ƒë·ªß ƒëi·ªÉm! C·∫ßn ${totalPointsRequired} ƒëi·ªÉm nh∆∞ng ch·ªâ c√≥ ${student.points} ƒëi·ªÉm.`);
                return;
            }
            
            const rewardNames = selectedRewards.map(r => r.name).join(', ');
            
            // Tr·ª´ ƒëi·ªÉm
            student.points -= totalPointsRequired;
            
            // L∆∞u v√†o l·ªãch s·ª≠ cho m·ªói qu√† (ho·∫∑c m·ªôt b·∫£n ghi t·ªïng h·ª£p)
            if (!student.history) student.history = [];
            
            // T·∫°o m·ªôt b·∫£n ghi l·ªãch s·ª≠ cho t·∫•t c·∫£ qu√† ƒë·ªïi c√πng l√∫c
            student.history.push({
                date: new Date().toISOString(),
                points: -totalPointsRequired,
                total: student.points,
                reason: `ƒê·ªïi qu√†: ${rewardNames}`
            });
            
            // L∆∞u v√†o l·ªãch s·ª≠ chung
            addToHistory(studentId, student.name, -totalPointsRequired, student.points, 'exchange');
            
            // L∆∞u d·ªØ li·ªáu
            saveStudents();
            
            // C·∫≠p nh·∫≠t giao di·ªán
            renderExchangePointsTable();
            renderStudents();
            renderGroupGrid();
            renderTopStudents();
            updateHomeStats();
            
            // Ph√°t √¢m thanh
            playGameSound('success');
        }

        function handleAddMultipleGroups(textareaId){
            const ta = document.getElementById(textareaId);
            const names = (ta?.value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
            if (!ta) return; if (names.length===0) return alert('Nh·∫≠p √≠t nh·∫•t 1 t√™n nh√≥m.');
            names.forEach(n => { groups.push({ id: Date.now()+Math.random(), name:n, studentIds: [] }); });
            saveGroups(); ta.value=''; renderGroupSelects(); renderGroupGrid(); renderGroupsGrid();
        }

        // Modal th√™m nh√≥m
        function showAddGroupModal() {
            document.getElementById('addGroupModal').style.display = 'flex';
        }

        function closeAddGroupModal() {
            document.getElementById('addGroupModal').style.display = 'none';
            document.getElementById('newGroupName').value = '';
        }

        function populateStudentSelection() {
            const container = document.getElementById('studentSelectionList');
            container.innerHTML = '';
            
            // L·∫•y danh s√°ch h·ªçc sinh ƒë√£ c√≥ trong nh√≥m
            const studentsInGroups = new Set();
            groups.forEach(group => {
                group.studentIds.forEach(id => studentsInGroups.add(id));
            });
            
            students.forEach(student => {
                const isInGroup = studentsInGroups.has(student.id);
                const div = document.createElement('div');
                div.style.cssText = `display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; margin-bottom: 5px; background: ${isInGroup ? '#ffebee' : '#f8f9fa'}; opacity: ${isInGroup ? '0.6' : '1'};`;
                div.innerHTML = `
                    <input type="checkbox" id="student-${student.id}" value="${student.id}" style="transform: scale(1.2);" ${isInGroup ? 'disabled' : ''}>
                    <label for="student-${student.id}" style="flex: 1; cursor: pointer; font-weight: 500; color: ${isInGroup ? '#999' : '#333'};">${student.name}${isInGroup ? ' (ƒë√£ c√≥ nh√≥m)' : ''}</label>
                `;
                container.appendChild(div);
            });
        }

        function createNewGroup() {
            const textarea = document.getElementById('newGroupName');
            const names = (textarea?.value || '').split(/\n+/).map(s => s.trim()).filter(Boolean);
            
            if (!textarea || names.length === 0) {
                alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t√™n nh√≥m.');
                return;
            }

            // Ki·ªÉm tra t√™n nh√≥m tr√πng
            const duplicateNames = [];
            names.forEach(name => {
                if (groups.some(g => g.name.toLowerCase() === name.toLowerCase())) {
                    duplicateNames.push(name);
                }
            });

            if (duplicateNames.length > 0) {
                alert(`C√°c t√™n nh√≥m sau ƒë√£ t·ªìn t·∫°i: ${duplicateNames.join(', ')}. Vui l√≤ng ch·ªçn t√™n kh√°c.`);
                return;
            }

            // T·∫°o c√°c nh√≥m m·ªõi
            names.forEach(name => {
                const newGroup = {
                    id: Date.now() + Math.random(),
                    name: name,
                    studentIds: [],
                    points: 0
                };
                groups.push(newGroup);
            });

            saveGroups();
            renderGroupsGrid();
            renderGroupSelects();
            closeAddGroupModal();
            alert(`ƒê√£ t·∫°o ${names.length} nh√≥m th√†nh c√¥ng!`);
        }

        // Modal x√≥a nh√≥m
        function showDeleteGroupModal() {
            document.getElementById('deleteGroupModal').style.display = 'flex';
            populateDeleteGroupSelect();
        }

        function closeDeleteGroupModal() {
            document.getElementById('deleteGroupModal').style.display = 'none';
            document.getElementById('deleteGroupSelect').value = '';
        }

        function populateDeleteGroupSelect() {
            const select = document.getElementById('deleteGroupSelect');
            select.innerHTML = '<option value="">Ch·ªçn nh√≥m...</option>';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                select.appendChild(option);
            });
        }

        function deleteSelectedGroup() {
            const groupId = parseInt(document.getElementById('deleteGroupSelect').value);
            if (!groupId) {
                alert('Vui l√≤ng ch·ªçn nh√≥m ƒë·ªÉ x√≥a.');
                return;
            }

            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√≥m n√†y?')) {
                groups = groups.filter(g => g.id !== groupId);
                saveGroups();
                renderGroupsGrid();
                closeDeleteGroupModal();
                alert('ƒê√£ x√≥a nh√≥m th√†nh c√¥ng!');
            }
        }

        // Ch·ªçn nhi·ªÅu nh√≥m
        let isSelectGroupsMode = false;

        function toggleSelectGroups() {
            isSelectGroupsMode = !isSelectGroupsMode;
            const btn = document.getElementById('selectGroupsBtn');
            const selectAllBtn = document.getElementById('selectAllGroupsBtn');
            const controls = document.getElementById('groupBulkControls');
            
            if (isSelectGroupsMode) {
                btn.textContent = 'H·ªßy ch·ªçn';
                btn.style.background = 'linear-gradient(45deg, #ff4757, #ff6b6b)';
                selectAllBtn.style.display = 'block';
                controls.style.display = 'flex';
            } else {
                btn.textContent = 'Ch·ªçn nhi·ªÅu';
                btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff8e8e)';
                selectAllBtn.style.display = 'none';
                controls.style.display = 'none';
                // B·ªè ch·ªçn t·∫•t c·∫£
                document.querySelectorAll('.group-select').forEach(cb => cb.checked = false);
            }
            // Render l·∫°i danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã/·∫©n checkbox
            renderGroupsGrid();
        }

        function selectAllGroups() {
            document.querySelectorAll('.group-select').forEach(cb => cb.checked = true);
        }

        function addPointsToSelectedGroups() {
            const points = parseInt(document.getElementById('groupBulkPoints').value) || 1;
            const selectedCheckboxes = document.querySelectorAll('.group-select:checked');
            const selectedGroups = Array.from(selectedCheckboxes)
                .map(cb => parseInt(cb.id.replace('group-select-', '')));
            
            if (selectedGroups.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m.');
                return;
            }
            
            pushUndo();
            selectedGroups.forEach(groupId => {
                addPointsToGroup(points, groupId);
            });
            renderGroupsGrid();
            // Ph√°t √¢m thanh khi c·ªông ƒëi·ªÉm cho nhi·ªÅu nh√≥m
            playGameSound('success');
            // B·ªè t√≠ch t·∫•t c·∫£ c√°c checkbox ƒë√£ ch·ªçn
            selectedCheckboxes.forEach(cb => cb.checked = false);
        }

        function subtractPointsFromSelectedGroups() {
            const points = parseInt(document.getElementById('groupBulkPoints').value) || 1;
            const selectedCheckboxes = document.querySelectorAll('.group-select:checked');
            const selectedGroups = Array.from(selectedCheckboxes)
                .map(cb => parseInt(cb.id.replace('group-select-', '')));
            
            if (selectedGroups.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m.');
                return;
            }
            
            pushUndo();
            selectedGroups.forEach(groupId => {
                addPointsToGroup(-points, groupId);
            });
            renderGroupsGrid();
            // Ph√°t √¢m thanh khi tr·ª´ ƒëi·ªÉm cho nhi·ªÅu nh√≥m
            playGameSound('click');
            // B·ªè t√≠ch t·∫•t c·∫£ c√°c checkbox ƒë√£ ch·ªçn
            selectedCheckboxes.forEach(cb => cb.checked = false);
        }

        function deleteSelectedGroups() {
            const selectedGroups = Array.from(document.querySelectorAll('.group-select:checked'))
                .map(cb => parseInt(cb.id.replace('group-select-', '')));
            
            if (selectedGroups.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m ƒë·ªÉ x√≥a.');
                return;
            }
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedGroups.length} nh√≥m ƒë√£ ch·ªçn?`)) {
                groups = groups.filter(g => !selectedGroups.includes(g.id));
                saveGroups();
                renderGroupsGrid();
                alert('ƒê√£ x√≥a nh√≥m th√†nh c√¥ng!');
            }
        }

        // Kh·ªüi t·∫°o trang
        // Th·ªëng k√™ v√† hi·ªÉn th·ªã
        function updateStats() {
            const totalStudents = students.length;
            const avgPoints = totalStudents > 0 ? Math.round(students.reduce((sum, s) => sum + s.points, 0) / totalStudents) : 0;
            const excellentStudents = students.filter(s => getCurrentLevel(s.points).name === 'Vua').length;
            const classProgress = totalStudents > 0 ? Math.round(students.reduce((sum, s) => sum + getProgressPercentage(s.points), 0) / totalStudents) : 0;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('avgPoints').textContent = avgPoints;
            document.getElementById('excellentStudents').textContent = excellentStudents;
            document.getElementById('classProgress').textContent = classProgress;
            document.getElementById('progressSlider').value = classProgress;
        }

        function renderMembersList() {
            const membersList = document.getElementById('membersList');
            if (!membersList) return;
            
            const topStudents = students
                .sort((a, b) => b.points - a.points)
                .slice(0, 5);
            
            membersList.innerHTML = topStudents.map((student, index) => `
                <div class="member">
                    <div class="member-avatar">${student.name.charAt(0).toUpperCase()}</div>
                    <div class="member-name">${student.name}</div>
                </div>
            `).join('');
        }

        function renderAllStudentsList() {
            const allStudentsList = document.getElementById('allStudentsList');
            if (!allStudentsList) return;
            
            // S·∫Øp x·∫øp theo t·ª´ cu·ªëi c·ªßa t√™n
            const sortedStudents = [...students].sort(sortStudentsByLastName);
            
            allStudentsList.innerHTML = sortedStudents.map(student => {
                const level = getCurrentLevel(student.points);
                return `
                    <div class="member" style="margin-bottom: 8px;">
                        <div class="member-avatar" style="background: ${level.color};">
                            <img src="${getLevelImage(level.name)}" alt="${level.name}" style="width: 30px; height: 30px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <span style="display: none;">${level.icon}</span>
                        </div>
                        <div class="member-info">
                            <div class="member-name">${student.name}</div>
                            <div class="member-level">${level.name} - <span style="color: ${getPointColor(student.points)}; font-weight: bold;">${student.points} ƒëi·ªÉm</span></div>
                        </div>
                        <div class="member-rank-icon">${level.icon}</div>
                    </div>
                `;
            }).join('');
        }

        function renderGroupsGrid() {
            const groupsGrid = document.getElementById('groupsGrid');
            if (!groupsGrid) return;
            
            groupsGrid.innerHTML = groups.map(group => `
                <div class="my-device-card pink" onclick="selectGroup(${group.id})">
                    <div class="my-device-info">
                        <div class="my-device-icon">üë•</div>
                        <div class="my-device-name">${group.name}</div>
                    </div>
                    <div class="toggle-switch"></div>
                </div>
            `).join('');
        }

        function selectGroup(groupId) {
            const groupSelect = document.getElementById('groupActionSelect');
            if (groupSelect) {
                groupSelect.value = groupId;
                renderGroupGrid();
            }
        }

        // Ch·ªçn nhi·ªÅu h·ªçc sinh
        let isSelectMultipleMode = false;

        function toggleSelectMultiple() {
            isSelectMultipleMode = !isSelectMultipleMode;
            const btn = document.getElementById('selectMultipleBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const controls = document.getElementById('bulkControls');
            
            if (isSelectMultipleMode) {
                btn.textContent = 'H·ªßy ch·ªçn';
                btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff8e8e)';
                selectAllBtn.style.display = 'block';
                controls.style.display = 'flex';
            } else {
                btn.textContent = 'Ch·ªçn nhi·ªÅu';
                btn.style.background = 'linear-gradient(45deg, #6bcf7f, #4ecdc4)';
                selectAllBtn.style.display = 'none';
                controls.style.display = 'none';
                // B·ªè ch·ªçn t·∫•t c·∫£
                document.querySelectorAll('.student-select').forEach(cb => cb.checked = false);
            }
            // Render l·∫°i danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã/·∫©n checkbox
            renderStudents();
        }

        function selectAllStudents() {
            document.querySelectorAll('.student-select').forEach(cb => cb.checked = true);
        }

        function addPointsToSelected() {
            const points = parseInt(document.getElementById('bulkPoints').value) || 1;
            const selectedStudents = Array.from(document.querySelectorAll('.student-select:checked'))
                .map(cb => parseInt(cb.id.replace('student-select-', '')));
            
            if (selectedStudents.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh.');
                return;
            }
            
            pushUndo();
            const levelUpStudents = []; // L∆∞u danh s√°ch h·ªçc sinh l√™n c·∫•p
            selectedStudents.forEach(id => {
                const student = students.find(s => s.id === id);
                if (student) {
                    // L∆∞u level tr∆∞·ªõc khi c·ªông ƒëi·ªÉm
                    const oldLevel = getCurrentLevel(student.points);
                    const currentLevel = getCurrentLevel(student.points);
                    const adjusted = Math.round(points * (currentLevel.multiplier || 1));
                    
                    // C·ªông ƒëi·ªÉm
                    student.points = student.points + adjusted;
                    
                    // Ki·ªÉm tra level sau khi c·ªông ƒëi·ªÉm
                    const newLevel = getCurrentLevel(student.points);
                    
                    // Ki·ªÉm tra xem c√≥ l√™n c·∫•p kh√¥ng
                    if (oldLevel.name !== newLevel.name) {
                        levelUpStudents.push({ id: id, name: student.name, newLevel: newLevel.name });
                    }
                    
                    // L∆∞u v√†o l·ªãch s·ª≠
                    addToHistory(id, student.name, adjusted, student.points, 'bulk');
                }
            });
            saveStudents();
            renderStudents();
            renderGroupGrid();
            updateHomeStats();
            
            // Ph√°t √¢m thanh khi c·ªông ƒëi·ªÉm cho nhi·ªÅu h·ªçc sinh
            playGameSound('success');
            
            // Hi·ªÉn th·ªã th√¥ng b√°o ch√∫c m·ª´ng cho h·ªçc sinh l√™n c·∫•p
            if (levelUpStudents.length > 0) {
                playGameSound('levelup');
                showMultipleLevelUpNotifications(levelUpStudents);
            }
            // Highlight ƒëi·ªÉm c·ªßa c√°c h·ªçc sinh ƒë√£ ch·ªçn - ƒë·ª£i DOM render xong
            requestAnimationFrame(() => {
                setTimeout(() => {
                    selectedStudents.forEach(id => {
                        const element = document.getElementById(`points-${id}`);
                        if (element) {
                            highlightPoints(`points-${id}`);
                        }
                    });
                }, 50);
            });
        }

        function subtractPointsFromSelected() {
            const points = parseInt(document.getElementById('bulkPoints').value) || 1;
            const selectedStudents = Array.from(document.querySelectorAll('.student-select:checked'))
                .map(cb => parseInt(cb.id.replace('student-select-', '')));
            
            if (selectedStudents.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh.');
                return;
            }
            
            pushUndo();
            selectedStudents.forEach(id => {
                const student = students.find(s => s.id === id);
                if (student) {
                    const currentLevel = getCurrentLevel(student.points);
                    const adjusted = Math.round(points * (currentLevel.multiplier || 1));
                    student.points = student.points - adjusted;
                    // L∆∞u v√†o l·ªãch s·ª≠ (ƒëi·ªÉm √¢m)
                    addToHistory(id, student.name, -adjusted, student.points, 'bulk');
                }
            });
            saveStudents();
            renderStudents();
            renderGroupGrid();
            updateHomeStats();
            // Ph√°t √¢m thanh khi tr·ª´ ƒëi·ªÉm cho nhi·ªÅu h·ªçc sinh
            playGameSound('click');
            // Highlight ƒëi·ªÉm c·ªßa c√°c h·ªçc sinh ƒë√£ ch·ªçn - ƒë·ª£i DOM render xong
            requestAnimationFrame(() => {
                setTimeout(() => {
                    selectedStudents.forEach(id => {
                        const element = document.getElementById(`points-${id}`);
                        if (element) {
                            highlightPoints(`points-${id}`);
                        }
                    });
                }, 50);
            });
        }

        // C√°c h√†m m·ªõi cho trang ch·ªß
        function updateHomeStats() {
            console.log('updateHomeStats called');
            const totalStudents = students.length;
            const levelCounts = {
                'D√¢n th∆∞·ªùng': 0,
                'L√≠nh': 0,
                'Quan': 0,
                'T·ªÉ t∆∞·ªõng': 0,
                'Vua': 0
            };
            
            students.forEach(student => {
                const level = getCurrentLevel(student.points);
                levelCounts[level.name]++;
            });
            
            console.log('Level counts:', levelCounts);
            
            const totalEl = document.getElementById('totalStudents');
            const commonEl = document.getElementById('commonStudents');
            const soldierEl = document.getElementById('soldierStudents');
            const officialEl = document.getElementById('officialStudents');
            const primeEl = document.getElementById('primeStudents');
            const kingEl = document.getElementById('kingStudents');
            
            if (totalEl) totalEl.textContent = totalStudents;
            if (commonEl) commonEl.textContent = levelCounts['D√¢n th∆∞·ªùng'];
            if (soldierEl) soldierEl.textContent = levelCounts['L√≠nh'];
            if (officialEl) officialEl.textContent = levelCounts['Quan'];
            if (primeEl) primeEl.textContent = levelCounts['T·ªÉ t∆∞·ªõng'];
            if (kingEl) kingEl.textContent = levelCounts['Vua'];
        }

        function renderTopStudents() {
            const topStudentsList = document.getElementById('topStudentsList');
            const topStudents = students
                .sort((a, b) => b.points - a.points)
                .slice(0, 5);
            
            topStudentsList.innerHTML = topStudents.map((student, index) => {
                const level = getCurrentLevel(student.points);
                return `
                    <div class="member">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFA726; min-width: 30px; text-align: center;">${index + 1}</div>
                        <div class="member-avatar" style="background: ${level.color}; overflow: hidden;">
                            <img src="${getLevelImage(level.name)}" alt="${level.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <span style="display: none;">${level.icon}</span>
                        </div>
                        <div class="member-info">
                            <div class="member-name">${student.name}</div>
                            <div class="member-level">${level.name} - ${student.points} ƒëi·ªÉm</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTopGroups() {
            const topGroupsList = document.getElementById('topGroupsList');
            const groupStats = groups.map(group => {
                // ƒê·∫£m b·∫£o nh√≥m c√≥ tr∆∞·ªùng points (t∆∞∆°ng th√≠ch v·ªõi d·ªØ li·ªáu c≈©)
                if (typeof group.points === 'undefined') {
                    group.points = 0;
                }
                const members = students.filter(s => group.studentIds.includes(s.id));
                // X√°c ƒë·ªãnh level nh√≥m d·ª±a tr√™n c·∫•p b·∫≠c c·ªßa th√†nh vi√™n c√≥ c·∫•p b·∫≠c cao nh·∫•t trong nh√≥m
                const topMember = members.sort((a, b) => {
                    const levelA = getCurrentLevel(a.points);
                    const levelB = getCurrentLevel(b.points);
                    // So s√°nh theo ƒëi·ªÉm y√™u c·∫ßu c·ªßa c·∫•p b·∫≠c (c·∫•p b·∫≠c cao h∆°n = ƒëi·ªÉm y√™u c·∫ßu cao h∆°n)
                    return levelB.points - levelA.points;
                })[0];
                const groupLevel = topMember ? getCurrentLevel(topMember.points) : levels[0];
                return { ...group, memberCount: members.length, groupLevel };
            }).sort((a, b) => (b.points || 0) - (a.points || 0)).slice(0, 3);
            
            topGroupsList.innerHTML = groupStats.map((group, index) => `
                <div class="member">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #FFA726; min-width: 30px; text-align: center;">${index + 1}</div>
                    <div class="member-avatar" style="background: ${group.groupLevel.color}; overflow: hidden;">
                        <img src="data/nhom4.png" alt="Nh√≥m 4" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span style="display: none;">üë•</span>
                    </div>
                    <div class="member-info">
                        <div class="member-name">${group.name}</div>
                        <div class="member-level">${group.groupLevel.name} - ${Math.round(group.points || 0)} ƒëi·ªÉm</div>
                    </div>
                </div>
            `).join('');
        }

        // H·ªçc sinh compact
        function renderStudentsCompact() {
            console.log('renderStudentsCompact called');
            const grid = document.getElementById('studentGrid');
            if (!grid) {
                console.error('studentGrid not found');
                return;
            }
            grid.innerHTML = '';

            // S·∫Øp x·∫øp theo t·ª´ cu·ªëi c·ªßa t√™n
            const sortedStudents = [...students].sort(sortStudentsByLastName);
            console.log('Students to render:', sortedStudents.length);

            sortedStudents.forEach(student => {
                const currentLevel = getCurrentLevel(student.points);
                const progress = getProgressPercentage(student.points);
                console.log('Rendering student:', student.name, 'points:', student.points, 'level:', currentLevel.name);

                const studentCard = document.createElement('div');
                studentCard.className = 'student-card-compact';
                if (isSelectMultipleMode) {
                    studentCard.style.cursor = 'pointer';
                    // Th√™m s·ª± ki·ªán click v√†o th·∫ª ƒë·ªÉ toggle checkbox
                    studentCard.onclick = function(e) {
                        // Kh√¥ng toggle n·∫øu click v√†o checkbox ho·∫∑c button
                        if (e.target.type === 'checkbox' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                            return;
                        }
                        const checkbox = document.getElementById(`student-select-${student.id}`);
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    };
                }
                studentCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        ${isSelectMultipleMode ? `<input type="checkbox" id="student-select-${student.id}" class="student-select" style="width: 24px; height: 24px; cursor: pointer; transform: scale(1.3);" />` : ''}
                        <div class="student-name-compact" style="flex: 1;">${student.name}</div>
                    </div>
                    <div style="text-align: center; margin-bottom: 10px;">
                        <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid ${currentLevel.color}; background: ${currentLevel.color}; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span style="display: none; font-size: 2rem;">${currentLevel.icon}</span>
                    </div>
                    <div class="student-level-compact" style="text-align: center; font-weight: bold; margin-bottom: 8px;">${currentLevel.name}</div>
                    <div id="points-${student.id}" style="font-size: 1.2rem; font-weight: bold; color: #FFA726; margin: 8px 0; text-align: center; ${isSelectMultipleMode ? 'cursor: pointer;' : ''}" ${isSelectMultipleMode ? `onclick="if(event.target.closest('button') === null && event.target.closest('input') === null) { const cb = document.getElementById('student-select-${student.id}'); if(cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); } }"` : ''}>${student.points} ƒëi·ªÉm</div>
                    <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; margin: 10px 0; ${isSelectMultipleMode ? 'cursor: pointer;' : ''}" ${isSelectMultipleMode ? `onclick="if(event.target.closest('button') === null && event.target.closest('input') === null) { const cb = document.getElementById('student-select-${student.id}'); if(cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); } }"` : ''}>
                        <div style="width: ${progress}%; height: 100%; background: ${getLevelGradient(currentLevel.name)}; border-radius: 4px;"></div>
                    </div>
                    <div class="student-controls-compact">
                        <input type="number" id="compact-amount-${student.id}" value="1" min="1" step="1" style="width: 70px; padding: 4px; border-radius: 6px; border: 1px solid #eee; text-align: center; font-size: 0.8rem; background: white; cursor: text;" onfocus="console.log('Input focused:', ${student.id})" onchange="console.log('Input changed:', ${student.id}, this.value)" onclick="console.log('Input clicked:', ${student.id})" />
                        <button class="btn-compact subtract" onclick="applyCompactAmount(${student.id}, false)">‚àí</button>
                        <button class="btn-compact add" onclick="applyCompactAmount(${student.id}, true)">+</button>
                    </div>
                `;
                grid.appendChild(studentCard);
            });
            console.log('renderStudentsCompact completed');
        }

        // Nh√≥m v·ªõi c·∫•p b·∫≠c
        function renderGroupsGrid() {
            const groupsGrid = document.getElementById('groupsGrid');
            if (!groupsGrid) return;
            
            // Thay ƒë·ªïi CSS ƒë·ªÉ hi·ªÉn th·ªã 5 nh√≥m m·ªói d√≤ng
            groupsGrid.style.display = 'grid';
            groupsGrid.style.gridTemplateColumns = 'repeat(5, 1fr)';
            groupsGrid.style.gap = '20px';
            groupsGrid.innerHTML = '';

            groups.forEach(group => {
                // ƒê·∫£m b·∫£o nh√≥m c√≥ tr∆∞·ªùng points (t∆∞∆°ng th√≠ch v·ªõi d·ªØ li·ªáu c≈©)
                if (typeof group.points === 'undefined') {
                    group.points = 0;
                }
                const members = students.filter(s => group.studentIds.includes(s.id));
                // X√°c ƒë·ªãnh level nh√≥m d·ª±a tr√™n c·∫•p b·∫≠c c·ªßa th√†nh vi√™n c√≥ c·∫•p b·∫≠c cao nh·∫•t trong nh√≥m
                const topMember = members.sort((a, b) => {
                    const levelA = getCurrentLevel(a.points);
                    const levelB = getCurrentLevel(b.points);
                    // So s√°nh theo ƒëi·ªÉm y√™u c·∫ßu c·ªßa c·∫•p b·∫≠c (c·∫•p b·∫≠c cao h∆°n = ƒëi·ªÉm y√™u c·∫ßu cao h∆°n)
                    return levelB.points - levelA.points;
                })[0];
                const groupLevel = topMember ? getCurrentLevel(topMember.points) : levels[0];

                const groupCard = document.createElement('div');
                groupCard.className = 'group-card-fixed';
                groupCard.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                    min-height: 150px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    transition: transform 0.3s ease;
                    cursor: pointer;
                    position: relative;
                `;
                
                // Th√™m s·ª± ki·ªán click v√†o th·∫ª
                if (isSelectingGroups) {
                    groupCard.onclick = function(e) {
                        // Kh√¥ng toggle n·∫øu click v√†o checkbox
                        if (e.target.type === 'checkbox' || e.target.closest('input[type="checkbox"]')) {
                            return;
                        }
                        toggleGroupSelection(group.id);
                    };
                } else {
                    groupCard.onclick = function(e) {
                        // Kh√¥ng m·ªü modal n·∫øu click v√†o checkbox
                        if (e.target.type === 'checkbox' || e.target.closest('input[type="checkbox"]')) {
                            return;
                        }
                        showGroupStudentsModal(group.id);
                    };
                }
                
                groupCard.innerHTML = `
                        ${isSelectingGroups ? `
                        <div style="position: absolute; top: 10px; right: 10px;">
                            <input type="checkbox" ${selectedGroups.has(group.id) ? 'checked' : ''} 
                                   onchange="toggleGroupSelection(${group.id})" 
                                   onclick="event.stopPropagation();"
                                   style="width: 24px; height: 24px; cursor: pointer; transform: scale(1.3);" />
                        </div>
                        ` : ''}
                    <div style="text-align: center; width: 100%;">
                        <div style="font-size: 1.5rem; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px;">Nh√≥m ${group.name}</div>
                        <div id="group-points-${group.id}" style="font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, #FFA726 0%, #FF6B9D 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px;">${Math.round(group.points || 0)} ƒëi·ªÉm</div>
                        <div style="display: flex; justify-content: center; align-items: center; margin-top: 10px; margin-bottom: 15px;">
                            <img src="${getLevelImage(groupLevel.name)}" alt="${groupLevel.name}" style="width: 78px; height: 78px; border-radius: 50%; border: 3px solid ${groupLevel.color}; background: ${groupLevel.color}; padding: 3px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <span style="display: none; font-size: 3rem;">${groupLevel.icon}</span>
                    </div>
                    ${!isSelectingGroups ? `
                            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 10px;">
                                <button class="btn-compact subtract" onclick="addPointsToGroup(-parseInt(document.getElementById('group-amount-${group.id}').value) || 1, ${group.id}); event.stopPropagation();" style="order: 1;">‚àí</button>
                                <input type="number" id="group-amount-${group.id}" value="1" min="1" style="width: 90px; padding: 9px 8px; border-radius: 6px; border: 1px solid #eee; text-align: center; font-size: 1.125rem; order: 2;" onclick="event.stopPropagation();" />
                                <button class="btn-compact add" onclick="addPointsToGroup(parseInt(document.getElementById('group-amount-${group.id}').value) || 1, ${group.id}); event.stopPropagation();" style="order: 3;">+</button>
                        </div>
                                        ` : ''}
                                    </div>
                `;
                groupsGrid.appendChild(groupCard);
            });
        }

        // H√†m th√™m h·ªçc sinh v√†o nh√≥m
        function addStudentToGroup(groupId) {
            const select = document.getElementById(`student-select-${groupId}`);
            const studentId = parseInt(select.value);
            
            if (!studentId) {
                return;
            }
            
            // Ki·ªÉm tra h·ªçc sinh ƒë√£ c√≥ trong nh√≥m kh√°c ch∆∞a
            const allAssignedStudentIds = groups.flatMap(g => g.studentIds);
            if (allAssignedStudentIds.includes(studentId)) {
                return;
            }
            
            const group = groups.find(g => g.id === groupId);
            if (group && !group.studentIds.includes(studentId)) {
                group.studentIds.push(studentId);
                saveGroups();
                renderGroupsGrid();
                updateHomeStats();
            }
        }

        // H√†m x√≥a h·ªçc sinh kh·ªèi nh√≥m
        function removeStudentFromGroup(groupId, studentId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.studentIds = group.studentIds.filter(id => id !== studentId);
                saveGroups();
                renderGroupsGrid(); // Render l·∫°i t·∫•t c·∫£ nh√≥m ƒë·ªÉ c·∫≠p nh·∫≠t dropdown
                updateHomeStats();
            }
        }

        // Bi·∫øn l∆∞u groupId hi·ªán t·∫°i ƒëang m·ªü
        let currentGroupId = null;

        // Hi·ªÉn th·ªã h·ªçc sinh trong nh√≥m
        function showGroupStudentsModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            currentGroupId = groupId;
            document.getElementById('groupStudentsModalTitle').textContent = group.name;
            renderGroupStudents(groupId);
            document.getElementById('groupStudentsModal').style.display = 'flex';
            // ƒê√≥ng dropdown n·∫øu ƒëang m·ªü
            document.getElementById('groupSettingsDropdown').style.display = 'none';
            playSelectionSound();
        }
        
        function closeGroupStudentsModal() {
            document.getElementById('groupStudentsModal').style.display = 'none';
            document.getElementById('groupSettingsDropdown').style.display = 'none';
            currentGroupId = null;
            playSelectionSound();
        }

        // Toggle dropdown settings
        function toggleGroupSettingsDropdown() {
            const dropdown = document.getElementById('groupSettingsDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // ƒê√≥ng dropdown khi click ra ngo√†i
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('groupSettingsDropdown');
            const settingsBtn = document.getElementById('groupSettingsBtn');
            if (dropdown && settingsBtn && !dropdown.contains(event.target) && !settingsBtn.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // X√≥a nh√≥m hi·ªán t·∫°i
        function deleteCurrentGroup() {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m "${group.name}"?`)) {
                groups = groups.filter(g => g.id !== currentGroupId);
                saveGroups();
                renderGroupsGrid();
                updateHomeStats();
                closeGroupStudentsModal();
                alert('ƒê√£ x√≥a nh√≥m th√†nh c√¥ng!');
            }
        }

        // Trao th∆∞·ªüng cho nh√≥m
        function awardGroup() {
            if (!currentGroupId) return;
            alert('T√≠nh nƒÉng trao th∆∞·ªüng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
            playSelectionSound();
        }

        // Hi·ªÉn th·ªã modal ch·ªânh s·ª≠a nh√≥m
        function showEditGroupModal() {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            document.getElementById('editGroupName').value = group.name;
            renderEditGroupMembers();
            updateAddStudentDropdown();
            document.getElementById('editGroupModal').style.display = 'flex';
            document.getElementById('groupSettingsDropdown').style.display = 'none';
            playSelectionSound();
        }

        function closeEditGroupModal() {
            document.getElementById('editGroupModal').style.display = 'none';
            playSelectionSound();
        }

        // Render danh s√°ch th√†nh vi√™n trong modal ch·ªânh s·ª≠a
        function renderEditGroupMembers() {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            const membersContainer = document.getElementById('editGroupMembers');
            const members = students.filter(s => group.studentIds.includes(s.id)).sort(sortStudentsByLastName);
            
            if (members.length === 0) {
                membersContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Nh√≥m n√†y ch∆∞a c√≥ h·ªçc sinh n√†o</div>';
                return;
            }
            
            membersContainer.innerHTML = members.map(student => {
                const currentLevel = getCurrentLevel(student.points);
                return `
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:#f8f9fa; border-radius:8px; margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:40px; height:40px; border-radius:50%; background:${currentLevel.color}; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span style="display:none; font-size:1.5rem;">${currentLevel.icon}</span>
                            </div>
                            <div>
                                <div style="font-weight:600; color:#333;">${student.name}</div>
                                <div style="font-size:0.85rem; color:#666;">${currentLevel.name} - ${student.points} ƒëi·ªÉm</div>
                            </div>
                        </div>
                        <button onclick="removeStudentFromGroupInEdit(${student.id})" style="background:#f44336; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:0.9rem;">X√≥a</button>
                    </div>
                `;
            }).join('');
        }

        // C·∫≠p nh·∫≠t danh s√°ch checkbox th√™m h·ªçc sinh
        function updateAddStudentDropdown() {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            const container = document.getElementById('addStudentToGroupList');
            if (!container) return;
            
            // L·∫•y t·∫•t c·∫£ c√°c studentId ƒë√£ c√≥ trong c√°c nh√≥m kh√°c (kh√¥ng t√≠nh nh√≥m hi·ªán t·∫°i)
            const allGroupedStudentIds = new Set();
            groups.forEach(g => {
                if (g.id !== currentGroupId) {
                    g.studentIds.forEach(id => allGroupedStudentIds.add(id));
                }
            });
            
            // L·ªçc ra c√°c h·ªçc sinh ch∆∞a c√≥ trong nh√≥m hi·ªán t·∫°i v√† ch∆∞a c√≥ trong nh√≥m n√†o kh√°c
            const availableStudents = students.filter(s => 
                !group.studentIds.includes(s.id) && !allGroupedStudentIds.has(s.id)
            ).sort(sortStudentsByLastName);
            
            if (availableStudents.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Kh√¥ng c√≥ h·ªçc sinh n√†o ƒë·ªÉ th√™m</div>';
                return;
            }
            
            container.innerHTML = availableStudents.map(student => {
                const currentLevel = getCurrentLevel(student.points);
                return `
                    <div style="display:flex; align-items:center; gap:12px; padding:10px; background:white; border-radius:8px; margin-bottom:8px; border:1px solid #e0e0e0;">
                        <input type="checkbox" id="add-student-${student.id}" value="${student.id}" style="transform: scale(1.2); cursor:pointer;">
                        <label for="add-student-${student.id}" style="flex:1; cursor:pointer; display:flex; align-items:center; gap:10px;">
                            <div style="width:35px; height:35px; border-radius:50%; background:${currentLevel.color}; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0;">
                                <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span style="display:none; font-size:1.2rem;">${currentLevel.icon}</span>
                            </div>
                            <div>
                                <div style="font-weight:600; color:#333; font-size:0.95rem;">${student.name}</div>
                                <div style="font-size:0.8rem; color:#666;">${currentLevel.name} - ${student.points} ƒëi·ªÉm</div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // Th√™m h·ªçc sinh v√†o nh√≥m t·ª´ modal ch·ªânh s·ª≠a
        function addStudentToGroupFromEdit() {
            if (!currentGroupId) return;
            
            // L·∫•y t·∫•t c·∫£ c√°c checkbox ƒë√£ ƒë∆∞·ª£c ch·ªçn
            const selectedCheckboxes = document.querySelectorAll('#addStudentToGroupList input[type="checkbox"]:checked');
            const selectedStudentIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            
            if (selectedStudentIds.length === 0) {
                return;
            }
            
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            // Ki·ªÉm tra v√† th√™m c√°c h·ªçc sinh ƒë√£ ch·ªçn
            selectedStudentIds.forEach(studentId => {
                // Ki·ªÉm tra h·ªçc sinh ƒë√£ c√≥ trong nh√≥m hi·ªán t·∫°i ch∆∞a
                if (group.studentIds.includes(studentId)) {
                    return;
                }
                
                // Ki·ªÉm tra h·ªçc sinh ƒë√£ c√≥ trong nh√≥m kh√°c ch∆∞a
                const studentInOtherGroup = groups.find(g => g.id !== currentGroupId && g.studentIds.includes(studentId));
                if (studentInOtherGroup) {
                    return;
                }
                
                // Th√™m h·ªçc sinh v√†o nh√≥m
                group.studentIds.push(studentId);
            });
            
            saveGroups();
            renderEditGroupMembers();
            updateAddStudentDropdown();
            renderGroupsGrid();
            playSelectionSound();
        }

        // X√≥a h·ªçc sinh kh·ªèi nh√≥m t·ª´ modal ch·ªânh s·ª≠a
        function removeStudentFromGroupInEdit(studentId) {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            group.studentIds = group.studentIds.filter(id => id !== studentId);
            saveGroups();
            renderEditGroupMembers();
            updateAddStudentDropdown();
            playSelectionSound();
        }

        // L∆∞u ch·ªânh s·ª≠a nh√≥m
        function saveEditGroup() {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            
            const newName = document.getElementById('editGroupName').value.trim();
            if (!newName) {
                alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m!');
                return;
            }
            
            group.name = newName;
            saveGroups();
            renderGroupsGrid();
            renderGroupStudents(currentGroupId);
            closeEditGroupModal();
            alert('ƒê√£ l∆∞u ch·ªânh s·ª≠a nh√≥m th√†nh c√¥ng!');
            playSelectionSound();
        }
        
        function renderGroupStudents(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            const groupStudentsContent = document.getElementById('groupStudentsContent');
            if (!groupStudentsContent) return;
            
            const members = students.filter(s => group.studentIds.includes(s.id)).sort(sortStudentsByLastName);
            
            if (members.length === 0) {
                groupStudentsContent.innerHTML = '<div style="width:100%; text-align:center; padding:40px; color:#666;">Nh√≥m n√†y ch∆∞a c√≥ h·ªçc sinh n√†o</div>';
                return;
            }
            
            // Hi·ªÉn th·ªã th·∫ª h·ªçc sinh d·∫°ng card nh·ªè v·ªõi avatar v√† t√™n
            groupStudentsContent.innerHTML = members.map((student, index) => {
                const currentLevel = getCurrentLevel(student.points);
                // X√°c ƒë·ªãnh m√†u n·ªÅn v√≤ng tr√≤n ƒëi·ªÉm: xanh khi ƒëi·ªÉm >= 0, ƒë·ªè khi ƒëi·ªÉm < 0
                const badgeColor = student.points >= 0 
                    ? 'linear-gradient(135deg, #4caf50, #66bb6a)' 
                    : 'linear-gradient(135deg, #f44336, #e57373)';
                const badgeShadowColor = student.points >= 0 
                    ? 'rgba(76, 175, 80, 0.4)' 
                    : 'rgba(244, 67, 54, 0.4)';
                
                return `
                    <div style="position:relative; background:#fff; border-radius:15px; padding:19px; box-shadow:0 2px 8px rgba(0,0,0,0.1); width:150px; min-width:150px; height:220px; min-height:220px; text-align:center; display:flex; flex-direction:column; justify-content:space-between; transition:all 0.3s ease;">
                        <div style="position:relative; display:inline-block; margin-bottom:12px; flex-shrink:0;">
                            <div style="width:100px; height:100px; border-radius:50%; background:${currentLevel.color}; display:flex; align-items:center; justify-content:center; margin:0 auto; overflow:hidden; transition:transform 0.3s ease;">
                                <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width:100%; height:100%; object-fit:cover; transition:transform 0.3s ease;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span style="display:none; font-size:3.75rem; align-items:center; justify-content:center;">${currentLevel.icon}</span>
                            </div>
                            <div style="position:absolute; top:-8px; right:-8px; background:${badgeColor}; color:#fff; border-radius:50%; width:42px; height:42px; display:flex; align-items:center; justify-content:center; font-size:1.1rem; font-weight:bold; border:3px solid #fff; box-shadow:0 2px 8px ${badgeShadowColor}; transition:all 0.3s ease; animation:pulse 2s ease-in-out infinite;">${student.points}</div>
                        </div>
                        <div style="font-size:1.125rem; font-weight:600; color:#333; word-wrap:break-word; overflow-wrap:break-word; line-height:1.4; padding-top:8px; flex:1; display:flex; align-items:center; justify-content:center;">${student.name}</div>
                    </div>
                `;
            }).join('');
        }

        // T√≠nh nƒÉng b·∫•m gi·ªù
        let timerInterval = null;
        let timerSeconds = 0;
        let isCountdown = false;
        let targetTime = 0;

        function showTimerModal() {
            document.getElementById('timerModal').style.display = 'flex';
            playSelectionSound();
        }

        function closeTimerModal() {
            document.getElementById('timerModal').style.display = 'none';
            stopTimer();
            playSelectionSound();
        }

        function startCountdown() {
            const minutes = parseInt(document.getElementById('countdownMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('countdownSeconds').value) || 0;
            targetTime = minutes * 60 + seconds;
            if (targetTime <= 0) {
                alert('Vui l√≤ng nh·∫≠p th·ªùi gian l·ªõn h∆°n 0.');
                return;
            }
            timerSeconds = targetTime;
            isCountdown = true;
            startTimer();
            playSelectionSound();
        }

        function startStopwatch() {
            timerSeconds = 0;
            isCountdown = false;
            startTimer();
            playSelectionSound();
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                if (isCountdown) {
                    timerSeconds--;
                    if (timerSeconds <= 0) {
                        timerSeconds = 0;
                        clearInterval(timerInterval);
                        timerInterval = null;
                        // Ph√°t √¢m thanh chu√¥ng
                        playBellSound();
                        alert('H·∫øt gi·ªù!');
                    }
                } else {
                    timerSeconds++;
                }
                
                const hours = Math.floor(timerSeconds / 3600);
                const minutes = Math.floor((timerSeconds % 3600) / 60);
                const seconds = timerSeconds % 60;
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timerDisplay').textContent = timeString;
                document.getElementById('timerDisplayModal').textContent = timeString;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                playSelectionSound();
            }
        }

        function playBellSound() {
            // T·∫°o √¢m thanh "reng reng" - l·∫∑p l·∫°i 5 l·∫ßn
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioContext.currentTime;
            
            // M·ªói l·∫ßn "reng reng" = 2 ti·∫øng chu√¥ng nhanh (ring ring)
            const totalRings = 5; // L·∫∑p l·∫°i 5 l·∫ßn
            const ringDuration = 0.15; // Th·ªùi gian m·ªói ti·∫øng "reng"
            const pauseBetweenRings = 0.05; // Ngh·ªâ gi·ªØa 2 ti·∫øng "reng" trong c√πng m·ªôt l·∫ßn
            const pauseBetweenCycles = 0.2; // Ngh·ªâ gi·ªØa c√°c l·∫ßn "reng reng"
            
            let currentTime = now;
            
            for (let cycle = 0; cycle < totalRings; cycle++) {
                // M·ªói l·∫ßn ph√°t 2 ti·∫øng "reng reng"
                for (let ring = 0; ring < 2; ring++) {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    // T·∫ßn s·ªë chu√¥ng b√°o ƒë·ªông: 800 Hz (√¢m thanh s·∫Øc, kh·∫©n c·∫•p)
                    oscillator.type = 'square'; // S√≥ng vu√¥ng ƒë·ªÉ t·∫°o √¢m thanh s·∫Øc
                    oscillator.frequency.setValueAtTime(800, currentTime);
                    
                    // Volume: tƒÉng nhanh, gi·ªØ, gi·∫£m nhanh
                    gainNode.gain.setValueAtTime(0, currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.7, currentTime + 0.01); // TƒÉng nhanh
                    gainNode.gain.setValueAtTime(0.7, currentTime + ringDuration * 0.8); // Gi·ªØ
                    gainNode.gain.linearRampToValueAtTime(0, currentTime + ringDuration); // Gi·∫£m nhanh
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start(currentTime);
                    oscillator.stop(currentTime + ringDuration);
                    
                    // Th·ªùi gian cho ti·∫øng chu√¥ng ti·∫øp theo
                    currentTime += ringDuration + pauseBetweenRings;
                }
                
                // Ngh·ªâ gi·ªØa c√°c l·∫ßn "reng reng"
                currentTime += pauseBetweenCycles - pauseBetweenRings;
            }
        }

        // G·ªçi t√™n ng·∫´u nhi√™n
        let randomCallInterval = null;
        let isRandomCalling = false;
        let calledStudentIds = new Set(); // L∆∞u c√°c ID h·ªçc sinh ƒë√£ ƒë∆∞·ª£c g·ªçi trong phi√™n hi·ªán t·∫°i

        function showRandomCallModal() {
            document.getElementById('randomCallModal').style.display = 'flex';
            // Reset hi·ªÉn th·ªã v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
            document.getElementById('randomNameDisplay').textContent = 'B·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu';
            // ƒê·∫£m b·∫£o button ·ªü tr·∫°ng th√°i "B·∫Øt ƒë·∫ßu"
            const button = document.getElementById('randomCallButton');
            button.textContent = 'B·∫Øt ƒë·∫ßu';
            button.style.background = 'linear-gradient(45deg, #6bcf7f, #4ecdc4)';
            isRandomCalling = false;
            playSelectionSound();
            updateCalledStudentsInfo();
        }
        
        function resetCalledStudents() {
            calledStudentIds.clear();
            updateCalledStudentsInfo();
            playSelectionSound();
        }
        
        function updateCalledStudentsInfo() {
            const infoEl = document.getElementById('calledStudentsInfo');
            if (infoEl) {
                const calledCount = calledStudentIds.size;
                const totalCount = students.length;
                infoEl.textContent = `ƒê√£ g·ªçi: ${calledCount}/${totalCount} h·ªçc sinh`;
            }
        }

        function closeRandomCallModal() {
            // Ch·ªâ d·ª´ng interval n·∫øu ƒëang ch·∫°y, kh√¥ng ch·ªçn t√™n
            if (randomCallInterval) {
                clearInterval(randomCallInterval);
                randomCallInterval = null;
            }
            isRandomCalling = false;
            // Reset button v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
            const button = document.getElementById('randomCallButton');
            if (button) {
                button.textContent = 'B·∫Øt ƒë·∫ßu';
                button.style.background = 'linear-gradient(45deg, #6bcf7f, #4ecdc4)';
            }
            document.getElementById('randomCallModal').style.display = 'none';
            playSelectionSound();
        }

        function toggleRandomCall() {
            if (students.length === 0) {
                document.getElementById('randomNameDisplay').textContent = 'Ch∆∞a c√≥ h·ªçc sinh';
                return;
            }

            if (isRandomCalling) {
                stopRandomCall();
            } else {
                startRandomCall();
            }
            playSelectionSound();
        }

        function startRandomCall() {
            isRandomCalling = true;
            const button = document.getElementById('randomCallButton');
            button.textContent = 'D·ª´ng';
            button.style.background = 'linear-gradient(45deg, #ff6b6b, #ff8e8e)';

            randomCallInterval = setInterval(() => {
                // L·ªçc ra c√°c h·ªçc sinh ch∆∞a ƒë∆∞·ª£c g·ªçi m·ªói l·∫ßn quay
                let availableStudents = students.filter(s => !calledStudentIds.has(s.id));
                
                // N·∫øu t·∫•t c·∫£ h·ªçc sinh ƒë√£ ƒë∆∞·ª£c g·ªçi, reset danh s√°ch
                if (availableStudents.length === 0) {
                    calledStudentIds.clear();
                    availableStudents = [...students];
                }
                
                const randomIndex = Math.floor(Math.random() * availableStudents.length);
                const selectedStudent = availableStudents[randomIndex];
                document.getElementById('randomNameDisplay').textContent = selectedStudent.name;
            }, 100);
        }

        function stopRandomCall() {
            if (randomCallInterval) {
                clearInterval(randomCallInterval);
                randomCallInterval = null;
            }
            
            // Ch·ªâ ch·ªçn v√† hi·ªÉn th·ªã t√™n n·∫øu ƒëang trong qu√° tr√¨nh quay
            if (isRandomCalling && students.length > 0) {
                const count = parseInt(document.getElementById('randomCount').value) || 1;
                
                // L·ªçc ra c√°c h·ªçc sinh ch∆∞a ƒë∆∞·ª£c g·ªçi
                let availableStudents = students.filter(s => !calledStudentIds.has(s.id));
                
                // N·∫øu kh√¥ng ƒë·ªß h·ªçc sinh ch∆∞a ƒë∆∞·ª£c g·ªçi, reset danh s√°ch
                if (availableStudents.length < count) {
                    calledStudentIds.clear();
                    availableStudents = [...students];
                }
                
                const selectedStudents = [];
                const usedIndices = new Set();
                
                // Ch·ªçn ng·∫´u nhi√™n kh√¥ng tr√πng l·∫∑p t·ª´ danh s√°ch h·ªçc sinh ch∆∞a ƒë∆∞·ª£c g·ªçi
                while (selectedStudents.length < count && selectedStudents.length < availableStudents.length) {
                    const randomIndex = Math.floor(Math.random() * availableStudents.length);
                    if (!usedIndices.has(randomIndex)) {
                        usedIndices.add(randomIndex);
                        selectedStudents.push(availableStudents[randomIndex]);
                    }
                }
                
                // Th√™m c√°c h·ªçc sinh ƒë√£ ch·ªçn v√†o danh s√°ch lo·∫°i tr·ª´
                selectedStudents.forEach(student => {
                    calledStudentIds.add(student.id);
                });
                
                if (selectedStudents.length === 1) {
                    const student = selectedStudents[0];
                    const level = getCurrentLevel(student.points);
                    document.getElementById('randomNameDisplay').textContent = `${student.name} (${level.name})`;
                } else {
                    const names = selectedStudents.map(s => s.name).join('<br>');
                    document.getElementById('randomNameDisplay').innerHTML = names;
                }
                
                // Ph√°t √¢m thanh vui h∆°n
                playHappySelectionSound();
                
                // C·∫≠p nh·∫≠t th√¥ng tin s·ªë l∆∞·ª£ng h·ªçc sinh ƒë√£ g·ªçi
                updateCalledStudentsInfo();
            }
            
            isRandomCalling = false;
            const button = document.getElementById('randomCallButton');
            button.textContent = 'B·∫Øt ƒë·∫ßu';
            button.style.background = 'linear-gradient(45deg, #6bcf7f, #4ecdc4)';
        }

        function playSelectionSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function playHappySelectionSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // T·∫°o √¢m thanh vui v·∫ª h∆°n v·ªõi nhi·ªÅu n·ªët
            const frequencies = [523, 659, 784, 1047]; // C, E, G, C (qu√£ng t√°m)
            
            frequencies.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.1);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + index * 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.1 + 0.3);
                
                oscillator.start(audioContext.currentTime + index * 0.1);
                oscillator.stop(audioContext.currentTime + index * 0.1 + 0.3);
            });
        }

        // ƒêo √¢m thanh
        let soundMeterInterval = null;
        let soundMode = null; // 'noise' ho·∫∑c 'reading'
        let audioContext = null;
        let microphone = null;
        let analyser = null;
        let dataArray = null;
        let soundSensitivity = 1.0; // ƒê·ªô nh·∫°y m·∫∑c ƒë·ªãnh
        let alertCooldown = false; // ƒê·ªÉ tr√°nh b√°o ƒë·ªông li√™n t·ª•c

        function showSoundModal() {
            document.getElementById('soundModal').style.display = 'flex';
            playSelectionSound();
            // Kh·ªüi t·∫°o thanh ƒëi·ªÅu ch·ªânh ƒë·ªô nh·∫°y
            const sensitivitySlider = document.getElementById('sensitivitySlider');
            const sensitivityValue = document.getElementById('sensitivityValue');
            if (sensitivitySlider && sensitivityValue) {
                sensitivitySlider.value = soundSensitivity;
                updateSensitivityDisplay();
                sensitivitySlider.oninput = function() {
                    soundSensitivity = parseFloat(this.value);
                    updateSensitivityDisplay();
                };
            }
        }
        
        function updateSensitivityDisplay() {
            const sensitivityValue = document.getElementById('sensitivityValue');
            if (sensitivityValue) {
                const thresholdDb = Math.round(100 / soundSensitivity);
                sensitivityValue.textContent = soundSensitivity.toFixed(1) + 'x (‚âà' + thresholdDb + 'dB)';
            }
        }

        function closeSoundModal() {
            document.getElementById('soundModal').style.display = 'none';
            stopSoundMeter();
            playSelectionSound();
        }

        function startNoiseMeter() {
            soundMode = 'noise';
            startSoundMeter();
            playSelectionSound();
        }

        function startReadingMeter() {
            soundMode = 'reading';
            startSoundMeter();
            playSelectionSound();
        }

        function startSoundMeter() {
            if (soundMeterInterval) {
                clearInterval(soundMeterInterval);
            }
            
            // S·ª≠ d·ª•ng Web Audio API ƒë·ªÉ ƒëo √¢m thanh th·ª±c
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    microphone = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 2048;
                    const bufferLength = analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);
                    
                    microphone.connect(analyser);
                    
                    soundMeterInterval = setInterval(() => {
                        analyser.getByteTimeDomainData(dataArray);
                        
                        // T√≠nh to√°n RMS (Root Mean Square) ƒë·ªÉ c√≥ gi√° tr·ªã √¢m thanh ch√≠nh x√°c
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            const value = dataArray[i];
                            const normalized = (value - 128) / 128;
                            sum += normalized * normalized;
                        }
                        const rms = Math.sqrt(sum / bufferLength);
                        
                        // T√≠nh dB ch√≠nh x√°c h∆°n: dB = 20 * log10(rms / reference)
                        // Reference = 0.01 (√¢m thanh r·∫•t nh·ªè) ƒë·ªÉ c√≥ ph·∫°m vi dB h·ª£p l√Ω
                        // Scale ƒë·ªÉ c√≥ ph·∫°m vi 0-120dB
                        const reference = 0.01;
                        let db = 0;
                        if (rms > 0) {
                            db = 20 * Math.log10(rms / reference);
                            // Scale ƒë·ªÉ ph√π h·ª£p v·ªõi ph·∫°m vi th·ª±c t·∫ø (0-120dB)
                            db = Math.max(0, Math.min(120, db * 1.5));
                        }
                        db = Math.round(db);
                        
                        // T√≠nh m·ª©c dB y√™u c·∫ßu d·ª±a tr√™n ƒë·ªô nh·∫°y (100dB l√† chu·∫©n)
                        // ƒê·ªô nh·∫°y c√†ng cao (s·ªë l·ªõn) th√¨ m·ª©c y√™u c·∫ßu c√†ng th·∫•p
                        // V√≠ d·ª•: 1.0x = 100dB, 2.0x = 50dB, 0.5x = 200dB
                        const thresholdDb = 100 / soundSensitivity;
                        
                        document.getElementById('soundLevelDisplay').textContent = `${db} dB (Y√™u c·∫ßu: ${Math.round(thresholdDb)} dB)`;
                        
                        // C·∫≠p nh·∫≠t thanh √¢m thanh (l·∫•y 120dB l√†m max)
                        const percentage = Math.min(100, (db / 120) * 100);
                        document.getElementById('soundBar').style.width = `${percentage}%`;
                        
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† b√°o ƒë·ªông
                        let status = '';
                        let barColor = '';
                        let shouldAlert = false;
                        
                        if (soundMode === 'noise') {
                            // Ch·∫ø ƒë·ªô ƒëo ti·∫øng ·ªìn: b√°o ƒë·ªông khi v∆∞·ª£t qu√° m·ª©c y√™u c·∫ßu
                            if (db < thresholdDb * 0.7) {
                                status = 'Y√™n tƒ©nh';
                                barColor = 'linear-gradient(90deg, #6bcf7f, #4ecdc4)';
                            } else if (db < thresholdDb) {
                                status = 'B√¨nh th∆∞·ªùng';
                                barColor = 'linear-gradient(90deg, #ffd93d, #FFCA28)';
                            } else {
                                status = `·ªín √†o! (V∆∞·ª£t ${Math.round(db - thresholdDb)}dB)`;
                                barColor = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
                                shouldAlert = true;
                            }
                        } else if (soundMode === 'reading') {
                            // Ch·∫ø ƒë·ªô luy·ªán ƒë·ªçc: b√°o ƒë·ªông khi qu√° nh·ªè ho·∫∑c qu√° to
                            if (db < thresholdDb * 0.7) {
                                status = 'Qu√° nh·ªè - ƒê·ªçc to h∆°n!';
                                barColor = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
                            } else if (db <= thresholdDb * 1.3) {
                                status = 'T·ªët - Ti·∫øp t·ª•c!';
                                barColor = 'linear-gradient(90deg, #6bcf7f, #4ecdc4)';
                            } else {
                                status = 'Qu√° to - ƒê·ªçc nh·ªè h∆°n!';
                                barColor = 'linear-gradient(90deg, #ffd93d, #FFCA28)';
                                shouldAlert = true;
                            }
                        }
                        
                        document.getElementById('soundBar').style.background = barColor;
                        document.getElementById('soundStatus').textContent = status;
                        
                        // B√°o ƒë·ªông khi v∆∞·ª£t qu√° m·ª©c (tr√°nh b√°o ƒë·ªông li√™n t·ª•c)
                        if (shouldAlert && !alertCooldown) {
                            alertCooldown = true;
                            playBellSound();
                            setTimeout(() => {
                                alertCooldown = false;
                            }, 2000); // Cooldown 2 gi√¢y
                        }
                    }, 100);
                })
                .catch(err => {
                    console.error('L·ªói truy c·∫≠p microphone:', err);
                    alert('Kh√¥ng th·ªÉ truy c·∫≠p microphone. Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p microphone v√† th·ª≠ l·∫°i.');
                });
        }

        function stopSoundMeter() {
            if (soundMeterInterval) {
                clearInterval(soundMeterInterval);
                soundMeterInterval = null;
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
            }
            
            if (microphone && microphone.mediaStream) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // Ph√°t √¢m thanh khi d·ª´ng
            playSelectionSound();
            
            audioContext = null;
            microphone = null;
            analyser = null;
            dataArray = null;
            alertCooldown = false; // Reset cooldown
            
            document.getElementById('soundLevelDisplay').textContent = '0 dB';
            document.getElementById('soundBar').style.width = '0%';
            document.getElementById('soundStatus').textContent = 'Ch·ªçn ch·∫ø ƒë·ªô ƒëo';
            soundMode = null;
        }

        // B√°o c√°o
        function generateReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportContent = document.getElementById('reportContent');
            
            // Gi·ªØ nguy√™n th·ª© t·ª± h·ªçc sinh (kh√¥ng s·∫Øp x·∫øp)
            const reportStudents = [...students];
            
            const totalStudents = students.length;
            const totalPoints = totalStudents > 0 ? students.reduce((sum, s) => sum + s.points, 0) : 0;
            const sortedForTop = [...students].sort((a, b) => b.points - a.points);
            const topStudent = sortedForTop[0];
            
            let dateRangeText = '';
            if (startDate && endDate) {
                dateRangeText = `t·ª´ ${startDate} ƒë·∫øn ${endDate}`;
            } else {
                dateRangeText = 't·∫•t c·∫£ th·ªùi gian';
            }
            
            reportContent.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">B√°o c√°o ${dateRangeText}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #FFA726;">${totalStudents}</div>
                            <div style="color: #666;">T·ªïng h·ªçc sinh</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #FFA726;">${totalPoints}</div>
                            <div style="color: #666;">T·ªïng ƒëi·ªÉm c·∫£ l·ªõp</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #FFA726;">${topStudent ? topStudent.name : 'N/A'}</div>
                            <div style="color: #666;">H·ªçc sinh xu·∫•t s·∫Øc</div>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; overflow-x: auto;">
                        <h4 style="color: #4a5568; margin-bottom: 15px;">B·∫£ng ƒëi·ªÉm chi ti·∫øt</h4>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #42A5F5 0%, #FF7043 50%, #FFA726 100%); color: white;">
                                    <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid #ddd;">STT</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #ddd;">T√™n h·ªçc sinh</th>
                                    <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid #ddd;">ƒêi·ªÉm hi·ªán t·∫°i</th>
                                    <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid #ddd;">C·∫•p b·∫≠c</th>
                                    <th style="padding: 12px 8px; text-align: center; font-weight: bold; border: 1px solid #ddd;">Ti·∫øn ƒë·ªô</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportStudents.map((student, index) => {
                                const level = getCurrentLevel(student.points);
                                    const progress = Math.round(getProgressPercentage(student.points));
                                return `
                                        <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                            <td style="padding: 10px 8px; text-align: center; font-weight: bold; color: #FFA726; border: 1px solid #eee;">${index + 1}</td>
                                            <td style="padding: 10px 8px; font-weight: 600; border: 1px solid #eee;">${student.name}</td>
                                            <td style="padding: 10px 8px; text-align: center; font-weight: bold; color: ${getPointColor(student.points)}; border: 1px solid #eee;">${student.points}</td>
                                            <td style="padding: 10px 8px; text-align: center; border: 1px solid #eee;">
                                                <span style="background: ${level.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${level.name}</span>
                                            </td>
                                            <td style="padding: 10px 8px; text-align: center; border: 1px solid #eee;">
                                                <div style="position: relative; width: 100%; height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden;">
                                                    <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${progress}%; background: linear-gradient(90deg, ${level.color}, #FFA726); transition: width 0.3s;"></div>
                                                    <div style="position: absolute; width: 100%; text-align: center; line-height: 24px; font-size: 0.75rem; font-weight: bold; color: #333;">${progress}%</div>
                                            </div>
                                            </td>
                                        </tr>
                                `;
                            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Xu·∫•t Excel
        function exportToExcel() {
            // Gi·ªØ nguy√™n th·ª© t·ª± h·ªçc sinh (kh√¥ng s·∫Øp x·∫øp)
            const reportStudents = [...students];
            
            // L·∫•y kho·∫£ng th·ªùi gian t·ª´ input ho·∫∑c m·∫∑c ƒë·ªãnh 7 ng√†y g·∫ßn nh·∫•t
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            let startDate, endDate;
            if (startDateInput && endDateInput) {
                startDate = new Date(startDateInput);
                endDate = new Date(endDateInput);
            } else {
                // M·∫∑c ƒë·ªãnh: 7 ng√†y g·∫ßn nh·∫•t
                endDate = new Date();
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 6);
            }
            
            // ƒê·∫∑t gi·ªù v·ªÅ 00:00:00 ƒë·ªÉ so s√°nh ng√†y
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            
            // T·∫°o danh s√°ch c√°c ng√†y
            const dateList = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateList.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // T√≠nh ƒëi·ªÉm cho m·ªói h·ªçc sinh theo t·ª´ng ng√†y (t√°ch c·ªông v√† tr·ª´)
            const reportData = reportStudents.map((student, index) => {
                const row = {
                    stt: index + 1,
                    name: student.name,
                    dailyAdded: {},    // ƒêi·ªÉm c·ªông
                    dailySubtracted: {} // ƒêi·ªÉm tr·ª´
                };
                
                // Kh·ªüi t·∫°o ƒëi·ªÉm 0 cho m·ªói ng√†y
                dateList.forEach(date => {
                    const dateKey = date.toLocaleDateString('vi-VN');
                    row.dailyAdded[dateKey] = 0;
                    row.dailySubtracted[dateKey] = 0;
                });
                
                // T√≠nh t·ªïng ƒëi·ªÉm t·ª´ history cho m·ªói ng√†y (t√°ch c·ªông/tr·ª´)
                if (student.history && Array.isArray(student.history)) {
                    student.history.forEach(record => {
                        const recordDate = new Date(record.date);
                        recordDate.setHours(0, 0, 0, 0);
                        
                        if (recordDate >= startDate && recordDate <= endDate) {
                            const dateKey = recordDate.toLocaleDateString('vi-VN');
                            if (record.points > 0) {
                                // ƒêi·ªÉm c·ªông
                                if (row.dailyAdded[dateKey] !== undefined) {
                                    row.dailyAdded[dateKey] += record.points;
                                }
                            } else if (record.points < 0) {
                                // ƒêi·ªÉm tr·ª´ (l∆∞u gi√° tr·ªã d∆∞∆°ng)
                                if (row.dailySubtracted[dateKey] !== undefined) {
                                    row.dailySubtracted[dateKey] += Math.abs(record.points);
                                }
                            }
                        }
                    });
                }
                
                row.total = student.points;
                row.level = getCurrentLevel(student.points).name;
                
                return row;
            });
            
            // T√≠nh t·ªïng ƒëi·ªÉm m·ªói ng√†y c·ªßa c·∫£ l·ªõp (t√°ch c·ªông v√† tr·ª´)
            const dailyTotalsAdded = {};
            const dailyTotalsSubtracted = {};
            dateList.forEach(date => {
                const dateKey = date.toLocaleDateString('vi-VN');
                dailyTotalsAdded[dateKey] = reportData.reduce((sum, row) => sum + row.dailyAdded[dateKey], 0);
                dailyTotalsSubtracted[dateKey] = reportData.reduce((sum, row) => sum + row.dailySubtracted[dateKey], 0);
            });
            
            const totalPoints = students.reduce((sum, s) => sum + s.points, 0);
            
            // T·∫°o HTML table ƒë·ªÉ xu·∫•t Excel
            let htmlContent = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="utf-8">
                    <!--[if gte mso 9]><xml>
                    <x:ExcelWorkbook>
                        <x:ExcelWorksheets>
                            <x:ExcelWorksheet>
                                <x:Name>B√°o c√°o chi ti·∫øt</x:Name>
                                <x:WorksheetOptions>
                                    <x:DefaultRowHeight>285</x:DefaultRowHeight>
                                </x:WorksheetOptions>
                            </x:ExcelWorksheet>
                        </x:ExcelWorksheets>
                    </x:ExcelWorkbook>
                    </xml><![endif]-->
                </head>
                <body>
                    <h2 style="text-align: center; color: #FFA726; margin-bottom: 10px;">B√ÅO C√ÅO ƒêI·ªÇM CHI TI·∫æT L·ªöP H·ªåC</h2>
                    <p style="text-align: center; margin-bottom: 5px;">Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}</p>
                    <p style="text-align: center; margin-bottom: 20px; font-style: italic;">
                        T·ª´ ${startDate.toLocaleDateString('vi-VN')} ƒë·∫øn ${endDate.toLocaleDateString('vi-VN')}
                    </p>
                    <p style="font-weight: bold;">T·ªïng s·ªë h·ªçc sinh: ${students.length}</p>
                    <p style="font-weight: bold; margin-bottom: 20px;">T·ªïng ƒëi·ªÉm c·∫£ l·ªõp: ${totalPoints}</p>
                    
                    <table border="1" cellspacing="0" cellpadding="6" style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                        <thead>
                            <tr style="background-color: #42A5F5; color: white; font-weight: bold;">
                                <th rowspan="2" style="text-align: center; padding: 10px; min-width: 40px; vertical-align: middle;">STT</th>
                                <th rowspan="2" style="text-align: left; padding: 10px; min-width: 150px; vertical-align: middle;">T√™n h·ªçc sinh</th>
                                ${dateList.map(date => `
                                    <th colspan="2" style="text-align: center; padding: 8px; min-width: 80px; background-color: #64B5F6;">
                                        ${date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })}
                                    </th>
                                `).join('')}
                                <th rowspan="2" style="text-align: center; padding: 10px; min-width: 80px; background-color: #FFA726; vertical-align: middle;">T·ªïng ƒëi·ªÉm</th>
                                <th rowspan="2" style="text-align: center; padding: 10px; min-width: 100px; vertical-align: middle;">C·∫•p b·∫≠c</th>
                        </tr>
                            <tr style="background-color: #42A5F5; color: white; font-weight: bold;">
                                ${dateList.map(() => `
                                    <th style="text-align: center; padding: 6px; width: 50px; background-color: #4caf50;">+</th>
                                    <th style="text-align: center; padding: 6px; width: 50px; background-color: #f44336;">-</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.map(row => `
                                <tr>
                                    <td style="text-align: center; padding: 6px;">${row.stt}</td>
                                    <td style="padding: 6px; font-weight: 600;">${row.name}</td>
                                    ${dateList.map(date => {
                                        const dateKey = date.toLocaleDateString('vi-VN');
                                        const added = row.dailyAdded[dateKey];
                                        const subtracted = row.dailySubtracted[dateKey];
                                        return `
                                            <td style="text-align: center; padding: 4px; color: #4caf50; font-weight: ${added > 0 ? 'bold' : 'normal'}; background-color: ${added > 0 ? '#e8f5e9' : 'white'};">
                                                ${added > 0 ? added : ''}
                                            </td>
                                            <td style="text-align: center; padding: 4px; color: #f44336; font-weight: ${subtracted > 0 ? 'bold' : 'normal'}; background-color: ${subtracted > 0 ? '#ffebee' : 'white'};">
                                                ${subtracted > 0 ? subtracted : ''}
                                            </td>
                                        `;
                                    }).join('')}
                                    <td style="text-align: center; padding: 6px; font-weight: bold; background-color: #fff3cd;">
                                        ${row.total}
                                    </td>
                                    <td style="text-align: center; padding: 6px;">
                                        ${row.level}
                                    </td>
                            </tr>
                        `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="2" style="text-align: right; padding: 10px;">T·ªïng m·ªói ng√†y:</td>
                                ${dateList.map(date => {
                                    const dateKey = date.toLocaleDateString('vi-VN');
                                    const totalAdded = dailyTotalsAdded[dateKey];
                                    const totalSubtracted = dailyTotalsSubtracted[dateKey];
                                    return `
                                        <td style="text-align: center; padding: 8px; color: #4caf50; font-weight: bold; background-color: #e8f5e9;">
                                            ${totalAdded > 0 ? '+' + totalAdded : '0'}
                                        </td>
                                        <td style="text-align: center; padding: 8px; color: #f44336; font-weight: bold; background-color: #ffebee;">
                                            ${totalSubtracted > 0 ? '-' + totalSubtracted : '0'}
                                        </td>
                                    `;
                                }).join('')}
                                <td style="text-align: center; padding: 10px; background-color: #FFA726; color: white; font-size: 12pt;">
                                    ${totalPoints}
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                        <h3 style="color: #4a5568; margin-bottom: 10px;">Ghi ch√∫:</h3>
                        <ul style="color: #666; line-height: 1.8;">
                            <li><span style="color: #4caf50; font-weight: bold;">C·ªôt (+)</span>: T·ªïng ƒëi·ªÉm ƒë∆∞·ª£c c·ªông trong ng√†y</li>
                            <li><span style="color: #f44336; font-weight: bold;">C·ªôt (-)</span>: T·ªïng ƒëi·ªÉm b·ªã tr·ª´ trong ng√†y (hi·ªÉn th·ªã gi√° tr·ªã d∆∞∆°ng)</li>
                            <li><span style="font-weight: bold;">√î tr·ªëng</span>: Kh√¥ng c√≥ thay ƒë·ªïi ƒëi·ªÉm trong ng√†y</li>
                            <li>M·ªói ng√†y c√≥ 2 c·ªôt ri√™ng bi·ªát ƒë·ªÉ d·ªÖ theo d√µi chi ti·∫øt ƒëi·ªÉm c·ªông v√† ƒëi·ªÉm tr·ª´</li>
                        </ul>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { 
                type: 'application/vnd.ms-excel;charset=utf-8;' 
            });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bao_cao_chi_tiet_${startDate.toLocaleDateString('vi-VN').replace(/\//g, '-')}_${endDate.toLocaleDateString('vi-VN').replace(/\//g, '-')}.xls`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Hi·ªÉn th·ªã modal nh·∫≠p d·ªØ li·ªáu Excel
        function showImportExcelModal() {
            document.getElementById('importExcelModal').style.display = 'flex';
            playSelectionSound();
        }

        // ƒê√≥ng modal nh·∫≠p d·ªØ li·ªáu Excel
        function closeImportExcelModal() {
            document.getElementById('importExcelModal').style.display = 'none';
            // Reset file input
            document.getElementById('excelFileInput').value = '';
            playSelectionSound();
        }

        // T·∫£i m·∫´u file Excel
        function downloadExcelTemplate() {
            // T·∫°o d·ªØ li·ªáu m·∫´u
            const sampleData = [
                ['T√™n h·ªçc sinh', 'ƒêi·ªÉm'],
                ['Nguy·ªÖn VƒÉn A', 10],
                ['Tr·∫ßn Th·ªã B', 15],
                ['L√™ VƒÉn C', 20],
                ['Ph·∫°m Th·ªã D', 25]
            ];

            // T·∫°o workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // ƒê·∫∑t ƒë·ªô r·ªông c·ªôt
            ws['!cols'] = [
                { wch: 20 }, // C·ªôt T√™n h·ªçc sinh
                { wch: 10 }  // C·ªôt ƒêi·ªÉm
            ];

            // Th√™m sheet v√†o workbook
            XLSX.utils.book_append_sheet(wb, ws, 'M·∫´u d·ªØ li·ªáu');

            // Xu·∫•t file
            XLSX.writeFile(wb, 'Mau_nhap_diem_hoc_sinh.xlsx');
            
            playSelectionSound();
            alert('ƒê√£ t·∫£i m·∫´u file th√†nh c√¥ng!');
        }

        // Nh·∫≠p d·ªØ li·ªáu t·ª´ Excel
        function importExcelData() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Vui l√≤ng ch·ªçn file Excel!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // L·∫•y sheet ƒë·∫ßu ti√™n
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Chuy·ªÉn ƒë·ªïi sang JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        alert('File Excel kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c ch·ªâ c√≥ ti√™u ƒë·ªÅ!');
                        return;
                    }
                    
                    // T√¨m c·ªôt t√™n v√† ƒëi·ªÉm
                    const headerRow = jsonData[0];
                    let nameColIndex = -1;
                    let pointsColIndex = -1;
                    
                    // T√¨m c·ªôt t√™n (c√≥ th·ªÉ l√† "T√™n h·ªçc sinh", "T√™n", "H·ªç t√™n", "Name", etc.)
                    for (let i = 0; i < headerRow.length; i++) {
                        const header = String(headerRow[i] || '').toLowerCase().trim();
                        if (header.includes('t√™n') || header.includes('name') || header.includes('h·ªç t√™n')) {
                            nameColIndex = i;
                        }
                        if (header.includes('ƒëi·ªÉm') || header.includes('points') || header.includes('ƒëi·ªÉm s·ªë')) {
                            pointsColIndex = i;
                        }
                    }
                    
                    if (nameColIndex === -1) {
                        alert('Kh√¥ng t√¨m th·∫•y c·ªôt t√™n h·ªçc sinh! Vui l√≤ng ƒë·∫£m b·∫£o file c√≥ c·ªôt "T√™n h·ªçc sinh" ho·∫∑c "T√™n".');
                        return;
                    }
                    
                    if (pointsColIndex === -1) {
                        alert('Kh√¥ng t√¨m th·∫•y c·ªôt ƒëi·ªÉm! Vui l√≤ng ƒë·∫£m b·∫£o file c√≥ c·ªôt "ƒêi·ªÉm" ho·∫∑c "ƒêi·ªÉm s·ªë".');
                        return;
                    }
                    
                    // X·ª≠ l√Ω d·ªØ li·ªáu
                    let updatedCount = 0;
                    let createdCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    pushUndo();
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        const studentName = String(row[nameColIndex] || '').trim();
                        const pointsValue = row[pointsColIndex];
                        
                        if (!studentName) continue;
                        
                        // Chuy·ªÉn ƒë·ªïi ƒëi·ªÉm sang s·ªë
                        let points = 0;
                        if (pointsValue !== undefined && pointsValue !== null && pointsValue !== '') {
                            points = parseFloat(pointsValue);
                            if (isNaN(points)) {
                                errors.push(`D√≤ng ${i + 1}: "${studentName}" - ƒêi·ªÉm kh√¥ng h·ª£p l·ªá: ${pointsValue}`);
                                errorCount++;
                                continue;
                            }
                        }
                        
                        // T√¨m h·ªçc sinh theo t√™n (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng)
                        let student = students.find(s => 
                            s.name.toLowerCase().trim() === studentName.toLowerCase()
                        );
                        
                        if (student) {
                            // C·∫≠p nh·∫≠t ƒëi·ªÉm cho h·ªçc sinh ƒë√£ t·ªìn t·∫°i
                            const oldPoints = student.points;
                            student.points = points;
                            
                            // L∆∞u l·ªãch s·ª≠ ƒëi·ªÉm
                            if (!student.history) student.history = [];
                            const pointChange = points - oldPoints;
                            if (pointChange !== 0) {
                                student.history.push({
                                    date: new Date().toISOString(),
                                    points: pointChange,
                                    total: student.points
                                });
                                
                                // L∆∞u v√†o l·ªãch s·ª≠ t·∫≠p trung
                                addToHistory(student.id, student.name, pointChange, student.points, 'import');
                            }
                            
                            updatedCount++;
                        } else {
                            // T·∫°o h·ªçc sinh m·ªõi
                            const maxId = students.length > 0 ? Math.max(...students.map(s => s.id)) : 0;
                            const newStudent = {
                                id: maxId + 1,
                                name: studentName,
                                points: points,
                                history: [{
                                    date: new Date().toISOString(),
                                    points: points,
                                    total: points
                                }]
                            };
                            students.push(newStudent);
                            
                            // L∆∞u v√†o l·ªãch s·ª≠ t·∫≠p trung
                            addToHistory(newStudent.id, newStudent.name, points, newStudent.points, 'import');
                            
                            createdCount++;
                        }
                    }
                    
                    // L∆∞u d·ªØ li·ªáu
                    saveStudents();
                    renderStudents();
                    renderGroupGrid();
                    renderGroupsGrid();
                    updateHomeStats();
                    renderTopStudents();
                    renderTopGroups();
                    
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    let message = `‚úÖ Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!\n\n`;
                    message += `üìä ƒê√£ c·∫≠p nh·∫≠t: ${updatedCount} h·ªçc sinh\n`;
                    message += `‚ûï ƒê√£ t·∫°o m·ªõi: ${createdCount} h·ªçc sinh\n`;
                    if (errorCount > 0) {
                        message += `‚ö†Ô∏è L·ªói: ${errorCount} d√≤ng\n\n`;
                        message += `Chi ti·∫øt l·ªói:\n${errors.join('\n')}`;
                    }
                    
                    alert(message);
                    
                    // Reset file input
                    fileInput.value = '';
                    
                    // ƒê√≥ng modal sau khi import th√†nh c√¥ng
                    closeImportExcelModal();
                    
                    // Ph√°t √¢m thanh th√†nh c√¥ng
                    playGameSound('success');
                    
                } catch (error) {
                    console.error('L·ªói ƒë·ªçc file Excel:', error);
                    alert('L·ªói khi ƒë·ªçc file Excel: ' + error.message + '\n\nVui l√≤ng ki·ªÉm tra l·∫°i file v√† th·ª≠ l·∫°i.');
                }
            };
            
            reader.onerror = function() {
                alert('L·ªói khi ƒë·ªçc file! Vui l√≤ng th·ª≠ l·∫°i.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Game particles effect
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Enhanced button click effects
        function addClickEffect(element) {
            element.addEventListener('click', function(e) {
                const rect = element.getBoundingClientRect();
                const ripple = document.createElement('div');
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple 0.6s ease-out;
                    pointer-events: none;
                `;
                
                element.style.position = 'relative';
                element.style.overflow = 'hidden';
                element.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        }

        // Add ripple effect CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(2);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // H√†m ph√°t √¢m thanh ch√∫c m·ª´ng khi l√™n c·∫•p
        function playLevelUpSound(audioContext) {
            // Giai ƒëi·ªáu ch√∫c m·ª´ng: C-E-G-C (qu√£ng t√°m) - vui v·∫ª v√† ch√∫c m·ª´ng
            const notes = [
                { freq: 523, time: 0.0, duration: 0.15 },   // C
                { freq: 659, time: 0.1, duration: 0.15 },     // E
                { freq: 784, time: 0.2, duration: 0.15 },     // G
                { freq: 1047, time: 0.3, duration: 0.2 },    // C (cao)
                { freq: 1047, time: 0.5, duration: 0.1 },    // C (cao) - l·∫∑p l·∫°i
                { freq: 1319, time: 0.6, duration: 0.3 }    // E (cao) - k·∫øt th√∫c vui v·∫ª
            ];
            
            notes.forEach(note => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + note.time);
                
                // TƒÉng volume cho n·ªët ƒë·∫ßu v√† cu·ªëi ƒë·ªÉ t·∫°o c·∫£m gi√°c ch√∫c m·ª´ng
                const volume = (note.time === 0.0 || note.time >= 0.5) ? 0.15 : 0.12;
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + note.time + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + note.duration);
                
                oscillator.start(audioContext.currentTime + note.time);
                oscillator.stop(audioContext.currentTime + note.time + note.duration);
            });
        }

        // Game-like sound effects (optional)
        function playGameSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (type === 'levelup') {
                    // T·∫°o √¢m thanh ch√∫c m·ª´ng v·ªõi nhi·ªÅu n·ªët vui v·∫ª
                    playLevelUpSound(audioContext);
                    return; // Return s·ªõm v√¨ ƒë√£ x·ª≠ l√Ω ri√™ng
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'click':
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                        break;
                    case 'success':
                        oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
                        oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
                        break;
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch(e) {
                // Audio not supported
            }
        }

        // Enhanced updateStudentPoints with game effects
        const originalUpdateStudentPoints = updateStudentPoints;
        updateStudentPoints = function(studentId, change) {
            originalUpdateStudentPoints(studentId, change);
            playGameSound(change > 0 ? 'success' : 'click');
            
            // Add visual feedback
            const student = students.find(s => s.id === studentId);
            if (student) {
                const currentLevel = getCurrentLevel(student.points);
                const nextLevel = getNextLevel(student.points);
                
                // Check for level up
                if (currentLevel.name !== getCurrentLevel(student.points - change).name) {
                    playGameSound('levelup');
                    showLevelUpNotification(student.name, currentLevel.name);
                }
            }
        };

        // Level up notification - Hi·ªÉn th·ªã m·ªôt th√¥ng b√°o
        function showLevelUpNotification(studentName, newLevel) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #FFA726, #42A5F5);
                color: white;
                padding: 20px 40px;
                border-radius: 20px;
                font-size: 1.5rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: levelUpAnimation 2s ease-out forwards;
            `;
            notification.innerHTML = `üéâ ${studentName} ƒë√£ l√™n c·∫•p ${newLevel}! üéâ`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Hi·ªÉn th·ªã nhi·ªÅu th√¥ng b√°o l√™n c·∫•p c√πng l√∫c trong m·ªôt h√†ng
        function showMultipleLevelUpNotifications(levelUpStudents) {
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                gap: 15px;
                z-index: 10000;
                animation: levelUpAnimation 2s ease-out forwards;
                flex-wrap: nowrap;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                max-width: 95vw;
                max-height: 90vh;
                overflow-x: hidden;
                overflow-y: auto;
                gap: 15px;
            `;
            
            // T·∫°o c√°c th√¥ng b√°o t·∫°m ƒë·ªÉ ƒëo chi·ªÅu r·ªông
            const tempDivs = levelUpStudents.map(({ name, newLevel }) => {
                const temp = document.createElement('div');
                temp.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    font-size: 1.5rem;
                    font-weight: bold;
                    padding: 20px 40px;
                    white-space: nowrap;
                `;
                temp.textContent = `üéâ ${name} ƒë√£ l√™n c·∫•p ${newLevel}! üéâ`;
                document.body.appendChild(temp);
                return { temp, width: temp.offsetWidth };
            });
            
            // T√¨m chi·ªÅu r·ªông l·ªõn nh·∫•t
            const maxWidth = Math.max(...tempDivs.map(d => d.width));
            
            // X√≥a c√°c th·∫ª t·∫°m
            tempDivs.forEach(({ temp }) => temp.remove());
            
            // T·∫°o c√°c th√¥ng b√°o v·ªõi chi·ªÅu r·ªông b·∫±ng nhau
            const adjustedMaxWidth = Math.min(maxWidth, 400);
            const adjustedPadding = '15px 30px';
            const adjustedFontSize = '1.3rem';
            
            levelUpStudents.forEach(({ name, newLevel }) => {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: linear-gradient(135deg, #FFA726, #42A5F5);
                    color: white;
                    padding: ${adjustedPadding};
                    border-radius: 20px;
                    font-size: ${adjustedFontSize};
                    font-weight: bold;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    width: ${adjustedMaxWidth}px;
                    box-sizing: border-box;
                    flex-shrink: 0;
                    white-space: nowrap;
                `;
                notification.innerHTML = `üéâ ${name} ƒë√£ l√™n c·∫•p ${newLevel}! üéâ`;
                container.appendChild(notification);
            });
            
            document.body.appendChild(container);
            
            setTimeout(() => {
                container.remove();
            }, 2000);
        }

        // Add level up animation CSS
        const levelUpStyle = document.createElement('style');
        levelUpStyle.textContent = `
            @keyframes levelUpAnimation {
                0% {
                    transform: translate(-50%, -50%) scale(0);
                    opacity: 0;
                }
                20% {
                    transform: translate(-50%, -50%) scale(1.2);
                    opacity: 1;
                }
                80% {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                }
                100% {
                    transform: translate(-50%, -50%) scale(0.8);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(levelUpStyle);

        // H√†m thi·∫øt l·∫≠p ƒëi·ªÉm vua
        function buildThresholdEditor() {
            const editor = document.getElementById('thresholdEditor');
            if (!editor) return;
            
            editor.innerHTML = levels.map((level, index) => `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <label style="min-width: 120px; font-weight: bold;">${level.name}:</label>
                    <input type="number" id="threshold-${index}" value="${level.points}" min="0" 
                           style="width: 80px; padding: 6px; border-radius: 6px; border: 1px solid #eee; text-align: center;" />
                    <label style="min-width: 60px;">H·ªá s·ªë:</label>
                    <input type="number" id="multiplier-${index}" value="${level.multiplier}" min="1" step="0.25" 
                           style="width: 60px; padding: 6px; border-radius: 6px; border: 1px solid #eee; text-align: center;" />
                </div>
            `).join('');
        }

        function buildThresholdTable() {
            const tableBody = document.getElementById('thresholdTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = levels.map(level => `
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${level.name}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${level.points}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${level.multiplier}</td>
                </tr>
            `).join('');
        }

        function saveThresholds() {
            levels.forEach((level, index) => {
                const pointsInput = document.getElementById(`threshold-${index}`);
                const multiplierInput = document.getElementById(`multiplier-${index}`);
                
                if (pointsInput) level.points = parseInt(pointsInput.value) || 0;
                if (multiplierInput) level.multiplier = parseFloat(multiplierInput.value) || 1;
            });
            
            saveLevels();
            buildThresholdTable();
            alert('ƒê√£ l∆∞u thi·∫øt l·∫≠p ƒëi·ªÉm!');
        }

        // Bi·∫øn ƒë·ªÉ theo d√µi ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu nh√≥m
        let isSelectingGroups = false;
        let selectedGroups = new Set();

        // Bi·∫øn ƒë·ªÉ theo d√µi ch·∫ø ƒë·ªô hi·ªÉn th·ªã h·ªçc sinh
        let isCompactView = false;

        // H√†m chuy·ªÉn ƒë·ªïi giao di·ªán h·ªçc sinh
        function toggleStudentView() {
            isCompactView = !isCompactView;
            const toggleBtn = document.getElementById('viewToggleBtn');
            
            if (isCompactView) {
                toggleBtn.textContent = 'Th·∫ª nh·ªè';
                toggleBtn.style.background = 'linear-gradient(45deg, #FFA726, #FFD54F)';
            } else {
                toggleBtn.textContent = 'Th·∫ª l·ªõn';
                toggleBtn.style.background = 'linear-gradient(45deg, #42A5F5, #FF7043)';
            }
            
            renderStudents();
        }

        // H√†m render h·ªçc sinh - h·ªó tr·ª£ 2 ch·∫ø ƒë·ªô
        function renderStudents() {
            const grid = document.getElementById('studentGrid');
            if (!grid) return;
            
            // S·∫Øp x·∫øp theo alphabet
            const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name, 'vi'));
            
            if (isCompactView) {
                // Ch·∫ø ƒë·ªô compact - nhi·ªÅu h·ªçc sinh tr√™n m·ªôt d√≤ng
                grid.className = 'student-grid-compact';
                grid.innerHTML = '';
                
                sortedStudents.forEach(student => {
                    const currentLevel = getCurrentLevel(student.points);
                    const progress = getProgressPercentage(student.points);
                    
                    const card = document.createElement('div');
                    card.className = 'student-card-compact';
                    if (isSelectMultipleMode) {
                        card.classList.add('selectable');
                        card.style.cursor = 'pointer';
                        // Th√™m s·ª± ki·ªán click v√†o th·∫ª ƒë·ªÉ toggle checkbox
                        card.onclick = function(e) {
                            // Kh√¥ng toggle n·∫øu click v√†o checkbox, button, ho·∫∑c input
                            if (e.target.type === 'checkbox' || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('button') || e.target.closest('input')) {
                                return;
                            }
                            const checkbox = document.getElementById(`student-select-${student.id}`);
                            if (checkbox) {
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        };
                    }
                    
                    // X√°c ƒë·ªãnh m√†u badge d·ª±a tr√™n ƒëi·ªÉm
                    const badgeColor = student.points >= 0 ? 'linear-gradient(135deg, #4caf50, #66bb6a)' : 'linear-gradient(135deg, #f44336, #e57373)';
                    
                    card.innerHTML = `
                        <div class="student-header-compact">
                            ${isSelectMultipleMode ? `<input type="checkbox" class="student-select" id="student-select-${student.id}" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;" />` : ''}
                            <div class="student-info-compact">
                                <div style="position:relative; display:inline-block; margin-bottom:8px; overflow:visible;">
                                    <div class="student-avatar-compact" style="background: ${currentLevel.color}; width: 60px; height: 60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto; overflow:hidden; position:relative;">
                                        <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <span style="display:none; font-size:2.5rem; align-items:center; justify-content:center;">${currentLevel.icon}</span>
                                    </div>
                                    <div id="points-${student.id}" style="position:absolute; top:-6px; right:-6px; background:${badgeColor}; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:0.95rem; font-weight:bold; border:2.5px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:10; animation:characterFloat 3s ease-in-out infinite alternate;">${student.points}</div>
                                </div>
                                <div class="student-name-compact" style="text-align: center; font-size: 1.2rem;">${student.name}</div>
                                <div class="student-level-compact">
                                    ${currentLevel.name}
                                </div>
                            </div>
                        </div>
                        <div class="student-progress-compact" ${isSelectMultipleMode ? `onclick="if(event.target.closest('button') === null && event.target.closest('input') === null) { const cb = document.getElementById('student-select-${student.id}'); if(cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); } }" style="cursor: pointer;"` : ''}>
                            <div class="student-progress-fill-compact" style="width: ${progress}%; background: ${getLevelGradient(currentLevel.name)};"></div>
                        </div>
                        <div class="student-controls-compact">
                            <button class="btn-compact subtract" onclick="applyCompactAmount(${student.id}, false)">‚àí</button>
                            <input type="number" class="input-compact" id="compact-amount-${student.id}" value="1" min="1" />
                            <button class="btn-compact add" onclick="applyCompactAmount(${student.id}, true)">+</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } else {
                // Ch·∫ø ƒë·ªô th·∫ª l·ªõn - 6 h·ªçc sinh m·ªói d√≤ng
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(6, 1fr)';
                grid.style.gap = '20px';
                grid.innerHTML = '';
                
                sortedStudents.forEach(student => {
                    const currentLevel = getCurrentLevel(student.points);
                    const nextLevel = getNextLevel(student.points);
                    const progress = getProgressPercentage(student.points);
                    
                    const studentCard = document.createElement('div');
                    studentCard.className = 'student-card';
                    if (isSelectMultipleMode) {
                        studentCard.style.cursor = 'pointer';
                        // Th√™m s·ª± ki·ªán click v√†o th·∫ª ƒë·ªÉ toggle checkbox
                        studentCard.onclick = function(e) {
                            // Kh√¥ng toggle n·∫øu click v√†o checkbox, button, ho·∫∑c input
                            if (e.target.type === 'checkbox' || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('button') || e.target.closest('input')) {
                                return;
                            }
                            const checkbox = document.getElementById(`student-select-${student.id}`);
                            if (checkbox) {
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        };
                    }
                    // X√°c ƒë·ªãnh m√†u badge d·ª±a tr√™n ƒëi·ªÉm
                    const badgeColor = student.points >= 0 ? 'linear-gradient(135deg, #4caf50, #66bb6a)' : 'linear-gradient(135deg, #f44336, #e57373)';
                    
                    studentCard.innerHTML = `
                        ${isSelectMultipleMode ? `<div style="display: flex; justify-content: flex-end; margin-bottom: 6px;"><input type="checkbox" class="student-select" id="student-select-${student.id}" style="width: 16px; height: 16px; cursor: pointer;" /></div>` : ''}
                        <div class="student-name" style="margin-bottom:8px;">${student.name}</div>
                        <div class="character-level" style="position:relative; overflow:visible;">
                            <div class="character-image" style="background: ${currentLevel.color};">
                                <img src="${getLevelImage(currentLevel.name)}" alt="${currentLevel.name}" style="width: 82px; height: 82px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none;">${currentLevel.icon}</span>
                            </div>
                            <div id="points-${student.id}" style="position:absolute; top:2px; left:calc(50% + 38px); background:${badgeColor}; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:bold; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:10; animation: characterFloat 3s ease-in-out infinite alternate;">${student.points}</div>
                            <div class="level-name">${currentLevel.name}</div>
                        </div>
                        <div class="progress-bar" ${isSelectMultipleMode ? `onclick="if(event.target.closest('button') === null && event.target.closest('input') === null) { const cb = document.getElementById('student-select-${student.id}'); if(cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); } }" style="cursor: pointer;"` : ''}>
                            <div class="progress-fill" style="width: ${progress}%; background: ${getLevelGradient(currentLevel.name)}">
                                <div class="progress-text">${Math.round(progress)}%</div>
                            </div>
                        </div>
                        <div class="controls" style="gap:5px; display:flex; justify-content:center; align-items:center;">
                            <button class="btn btn-subtract" onclick="applyAmount(${student.id}, false)" style="padding:5px 10px; font-size:0.85rem; order:1;">-</button>
                            <input type="number" id="amount-${student.id}" value="1" min="1" step="1" style="width:75px; padding:6px 6px; border-radius:6px; border:1px solid #eee; text-align:center; font-size:0.95rem; order:2; cursor: text; background: white;" />
                            <button class="btn btn-add" onclick="applyAmount(${student.id}, true)" style="padding:5px 10px; font-size:0.85rem; order:3;">+</button>
                        </div>
                    `;
                    grid.appendChild(studentCard);
                });
            }
            
            updateHomeStats();
        }

        // H√†m b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu nh√≥m
        function toggleSelectGroups() {
            isSelectingGroups = !isSelectingGroups;
            selectedGroups.clear();
            
            const selectBtn = document.getElementById('selectGroupsBtn');
            const selectAllBtn = document.getElementById('selectAllGroupsBtn');
            const bulkControls = document.getElementById('groupBulkControls');
            
            if (isSelectingGroups) {
                selectBtn.textContent = 'H·ªßy ch·ªçn';
                selectBtn.style.background = 'linear-gradient(45deg, #ff4757, #ff6b6b)';
                selectAllBtn.style.display = 'inline-block';
                bulkControls.style.display = 'flex';
            } else {
                selectBtn.textContent = 'Ch·ªçn nhi·ªÅu';
                selectBtn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff8e8e)';
                selectAllBtn.style.display = 'none';
                bulkControls.style.display = 'none';
            }
            
            renderGroupsGrid();
        }

        // H√†m ch·ªçn t·∫•t c·∫£ nh√≥m
        function selectAllGroups() {
            if (!isSelectingGroups) return;
            
            selectedGroups.clear();
            groups.forEach(group => selectedGroups.add(group.id));
            renderGroupsGrid();
        }

        // H√†m th√™m/x√≥a nh√≥m kh·ªèi danh s√°ch ch·ªçn
        function toggleGroupSelection(groupId) {
            if (!isSelectingGroups) return;
            
            if (selectedGroups.has(groupId)) {
                selectedGroups.delete(groupId);
            } else {
                selectedGroups.add(groupId);
            }
            renderGroupsGrid();
        }

        // H√†m th√™m ƒëi·ªÉm cho c√°c nh√≥m ƒë√£ ch·ªçn
        function addPointsToSelectedGroups() {
            if (selectedGroups.size === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m!');
                return;
            }
            
            const points = parseInt(document.getElementById('groupBulkPoints').value) || 1;
            // L∆∞u l·∫°i danh s√°ch ID nh√≥m v√† h·ªçc sinh tr∆∞·ªõc khi c·∫≠p nh·∫≠t
            const groupIds = Array.from(selectedGroups);
            const studentIdsToHighlight = new Set();
            groupIds.forEach(groupId => {
                const group = groups.find(g => g.id === groupId);
                if (group) {
                    group.studentIds.forEach(id => studentIdsToHighlight.add(id));
                }
            });
            
            selectedGroups.forEach(groupId => {
                addPointsToGroup(points, groupId);
            });
            
            // Ph√°t √¢m thanh khi c·ªông ƒëi·ªÉm cho nhi·ªÅu nh√≥m
            playGameSound('success');
            // Highlight ƒëi·ªÉm c·ªßa t·∫•t c·∫£ h·ªçc sinh trong c√°c nh√≥m ƒë√£ ch·ªçn
            setTimeout(() => {
                studentIdsToHighlight.forEach(id => {
                    highlightPoints(`points-${id}`);
                });
            }, 100);
            // X√≥a kh·ªèi Set v√† render l·∫°i ƒë·ªÉ b·ªè t√≠ch checkbox
            selectedGroups.clear();
            renderGroupsGrid();
        }

        // H√†m tr·ª´ ƒëi·ªÉm cho c√°c nh√≥m ƒë√£ ch·ªçn
        function subtractPointsFromSelectedGroups() {
            if (selectedGroups.size === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m!');
                return;
            }
            
            const points = parseInt(document.getElementById('groupBulkPoints').value) || 1;
            // L∆∞u l·∫°i danh s√°ch ID nh√≥m v√† h·ªçc sinh tr∆∞·ªõc khi c·∫≠p nh·∫≠t
            const groupIds = Array.from(selectedGroups);
            const studentIdsToHighlight = new Set();
            groupIds.forEach(groupId => {
                const group = groups.find(g => g.id === groupId);
                if (group) {
                    group.studentIds.forEach(id => studentIdsToHighlight.add(id));
                }
            });
            
            selectedGroups.forEach(groupId => {
                addPointsToGroup(-points, groupId);
            });
            
            // Ph√°t √¢m thanh khi tr·ª´ ƒëi·ªÉm cho nhi·ªÅu nh√≥m
            playGameSound('click');
            // Highlight ƒëi·ªÉm c·ªßa t·∫•t c·∫£ h·ªçc sinh trong c√°c nh√≥m ƒë√£ ch·ªçn
            setTimeout(() => {
                studentIdsToHighlight.forEach(id => {
                    highlightPoints(`points-${id}`);
                });
            }, 100);
            // X√≥a kh·ªèi Set v√† render l·∫°i ƒë·ªÉ b·ªè t√≠ch checkbox
            selectedGroups.clear();
            renderGroupsGrid();
        }

        // H√†m x√≥a c√°c nh√≥m ƒë√£ ch·ªçn
        function deleteSelectedGroups() {
            if (selectedGroups.size === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m!');
                return;
            }
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedGroups.size} nh√≥m ƒë√£ ch·ªçn?`)) {
                selectedGroups.forEach(groupId => {
                    const groupIndex = groups.findIndex(g => g.id === groupId);
                    if (groupIndex !== -1) {
                        groups.splice(groupIndex, 1);
                    }
                });
                
                saveGroups();
                renderGroupsGrid();
                updateHomeStats();
                alert(`ƒê√£ x√≥a ${selectedGroups.size} nh√≥m!`);
                
                // T·∫Øt ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu
                toggleSelectGroups();
            }
        }

        // H√†m hi·ªÉn th·ªã tab
        function showTab(tabName) {
            // ·∫®n t·∫•t c·∫£ tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Header kh√¥ng c·∫ßn c·∫≠p nh·∫≠t v√¨ s·ª≠ d·ª•ng h√¨nh ·∫£nh c·ªë ƒë·ªãnh
            
            // C·∫≠p nh·∫≠t nav icon
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            // T√¨m element .nav-icon g·∫ßn nh·∫•t t·ª´ event.target
            const clickedIcon = event.target.closest('.nav-icon');
            if (clickedIcon) {
                clickedIcon.classList.add('active');
            }
            
            // ·∫®n/hi·ªán c·ªôt b√™n ph·∫£i (Top 5 h·ªçc sinh v√† Top 3 nh√≥m)
            const mainContent = document.querySelector('.main-content');
            const rightSection = document.getElementById('rightSection');
            
            if (tabName === 'home') {
                // Ch·ªâ hi·ªÉn th·ªã c·ªôt ph·∫£i ·ªü trang ch·ªß
                mainContent.classList.remove('hide-right');
                if (rightSection) {
                    rightSection.style.display = 'block';
                }
                // Hi·ªÉn th·ªã top 5 h·ªçc sinh v√† top 3 nh√≥m
                document.querySelector('.members-card h3').textContent = 'Top 5 h·ªçc sinh';
                renderTopStudents();
                renderTopGroups();
                // Hi·ªÉn th·ªã l·∫°i top 3 nh√≥m
                document.querySelector('.my-devices-card').style.display = 'block';
            } else {
                // ·∫®n c·ªôt ph·∫£i ·ªü t·∫•t c·∫£ c√°c tab kh√°c
                mainContent.classList.add('hide-right');
                if (rightSection) {
                    rightSection.style.display = 'none';
                }
            }
            
            // Kh·ªüi t·∫°o l·∫°i b·∫£ng ƒëi·ªÉm khi v√†o tab c√†i ƒë·∫∑t
            if (tabName === 'settings') {
                setTimeout(() => {
                    loadPointItems();
                    updateDeleteStudentSelect();
                }, 100);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            students = loadStudentsForWeek();
            renderStudents();
            renderGroupSelects();
            renderGroupGrid();
            buildThresholdEditor();
            buildThresholdTable();
            updateDeleteStudentSelect();
            updateHomeStats();
            renderMembersList();
            renderGroupsGrid();
            // setupSearch(); // H√†m n√†y kh√¥ng t·ªìn t·∫°i, ƒë√£ comment
            renderTopStudents();
            renderTopGroups();
            
            // Initialize game effects
            createParticles();
            
            // Add click effects to all buttons
            document.querySelectorAll('.btn, .btn-compact, .btn-game, .nav-icon').forEach(btn => {
                addClickEffect(btn);
            });
            
            // C√°c n√∫t b·∫£ng ƒëi·ªÉm ƒë√£ s·ª≠ d·ª•ng onclick tr·ª±c ti·∫øp
        });
        
        // ========== H√ÄM L·ªäCH S·ª¨ C·ªòNG ƒêI·ªÇM ==========
        let selectedHistoryItems = new Set();
        
        function showHistoryModal() {
            document.getElementById('historyModal').style.display = 'flex';
            selectedHistoryItems.clear();
            renderHistory();
            playSelectionSound();
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
            selectedHistoryItems.clear();
            playSelectionSound();
        }
        
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            // L·ªçc l·ªãch s·ª≠ 3 ng√†y g·∫ßn nh·∫•t
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            threeDaysAgo.setHours(0, 0, 0, 0);
            
            const recentHistory = pointHistory
                .filter(item => new Date(item.date) >= threeDaysAgo)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // S·∫Øp x·∫øp m·ªõi nh·∫•t tr∆∞·ªõc
            
            if (recentHistory.length === 0) {
                historyList.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Kh√¥ng c√≥ l·ªãch s·ª≠ trong 3 ng√†y g·∫ßn nh·∫•t</div>';
                updateDeleteButtonVisibility();
                return;
            }
            
            // Nh√≥m theo ng√†y
            const historyByDate = {};
            recentHistory.forEach(item => {
                const date = new Date(item.date);
                const dateKey = date.toLocaleDateString('vi-VN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                if (!historyByDate[dateKey]) {
                    historyByDate[dateKey] = [];
                }
                historyByDate[dateKey].push(item);
            });
            
            let html = '';
            Object.keys(historyByDate).forEach(dateKey => {
                html += `<div style="margin-bottom:30px;">
                    <h4 style="font-size:1.2rem; font-weight:700; color:#333; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #eee;">${dateKey}</h4>`;
                
                historyByDate[dateKey].forEach(item => {
                    const time = new Date(item.date).toLocaleTimeString('vi-VN', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    const pointsColor = item.points >= 0 ? '#28a745' : '#dc3545';
                    const pointsSign = item.points >= 0 ? '+' : '';
                    
                    html += `
                        <div style="display:flex; align-items:center; gap:15px; padding:15px; background:#f8f9fa; border-radius:12px; margin-bottom:10px; transition:all 0.3s; cursor:pointer;" 
                             onmouseover="this.style.background='#e9ecef'" 
                             onmouseout="this.style.background='#f8f9fa'"
                             onclick="if(event.target.type !== 'checkbox' && event.target.tagName !== 'BUTTON' && !event.target.closest('button')) { const cb = document.getElementById('history-check-${item.id}'); if(cb) { cb.checked = !cb.checked; toggleHistorySelection(${item.id}); } }">
                            <input type="checkbox" 
                                   id="history-check-${item.id}" 
                                   onchange="toggleHistorySelection(${item.id})" 
                                   onclick="event.stopPropagation();"
                                   style="width:20px; height:20px; cursor:pointer; transform:scale(1.2);" />
                            <div style="flex:1; display:flex; align-items:center; gap:15px;">
                                <div style="min-width:80px; font-weight:600; color:#666;">${time}</div>
                                <div style="flex:1; font-weight:600; color:#333;">${item.studentName}</div>
                                <div style="min-width:100px; text-align:right; font-weight:700; color:${pointsColor};">
                                    ${pointsSign}${item.points} ƒëi·ªÉm
                                </div>
                                <div style="min-width:80px; text-align:right; color:#666;">
                                    T·ªïng: ${item.totalPoints}
                                </div>
                                <div style="min-width:100px; text-align:center;">
                                    <span style="padding:4px 12px; background:#e9ecef; border-radius:8px; font-size:0.85rem; color:#666;">
                                        ${item.type === 'individual' ? 'C√° nh√¢n' : item.type === 'group' ? 'Nh√≥m' : 'H√†ng lo·∫°t'}
                                    </span>
                                </div>
                            </div>
                            <button onclick="deleteHistoryItem(${item.id}); event.stopPropagation();" 
                                    style="background:#ff6b6b; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:1.2rem; min-width:40px;"
                                    onmouseover="this.style.background='#ff4757'" 
                                    onmouseout="this.style.background='#ff6b6b'">√ó</button>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            historyList.innerHTML = html;
            updateDeleteButtonVisibility();
        }
        
        function toggleHistorySelection(itemId) {
            if (selectedHistoryItems.has(itemId)) {
                selectedHistoryItems.delete(itemId);
            } else {
                selectedHistoryItems.add(itemId);
            }
            updateDeleteButtonVisibility();
        }
        
        function updateDeleteButtonVisibility() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                if (selectedHistoryItems.size > 0) {
                    deleteBtn.style.display = 'block';
                    deleteBtn.textContent = `X√≥a ƒë√£ ch·ªçn (${selectedHistoryItems.size})`;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
        }
        
        function deleteHistoryItem(itemId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c l·ªãch s·ª≠ n√†y?')) return;
            
            const item = pointHistory.find(h => h.id === itemId);
            if (!item) return;
            
            // Ho√†n t√°c ƒëi·ªÉm: tr·ª´ ƒëi·ªÉm ƒë√£ c·ªông
            const student = students.find(s => s.id === item.studentId);
            if (student) {
                student.points = student.points - item.points;
                saveStudents();
                renderStudents();
                renderGroupGrid();
                updateHomeStats();
            }
            
            // X√≥a kh·ªèi l·ªãch s·ª≠
            pointHistory = pointHistory.filter(h => h.id !== itemId);
            savePointHistory();
            
            // Render l·∫°i
            renderHistory();
            playSelectionSound();
        }
        
        function deleteSelectedHistoryItems() {
            if (selectedHistoryItems.size === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m·ª•c!');
                return;
            }
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedHistoryItems.size} m·ª•c l·ªãch s·ª≠ ƒë√£ ch·ªçn?`)) return;
            
            // Ho√†n t√°c ƒëi·ªÉm cho t·∫•t c·∫£ c√°c m·ª•c ƒë√£ ch·ªçn
            selectedHistoryItems.forEach(itemId => {
                const item = pointHistory.find(h => h.id === itemId);
                if (item) {
                    const student = students.find(s => s.id === item.studentId);
                    if (student) {
                        student.points = student.points - item.points;
                    }
                }
            });
            
            // X√≥a kh·ªèi l·ªãch s·ª≠
            pointHistory = pointHistory.filter(h => !selectedHistoryItems.has(h.id));
            savePointHistory();
            
            // L∆∞u v√† render l·∫°i
            saveStudents();
            renderStudents();
            renderGroupGrid();
            updateHomeStats();
            
            selectedHistoryItems.clear();
            renderHistory();
            playSelectionSound();
        }
        
        // C√°c n√∫t b·∫£ng ƒëi·ªÉm ƒë√£ s·ª≠ d·ª•ng onclick tr·ª±c ti·∫øp, kh√¥ng c·∫ßn event delegation
    </script>
</body>
</html>

